<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Mandar Chitre">
<title>Underwater Networks Handbook</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Underwater Networks Handbook</h1>
<div class="details">
<span id="author" class="author">Mandar Chitre</span><br>
<span id="revnumber">version 0.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a></li>
<li><a href="#_part_i_introduction_to_unetstack"><strong>Part I: Introduction to UnetStack</strong></a>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_getting_started">2. Getting started</a></li>
<li><a href="#_unetstack_basics">3. UnetStack basics</a></li>
</ul>
</li>
<li><a href="#_part_ii_setting_up_underwater_networks"><strong>Part II: Setting up underwater networks</strong></a>
<ul class="sectlevel1">
<li><a href="#_unet_basics">4. Unet basics</a></li>
<li><a href="#_setting_up_small_networks">5. Setting up small networks</a></li>
<li><a href="#_routing_in_larger_networks">6. Routing in larger networks</a></li>
<li><a href="#_wired_and_over_the_air_links">7. Wired and over-the-air links</a></li>
</ul>
</li>
<li><a href="#_part_iii_building_unet_applications"><strong>Part III: Building Unet applications</strong></a>
<ul class="sectlevel1">
<li><a href="#_interfacing_with_unetstack">8. Interfacing with UnetStack</a></li>
<li><a href="#_unetsocket_api">9. UnetSocket API</a></li>
<li><a href="#_portals">10. Portals</a></li>
<li><a href="#_at_script_engine">11. AT script engine</a></li>
</ul>
</li>
<li><a href="#_part_iv_understanding_unetstack_services"><strong>Part IV: Understanding UnetStack services</strong></a>
<ul class="sectlevel1">
<li><a href="#_services_and_capabilities">12. Services and capabilities</a></li>
<li><a href="#_datagram_service">13. Datagram service</a></li>
<li><a href="#_physical_service">14. Physical service</a></li>
<li><a href="#_baseband_service">15. Baseband service</a></li>
<li><a href="#_ranging_and_synchronization">16. Ranging and synchronization</a></li>
<li><a href="#_node_information">17. Node information</a></li>
<li><a href="#_address_resolution">18. Address resolution</a></li>
<li><a href="#_medium_access_control">19. Medium access control</a></li>
<li><a href="#_single_hop_links">20. Single-hop links</a></li>
<li><a href="#_routing_and_route_maintenance">21. Routing and route maintenance</a></li>
<li><a href="#_transport_and_reliability">22. Transport and reliability</a></li>
<li><a href="#_remote_access">23. Remote access</a></li>
<li><a href="#_state_persistence">24. State persistence</a></li>
<li><a href="#_scheduler">25. Scheduler</a></li>
<li><a href="#_shell">26. Shell</a></li>
</ul>
</li>
<li><a href="#_part_v_extending_unetstack"><strong>Part V: Extending UnetStack</strong></a>
<ul class="sectlevel1">
<li><a href="#_developing_your_own_agents">27. Developing your own agents</a></li>
<li><a href="#_implementing_network_protocols">28. Implementing network protocols</a></li>
<li><a href="#_integrating_with_sensors">29. Integrating with sensors</a></li>
<li><a href="#_unetstack_shell_extensions">30. UnetStack shell extensions</a></li>
</ul>
</li>
<li><a href="#_part_vi_simulating_underwater_networks"><strong>Part VI: Simulating underwater networks</strong></a>
<ul class="sectlevel1">
<li><a href="#_integrated_development_environment_ide">31. Integrated development environment (IDE)</a></li>
<li><a href="#_writing_simulation_scripts">32. Writing simulation scripts</a></li>
<li><a href="#_modems_and_channel_models">33. Modems and channel models</a></li>
<li><a href="#_developing_your_own_channel_models">34. Developing your own channel models</a></li>
<li><a href="#_node_mobility">35. Node mobility</a></li>
</ul>
</li>
<li><a href="#_appendices"><strong>Appendices</strong></a>
<ul class="sectlevel1">
<li><a href="#_mysimplehandshakemac">Appendix A: MySimpleHandshakeMac</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can download a <a href="https://org-arl.github.io/unet-doc/handbook/unet-handbook.pdf">PDF version</a> of this handbook for offline reading, if you prefer.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_this_book_about">What is this book about?</h3>
<div class="paragraph">
<p>About 71% of Earth&#8217;s surface is covered with water, and about 97% of the water is in our oceans. Although the ocean plays a critical role in everything from the air we breathe to daily weather and climate patterns, we know very little about it. To really understand our oceans, we need a way to sense and observe the numerous complex processes that drive the ocean environment, and to report the data collected back to our data centers. While cabled ocean observatories have been established in a few locations, they are too expensive to setup and maintain for large scale data collection across the vast oceans.</p>
</div>
<div class="paragraph">
<p>Over the past few decades, wireless communication technology has percolated into every aspect of our lives, and we have come to take it for granted. This technology forms the bedrock of wireless sensor networks, allowing us to gather data with ease. Most of the wireless communication technology we use relies on electromagnetic waves (e.g. radio waves, visible light) that get rapidly absorbed by water. Hence the technology is ineffective for underwater communication, except at very short distances or extremely low data rates. Most underwater communication systems today use acoustic waves, which can travel long distances in the right conditions. At short distances in clear waters, optical communication systems are sometimes used for high speed communications. Although these communication technologies can be leveraged to establish point-to-point communication links, these links do not integrate well with networking technology available today.</p>
</div>
<div class="paragraph">
<p>The <strong>Unet project</strong> strives to develop technologies that allow us to build communication networks that extend underwater, be it via acoustic, optical, or even wired links. Some nodes in such networks may be above water, while others are underwater. In this handbook, we explore how to build such networks using <strong>UnetStack3</strong>, an agent-based network technology that was developed in the Unet project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_who_should_read_this_book">Who should read this book?</h3>
<div class="paragraph">
<p>This book is intended for readers interested in deploying networks that extend underwater, or developing technology or protocols for use in underwater networks. Part I of the book provides an overview, and is recommended for all readers. Part II is aimed at readers who wish to deploy and maintain networks that extend underwater. Part III is aimed at application developers and software engineers who wish to integrate with UnetStack-based networks. Parts IV and V dive deeper into UnetStack, and are intended for researchers and engineers who wish to develop, simulate and test novel underwater networking protocols.</p>
</div>
<div class="paragraph">
<p>The book assumes that readers have a basic understanding of traditional networking technology. While expert software development skills are not required to benefit from this book, familiarity with scripting or programming is essential. Readers with knowledge of Java, Groovy and/or Python will find it easy to follow the examples in the text, but even readers without prior knowledge of these languages should be able to pick up necessary skills along the way.</p>
</div>
</div>
</div>
</div>
<h1 id="_part_i_introduction_to_unetstack" class="sect0"><strong>Part I: Introduction to UnetStack</strong></h1>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_a_unet">1.1. What is a Unet?</h3>
<div class="paragraph">
<p>The Internet has changed our lives beyond anyone&#8217;s wildest expectations, fundamentally changing the way we interact, the way we learn, and the way we work. More recently, devices have started connecting to the Internet, and communicating with other devices. This <em>Internet of Things</em> (IoT) has the potential to have a huge impact on the way we understand our environment, and interact with it. Given that most of our planet&#8217;s surface is covered with water, would it then not make sense that at least some of these devices might be in water? Some devices might measure ocean temperature and acidification to give us a handle on climate change, while other devices might monitor fresh water quality to ensure safe drinking water for us. Autonomous underwater vehicles (AUVs) may patrol our coastal waters looking for intruders, or tracking down sources of pollution or nutients that encourage harmful algal blooms. Be it static sensors or mobile AUVs, we need a way to connect them into a network that we can communicate and interact with. The <em>Unet project</em> strives to develop technologies that allow us to do precisely this. In this handbook, we explore how to use <a href="https://www.unetstack.net">UnetStack3</a>, a technology developed as part of the Unet project, to build communication networks that extend underwater.</p>
</div>
<div class="paragraph">
<p>Most wireless technologies today rely on electromagnetic waves that don&#8217;t propagate well underwater. Therefore, to extend IoT underwater, we typically need a mix of technologies&#8201;&#8212;&#8201;cabled links where possible, otherwise radio frequency (RF) wireless links above water, and mid-to-long range wireless acoustic or short-range wireless optical links underwater. A "Unet" network (which we will simply call <em>Unet</em> henceforth) consists of several nodes (underwater, on the surface of water, or above water) that communicate over various types of links, as shown in <a href="#fig_network">Figure 1</a>.</p>
</div>
<div id="fig_network" class="imageblock">
<div class="content">
<img src="images/network.png" alt="network">
</div>
<div class="title">Figure 1. A typical Unet consists of static and mobile nodes, both underwater and in air, with bidirectional acoustic, optical, electromagnetic and cabled links connecting pairs of nodes.</div>
</div>
<div class="paragraph">
<p>A Unet consists of many <em>Unet nodes</em> (e.g. underwater sensor nodes, Autonomous Underwater Vehicles (AUVs), gateway buoys, ground stations, boats/ships) that generate, consume or relay data over a variety of links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Acoustic links</strong> are typically used for mid-to-long range communication underwater. These links usually offer low data rates and long propagation delay due to the slow speed of sound in water (as compared to EM waves).</p>
</li>
<li>
<p><strong>Optical links</strong> are used for short range high data rate communications in water.</p>
</li>
<li>
<p><strong>RF links</strong> are used for mid range communication in air.</p>
</li>
<li>
<p><strong>GSM links</strong> are used for near-shore connectivity through air.</p>
</li>
<li>
<p><strong>Satellite links</strong> are used for nodes that are far out at sea, and cannot be reached through GSM or RF links. These links usually are expensive and offer relatively low data rates.</p>
</li>
<li>
<p><strong>Wired links</strong> (Ethernet, serial, fiber optic) are used for long-term static deployments underwater, or over short distances where cabling is feasible.</p>
</li>
<li>
<p>In some cases, nodes are retreived and data is transferred from them to other nodes in the network on a regular basis, using physical media (e.g. USB drives, SD cards, etc). These links usually offer very high data rates, but are only available intermittently. We dub such links as <strong>Sneakernet links</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A link is simply a logical connection between two nodes, often provided by equipping both the nodes with modems. We summarize various types of links in <a href="#table_links">Table 1</a>.</p>
</div>
<table id="table_links" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Various types of links in a typical Unet, and their characteristics.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Link type</th>
<th class="tableblock halign-center valign-top">Communication range<sup>#</sup></th>
<th class="tableblock halign-center valign-top">Data rate<sup>#</sup></th>
<th class="tableblock halign-center valign-top">Latency</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">High-frequency acoustic (underwater)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Short</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">milliseconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mid-frequency acoustic (underwater)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low-frequency acoustic (underwater)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Very low</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optical (underwater)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Very short</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Negligible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RF (in air)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Negligible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GSM (in air, near shore)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Medium</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">milliseconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Satellite (in air)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">milliseconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wired/cabled</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long (expensive)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">High</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Negligible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sneakernet</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long (intermittent)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Very high</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">hours or days</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock"><sup>#</sup>Communication range and data rate vary substantially across devices and environments. Short range usually is in tens of meters, medium range is several km, and long range is typically tens of km. Low data rates are in hundreds of bps, medium data rates are in kbps, and high data rates are in Mbps.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_unetstack">1.2. UnetStack</h3>
<div class="paragraph">
<p>Unet nodes are equipped with one or more network interfaces that allow communication over some of these links. For example, to communicate over an underwater acoustic link, we need an <em>underwater acoustic modem</em>. For an underwater optical link, we use an <em>underwater optical modem</em>. Most RF, GSM, satellite or wired links would be accessed over a standard TCP/IP network interface. In all cases, each Unet node would run the <em>UnetStack</em> software that allows us to effectively communicate over all of these types of links using a common Application Programming Interface (API). UnetStack API bindings are available for several languages including Java, Groovy, Python, Julia, C, Javascript, etc.</p>
</div>
<div class="paragraph">
<p>UnetStack has a several components, as depicted in <a href="#fig_unetstack">Figure 2</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>Unet framework</strong> provides core services, messages, agents and APIs needed by UnetStack.</p>
</li>
<li>
<p>The <strong>Unet basic stack</strong> is a collection of agents providing services and functionality required by typical Unets. These agents, together with the Unet framework, are sufficient to build fully functional Unets.</p>
</li>
<li>
<p>The <strong>Unet premium stack</strong> is a collection of agents providing advanced functionality and/or higher performance. Many of the premium agents provide similar services as the basic ones, but used advanced techniques for better performance and bandwidth efficiency.</p>
</li>
<li>
<p>The <strong>Unet simulator</strong> is able to simulate Unets with many nodes on a single computer. It can run in <em>realtime simulation mode</em> for interactive testing of agents and protocols, working to provide the user with the same user experience as in a real Unet. It can also be run in <em>discrete event simulation mode</em> to perform a large number of simulations in a short time, allowing Monte Carlo testing and performance evaluation of network protocols.</p>
</li>
<li>
<p>The <strong>Unet IDE</strong> is an integrated development environment (IDE) for developers to develop, simulate and test Unet agents and protocols. It also enables the developer to visualize and interact with simulated networks.</p>
</li>
<li>
<p><strong>Unet audio</strong> is a sound card based realtime software defined open architecture acoustic modem (SDOAM) that runs on desktop, laptop or single-board computers, and can be used to build and test simple Unets. It is a great tool for not only developing and testing network protocols, but also developing acoustic communication techniques.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The components are packaged into various <a href="https://www.unetstack.net/editions.html">editions</a>. The <strong>community edition</strong> is <a href="https://www.unetstack.net/downloads.html">downloadable</a> free of charge for educational and research purposes. It has all the components required to develop, simulate, test and deploy Unets. The commercial and OEM editions package offer advanced functionality, better performance and tighter integration with vendor-specific hardware.</p>
</div>
<div id="fig_unetstack" class="imageblock">
<div class="content">
<img src="images/UnetStack3.png" alt="UnetStack3">
</div>
<div class="title">Figure 2. An overview of UnetStack components.</div>
</div>
<div class="paragraph">
<p>In the next few chapters, we will learn how to use UnetStack and how to customize it to meet our networking needs. In some cases, it may be necessary to prototype and simulate a Unet before it is actually implemented. We will also learn how to do that using the Unet simulator.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, you will learn how to set up a simple 2-node underwater network with an acoustic link. If you already own a couple of UnetStack-compatible acoustic modems, you can certainly use them! And we&#8217;ll show you how to do that in <a href="#_using_acoustic_modems">Section 2.6</a>. But let us first start with a simulated 2-node underwater network, since all you need for this is a computer and the Unet simulator.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_a_simple_simulated_network">2.1. Setting up a simple simulated network</h3>
<div class="paragraph">
<p><a href="https://www.unetstack.net/downloads.html">Download</a> UnetStack community edition for your OS and untar/unzip it. Open a terminal window in the simulator&#8217;s root folder and start the simulator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet samples/2-node-network.groovy

2-node network
<span class="nt">--------------</span>

Node A: tcp://localhost:1101, http://localhost:8081/
Node B: tcp://localhost:1102, http://localhost:8082/</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re using Windows, you may need to use:<br>
<code>bin\unet samples\handbook\2-node-network.groovy</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open two web browser windows and key in the two http URLs shown above in each browser. This should give you a command shell for node A and node B in the two browser windows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_making_your_first_transmission">2.2. Making your first transmission</h3>
<div class="paragraph">
<p>On the command shell for node A, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tell 0, <span class="s1">'hello!'</span>
<span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Address 0 is a broadcast address, so you did not need to explicitly know the address of node B to transmit a message to it. After a short delay, you should see the message on the command shell for node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">[232]: hello!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Congratulations!!! You have successfully transmitted your first message over the Unet.</strong></p>
</div>
<div class="paragraph">
<p>The <code>[232]</code> that you see on node B is the <em>from</em> address (of node A). The simulator automatically allocates addresses to each node. You can easily find out the addresses of both nodes (on either node):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> host<span class="o">(</span><span class="s1">'A'</span><span class="o">)</span>
<span class="go">232
</span><span class="gp">&gt;</span> host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">31</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can try sending a message back from node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tell 232, <span class="s1">'hi!'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and you should see the message <code>[31]: hi!</code> on node A after just a short delay.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You could have specified the hostname instead of the address when sending the message:<br>
<code>tell host('A'), 'hi!'</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_propagation_delay_ranging">2.3. Propagation delay &amp; ranging</h3>
<div class="paragraph">
<p>In the simulation, nodes A and B are placed 1 km apart. Since the speed of sound in water is about 1500 m/s (exact sound speed depends on temperature, salinity and depth), the signals take about 0.7 s to travel between the simulated nodes. This explains the short delays you see between sending the message from one node and receiving it on the other. You can also make use of this time delay to measure the distance between the nodes!</p>
</div>
<div class="paragraph">
<p>On node A, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">999.7</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You got an estimate of 999.7 m for the range between the two nodes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending_receiving_application_data">2.4. Sending &amp; receiving application data</h3>
<div class="paragraph">
<p>In real applications, you may want to send complex <em>datagrams</em> (messages) programmatically between nodes. The simplest way to do this is via the <em>UnetSocket</em> API (<a href="#_unetsocket_api">Chapter 9</a>). Let&#8217;s try it!</p>
</div>
<div class="paragraph">
<p>On node B, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span>              <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">&gt;</span> rx <span class="o">=</span> s.receive<span class="o">()</span>                       <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Open a socket on node B (<code>this</code> refers to node B, since you are typing this on node B&#8217;s command shell). The semicolon (";") at the end of the statement simply prevents the shell from printing the return value automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Receive a datagram. This call blocks until a datagram is available.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On node A, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> s.send<span class="o">(</span><span class="s1">'hello!'</span> as byte[], 0<span class="o">)</span>          <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">true
</span><span class="gp">&gt;</span> s.close<span class="o">()</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send 6 ASCII bytes ('hello!') to address 0 (broadcast address). The <code>as byte[]</code> is necessary in Groovy to convert the string you specified into a byte array that the <code>send()</code> method expects.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Node B will receive the bytes as a <code>RxFrameNtf</code> message. You can check the data in the received datagram on the command shell for node B, and close the socket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">RxFrameNtf:INFORM[type:DATA from:232 rxTime:4134355059 (6 bytes)]
</span><span class="gp">&gt;</span> rx.data
<span class="go">[104, 101, 108, 108, 111, 33]            <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="gp">&gt;</span> new String<span class="o">(</span>rx.data<span class="o">)</span>                    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">hello!
</span><span class="gp">&gt;</span> s.close<span class="o">()</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These are the bytes representing the ASCII characters ['h', 'e', 'l', 'l', 'o', '!'].</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This puts together the ASCII characters in the byte array into a String.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While we demonstrated the use of the <code>UnetSocket</code> API in Groovy on the command shell, the same commands work in a Groovy script or application, with one minor modification. When the socket is opened, you will have to specify the connection details (such as host name or IP address, and the API port number) of the modem (or simulated modem) to connect to. For example, if UnetStack is running on <code>localhost</code> at port number 1101, you can connect to it using: <code>s = new UnetSocket('localhost', 1101);</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_sending_receiving_from_a_python_application">2.5. Sending &amp; receiving from a Python application</h3>
<div class="paragraph">
<p>UnetStack provides API bindings for many languages (Java, Groovy, Python, Julia, C, Javascript, etc). We demonstrate the use of the Python API here, but the usage is quite similar in other languages too.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll assume you have Python 3.x already installed. Let us start by installing the UnetStack Python API bindings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span> pip <span class="nb">install </span>unetpy
<span class="go">Collecting unetpy
  Using cached https://files.pythonhosted.org/packages/eb/f1/0efa3cff9c25322169041d3d804691ad24ccd732d6e284e209d20a89336f/unetpy-3.0.2-py3-none-any.whl
</span><span class="gp">Collecting fjagepy&gt;</span><span class="o">=</span>1.6 <span class="o">(</span>from unetpy<span class="o">)</span>
<span class="go">  Using cached https://files.pythonhosted.org/packages/3d/38/159338ad451218652aec30ebd9513d6e26ea4679903c47df10def1457652/fjagepy-1.6-py3-none-any.whl
</span><span class="gp">Requirement already satisfied: numpy&gt;</span><span class="o">=</span>1.11 <span class="k">in</span> /Users/anjangi/Documents/python-env/publish-env/lib/python3.7/site-packages <span class="o">(</span>from unetpy<span class="o">)</span> <span class="o">(</span>1.17.2<span class="o">)</span>
<span class="go">Installing collected packages: fjagepy, unetpy
Successfully installed fjagepy-1.6 unetpy-3.0.2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now write <code>tx.py</code> and <code>rx.py</code> scripts to transmit and receive a datagram respectively. We assume that you have the two-node network setup from the previous section with node A and B available on <code>localhost</code> API port 1101 and 1102 respectively.</p>
</div>
<div class="listingblock">
<div class="title"><code>tx.py</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">unetpy</span> <span class="kn">import</span> <span class="n">UnetSocket</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">UnetSocket</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">1101</span><span class="p">)</span>                <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">'hello!'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>                              <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Connect to node A (<code>localhost</code> API port 1101).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Broadcast a 6-byte datagram. Address 0 is the broadcast address.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>rx.py</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">unetpy</span> <span class="kn">import</span> <span class="n">UnetSocket</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">UnetSocket</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">1102</span><span class="p">)</span>                <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">rx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>                                 <i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">print</span><span class="p">(</span><span class="s">'from node'</span><span class="p">,</span> <span class="n">rx</span><span class="o">.</span><span class="n">from_</span><span class="p">,</span> <span class="s">':'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Connect to node B (<code>localhost</code> API port 1102). Change the <code>localhost</code> to modem B&#8217;s IP address and port 1102 to port 1100, if you are working with a modem.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Blocking <code>receive()</code> will only return when a datagram is received or the socket is closed. If a datagram is received, <code>rx</code> will contain the notification message with the details of the datagram.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In Python <code>from</code> is a keyword and cannot be used as an field name. We therefore use <code>from_</code> for the source node address.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First run <code>python rx.py</code> to start reception. Then, on a separate terminal window, run <code>python tx.py</code> to initiate transmission. You should see the received datagram printed by the <code>rx.py</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span> python rx.py
<span class="go">from node 1 : Hello!</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once you are done with your testing, it is time to shutdown the simulation. You can do that by pressing <code>Ctrl-C</code> on the terminal where you started the simulator. Alternatively, you can go to the shell of one of the nodes, and type: <code>shutdown</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_acoustic_modems">2.6. Using acoustic modems</h3>
<div class="paragraph">
<p>So far, we have worked with a simulator. While the experience is similar, it is not exactly the same. There is no real substitute for working with real modems. If you happen to have two UnetStack-compatible acoustic modems, you can use them to set up a simple 2-node network. Put them in a water body (tank, bucket, lake, sea, &#8230;&#8203;), power them on, and connect each to a computer over Ethernet. The setup would look something like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/bucket.png" alt="bucket" width="500" height="400">
</div>
<div class="title">Figure 3. Two-node acoustic underwater network</div>
</div>
<div class="paragraph">
<p>On each computer, open a web browser and key in the IP address of the respective modem. This should give us a command shell for node A and node B on the two computers.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you only have one computer available, you can connect both modems to the same Ethernet switch and connect to each modem&#8217;s IP address in separate browser windows.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When working with modems, you may need to adjust the transmit power level to a suitable level for use in the water body that you have the modems in. Too high or too low a power level will not allow the modems to communicate well. The modem transmit power can be adjusted using the <code>plvl</code> command. Type <code>help plvl</code> on the command shell for node A to see examples of how the command is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">help </span>plvl
<span class="go">plvl - get/set TX power level for all PHY channel types

Examples:
  plvl                       // get all power levels
  plvl -10                   // set all power to -10 dB
  plvl(-10)                  // alternative syntax
  plvl = -10                 // alternative syntax</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>help</code> command is your friend! Just type <code>help</code> to see a list of help topics. Type <code>help</code> followed by a command name, topic or parameter (you&#8217;ll learn more about these later) to get help information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming you have the modems in a bucket, you&#8217;ll need a fairly low transmit power. On node A, let us set the transmit power to -50 dB and try a transmission:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl <span class="nt">-50</span>
<span class="go">OK
</span><span class="gp">&gt;</span> tell 0, <span class="s1">'hello!'</span>
<span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all goes well, you should see the message on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">[232]: hello!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course you&#8217;ll see a different "from" address than the one shown in the example here. It will be the actual address of your modem A. In case you don&#8217;t see the message on node B after a few seconds, you may want to adjust the power level up or down and try again.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All the other examples shown earlier in this chapter will also work with the modems. You&#8217;ll just need to replace the <code>localhost</code> with the appropriate modem IP address, and the API port for the modem will usually be 1100.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_transmitting_and_recording_arbitrary_acoustic_waveforms">2.7. Transmitting and recording arbitrary acoustic waveforms</h3>
<div class="paragraph">
<p>If you have UnetStack-compatible acoustic modems that support the BASEBAND service, you can use them to transmit and record arbitrary acoustic signals. Even without access to modems, you can try this out using the Unet audio SDOAM&#8201;&#8212;&#8201;a fully functional modem that uses your computer&#8217;s soundcard for transmission and reception. To start Unet audio, open a terminal window in the simulator&#8217;s root folder and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet audio
Modem web: http://localhost:8080/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should start up the SDOAM and open a browser with a command shell accessing the modem. If the browser does not automatically open, just enter the modem web URL shown above in your browser. At the command shell, you can try transmitting a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tell 0, <span class="s1">'hello!'</span>
<span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should hear the transmission from your computer speaker! If you don&#8217;t, check your speaker volume and try again.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you have 2 computers running the unet audio SDOAM, you can receive the transmitted signal on the second computer and see the received message: <code>[1]: hello!</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, try sending a simple 10 kHz tonal signal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> bbtx cw<span class="o">(</span>10000, 0.5<span class="o">)</span>                    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:4104441] <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request transmission of a continuous wave (cw) signal of 10 kHz and 0.5 seconds duration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Notification that the signal was successfully transmitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should hear a 0.5 second 10 kHz tone from your computer speaker. The <code>bbtx</code> command requests transmission of a baseband signal. The function <code>cw()</code> generates such a signal based on the specified frequency and duration.</p>
</div>
<div class="paragraph">
<p>To generate the baseband representation of the signal you wish to transmit, you will need to know the carrier frequency and the baseband sampling rate of the modem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy.basebandRate
<span class="go">12000.0
</span><span class="gp">&gt;</span> phy.carrierFrequency
<span class="go">12000.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the unet audio SDOAM, the carrier frequency is 12 kHz and the baseband sampling rate is 12 kSa/s.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The baseband signal is represented as a floating point array with alternate real and imaginary components in Java/Groovy. For languages that support complex numbers (e.g. Python, Julia), the signal is simply an array of complex numbers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can equally easily ask the SDOAM to make an acoustic recording for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> bbrec 12000                            <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:1911353 rssi:-61.2 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>12000 baseband samples<span class="o">)]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request recording of 12000 baseband samples (1 second duration).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The recording is sent to you as a <code>RxBasebandSignalNtf</code> message with 12000 baseband samples in the <code>signal</code> field. You can check the first 32 samples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ntf.signal[0..31]
<span class="go">[-3.735939E-4, 6.7323225E-4, 7.94507E-4, 5.0331384E-4, 0.0012656008, -0.0010853912, -2.0923217E-4, -8.322359E-4, 1.5215082E-4, 2.417963E-4, -3.0220395E-5, -5.190366E-4, -6.904016E-4, -7.3395047E-4, 3.9846844E-5, 5.161132E-4, 0.0013477469, 6.2060537E-4, 1.00925405E-4, -3.974573E-4, -8.8431453E-4, -5.807383E-4, -5.730035E-4, -8.5867435E-4, -9.026667E-4, 2.2320295E-5, -1.7575005E-5, 0.0010946163, 7.7881676E-4, -3.7582265E-4, -9.449492E-4, -1.7722705E-4]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values you&#8217;d see would natually be different, since the SDOAM would have recorded whatever sounds it heard using your computer&#8217;s microphone.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While we illustrated the use of the BASEBAND service using the <code>bbtx</code> and <code>bbrec</code> commands, the same functionality can be accessed using the <code>TxBasebandSignalReq</code> and the <code>RecordBasebandSignalReq</code> messages. This is useful if you want to access the functionality from an agent or through the external gateway API (e.g. from a Jupyter Python notebook). You will learn how to do this in <a href="#_baseband_service">Chapter 15</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unetstack_basics">3. UnetStack basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>UnetStack is an <em>agent-based network stack</em>. Each <em>agent</em> is similar to a <em>layer</em> in a traditional network stack, but has more flexibility to use the scarce resources (bandwidth, energy, etc) in the Unet more efficiently. In order to develop Unet applications, we need to understand some basic concepts in UnetStack.</p>
</div>
<div class="sect2">
<h3 id="_the_command_shell">3.1. The command shell</h3>
<div class="paragraph">
<p>The simplest way to interact with UnetStack is via the command shell (or simply <em>shell</em>). The shell may be accessed on the console, a TCP/IP port or via the web interface. In <a href="#_getting_started">Chapter 2</a>, we have already seen how to set up a 2-node network and access the command shell for each of the nodes using a web browser. For the rest of this section, we assume that you have shells open on nodes A and B.</p>
</div>
<div class="paragraph">
<p>On node A, we can ask for a list of agents running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ps
<span class="go">remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ReliableLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
router: org.arl.unet.net.Router - IDLE
mac: org.arl.unet.mac.CSMA - IDLE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can further ask for more details of a specific agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy
<span class="gp">&lt;&lt;&lt; HalfDuplexModem &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 56

[org.arl.unet.bb.BasebandParam]
  basebandRate = 12000.0
  carrierFrequency = 12000.0
  maxPreambleID = 4
  maxSignalLength = 65536
  preambleDuration = 0.2
  signalPowerLevel = -10.0

[org.arl.unet.phy.PhysicalParam]
  busy = false
  maxPowerLevel = 0.0
  minPowerLevel = -96.0
  propagationSpeed = 1534.4574
  refPowerLevel = 185.0
  rxEnable = true
  rxSensitivity = -200.0
  time = 3283592429
  timestampedTxDelay = 1.0

[org.arl.unet.sim.HalfDuplexModemParam]
  basebandRxDuration = 1.0
  clockOffset = 3248.3442</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We asked for details of the agent <code>phy</code>, and we got a list of parameters supported by the agent. We can get or set individual parameters of the agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy.MTU
<span class="go">56
</span><span class="gp">&gt;</span> phy.rxEnable
<span class="go">true
</span><span class="gp">&gt;</span> phy.rxEnable <span class="o">=</span> <span class="nb">false</span>
<span class="go">false
</span><span class="gp">&gt;</span> phy.rxEnable
<span class="go">false
</span><span class="gp">&gt;</span> phy.rxEnable <span class="o">=</span> <span class="nb">true</span>
<span class="go">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To find out more about a specific parameter, we can ask for help on the parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">help </span>phy.MTU
<span class="go">phy.MTU - maximum transmission unit (MTU) in bytes
</span><span class="gp">&gt;</span> <span class="nb">help </span>phy.rxEnable
<span class="go">phy.rxEnable - true if reception enabled</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also ask for help on an agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">help </span>phy
<span class="go">phy - access to physical service

Examples:
  phy                           // access physical parameters
  phy[CONTROL]                  // access control channel parameters
  phy[DATA]                     // access data channel parameters
  phy &lt;&lt; msg                    // send request msg to physical agent
  phy.rxEnable = false          // disable reception of frames

Commands:

- plvl - get/set TX power level for all PHY channel types

Parameters:

The following parameters are available on all modems. Additional modem
dependent parameters are also available. For information on these
parameters type "help modem".

- phy.MTU - maximum transmission unit (MTU) in bytes
- phy.rxEnable - true if reception enabled
- phy.propagationSpeed - propagation speed in m/s
- phy.timestampedTxDelay - delay before TX of timestamped frames
- phy.time - physical layer time (us)
- phy.busy - true if modem is TX/RX a frame, false if idle
- phy.refPowerLevel - reference power level in dB re uPa @ 1m
- phy.maxPowerLevel - maximum supported power level (relative to reference)
- phy.minPowerLevel - minimum supported power level (relative to reference)

Channel Parameters:

The following parameters are available on all modems. Additional modem
dependent parameters are also available. For information on these
parameters type "help modem".

- phy[].MTU - maximum transmission unit (MTU) in bytes
- phy[].dataRate - effective frame data rate (bps)
- phy[].frameDuration - frame duration (seconds)
- phy[].powerLevel - powel level used for transmission (relative to reference)
- phy[].errorDetection - number of bytes for error detection
- phy[].frameLength - frame length (bytes)
- phy[].maxFrameLength - maximum settable frame length (bytes)
- phy[].fec - forward error correction code
- phy[].fecList - list of available forward error correction codes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From this help, we see that <code>phy</code> agent also supports channel parameters (also known as <em>indexed</em> parameters). It supports two logical channels, CONTROL (1) and DATA (2). The CONTROL channel is meant for low-rate robust data transmission, whereas the DATA channel is typically configured for higher rate data transmission. Channel parameters work in the same way as normal parameters, but with an index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[CONTROL]
<span class="gp">&lt;&lt;&lt; PHY &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 16

[org.arl.unet.phy.PhysicalChannelParam]
  dataRate = 256.0
  errorDetection = 1
  fec = 0
  fecList = null
  frameDuration = 0.95
  frameLength = 24
  janus = false
  llr = false
  maxFrameLength = 128
  powerLevel = -10.0

</span><span class="gp">&gt;</span> phy[DATA]
<span class="gp">&lt;&lt;&lt; PHY &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 56

[org.arl.unet.phy.PhysicalChannelParam]
  dataRate = 1024.0
  errorDetection = 1
  fec = 0
  fecList = null
  frameDuration = 0.7
  frameLength = 64
  janus = false
  llr = false
  maxFrameLength = 512
  powerLevel = -10.0

</span><span class="gp">&gt;</span> phy[CONTROL].MTU
<span class="go">16
</span><span class="gp">&gt;</span> phy[CONTROL].frameLength <span class="o">=</span> 32
<span class="go">32
</span><span class="gp">&gt;</span> phy[CONTROL].frameLength
<span class="go">32
</span><span class="gp">&gt;</span> phy[CONTROL].MTU
<span class="go">24
</span><span class="gp">&gt;</span> phy[CONTROL].frameLength <span class="o">=</span> 24
<span class="go">24</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The actual parameters you see may differ if you are working with a modem, depending on the specific capabilities of the modem. Use <code>help</code> to find out more about any listed parameter on your modem, or refer to the modem&#8217;s documentation for further information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most agents also support some commands. For example, the <code>phy</code> agent supports the <code>plvl</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">help </span>plvl
<span class="go">plvl - get/set TX power level for all PHY channel types

Examples:
  plvl                       // get all power levels
  plvl -10                   // set all power to -10 dB
  plvl(-10)                  // alternative syntax
  plvl = -10                 // alternative syntax

</span><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -10.0
phy[2].powerLevel = -10.0
phy[3].powerLevel = -10.0
phy.signalPowerLevel = -10.0
</span><span class="gp">&gt;</span> plvl <span class="nt">-20</span>
<span class="go">OK
</span><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -20.0
phy[2].powerLevel = -20.0
phy[3].powerLevel = -20.0
phy.signalPowerLevel = -20.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>plvl</code> command simply displays or sets the <code>powerLevel</code> parameter of all channels. The same can be manually accomplished by setting or getting individual parameters, if desired:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[1].powerLevel
<span class="go">-20
</span><span class="gp">&gt;</span> phy[1].powerLevel <span class="o">=</span> <span class="nt">-10</span>
<span class="go">-10
</span><span class="gp">&gt;</span> phy[1].powerLevel
<span class="go">-10
</span><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -10.0
phy[2].powerLevel = -20.0
phy[3].powerLevel = -20.0
phy.signalPowerLevel = -20.0</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While <code>plvl</code> seems like a command to just set/get a <code>powerLevel</code> parameter, it does that for several channels in one go. This can save you a lot of time and typing&#8201;&#8212;&#8201;to achieve the same thing manually, you&#8217;d be typing 4 commands!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_interacting_with_agents_using_messages">3.2. Interacting with agents using messages</h3>
<div class="paragraph">
<p>While you can access a lot of functionality via parameters and commands, to fully harness the power of UnetStack, we require an understanding of the underlying messaging system between the agents. All agents support messages that expose their functionality. In fact, all parameters and commands are implemented by exchanging messages between the shell agent and other agents. In this section, we&#8217;ll take a brief look at how messaging between agents works.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All parameters and commands are implemented by exchanging messages between the shell agent and other agents. When you get/set a parameter, all the shell is doing is sending a <code>ParameterReq</code> message to the appropriate agent, and showing you the <code>ParameterRsp</code> message that the agent responds with.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Typically, we would want to send a <em>request</em> to an agent and get a <em>response</em> message back. This can be accomplished with the <code>request</code> call (or the equivalent alias <code>&lt;&lt;</code>) on the agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(data: [1,2,3])
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:2913909740]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we made a request to the <code>phy</code> agent to transmit some data. The agent responded with an <code>AGREE</code> response, shortly followed by a <code>TxFrameNtf</code> notification from <code>phy</code> telling us that the transmission was successful.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A <em>frame</em> is simply a datagram at the physical layer, also sometimes called a "packet". We prefer the term "frame" when working at the physical layer, but the distinction between frames and datagrams is unimportant at this point in time. We will come back to this later, in <a href="#_physical_service">Chapter 14</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can also use the return value in a condition, but we need to remember that the return value from the <code>request</code> is a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> x <span class="o">=</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq();
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:3381446740]
</span><span class="gp">&gt;</span> <span class="sh">x
</span><span class="go">AGREE
</span><span class="gp">&gt;</span> x.class
<span class="go">class org.arl.fjage.Message
</span><span class="gp">&gt;</span> x.performative
<span class="go">AGREE
</span><span class="gp">&gt;</span> <span class="k">if</span> <span class="o">(</span>x.performative <span class="o">==</span> Performative.AGREE<span class="o">)</span> print <span class="s1">'OK'</span>
<span class="go">OK</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The semicolon ";" at the end of the first statement prevents the return value from being printed on the shell.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unsolicited notification messages can be received by subscribing to the topic of interest. For example, on node B, we can subscribe to physical layer events on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if we broadcast a frame from node A using <code>phy &lt;&lt; new TxFrameReq()</code>, we will see the relevant reception events on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:1765508396]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:232 rxTime:1765508396]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first event <code>RxFrameStartNtf</code> is triggered as soon as the frame is detected at node B. The second event <code>RxFrameNtf</code> is triggered when the frame is fully received, demodulated and successfully decoded at the receiver.</p>
</div>
<div class="paragraph">
<p>If all of this seems somewhat confusing to you, don&#8217;t worry about it. Most of the basic functionality of the stack can be accessed without having to deal with messages directly. As we need functionality that requires an understanding of messaging, we&#8217;ll gradually introduce them in later chapters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_shell_scripting">3.3. Shell scripting</h3>
<div class="paragraph">
<p>The default UnetStack shell accepts any <a href="https://groovy-lang.org">Groovy</a> code, and so is very flexible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> 1+2
<span class="go">3
</span><span class="gp">&gt;</span> 5.times <span class="o">{</span> print it <span class="o">}</span>
<span class="go">0
1
2
3
4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also define closures (if you&#8217;re not familiar with closures, you can think of them as functions for now):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tx2 <span class="o">=</span> <span class="o">{</span>
<span class="go">-   2.times {
-     phy &lt;&lt; new TxFrameReq()
-   }
</span><span class="gp">- };</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and call them later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tx2
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:3911898740]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:3912307740]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can write Groovy scripts and store them in the <code>scripts</code> folder with an extension <code>.groovy</code>. You can then invoke them from the shell by simply typing the name of the script (without the extension).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This only scratches the surface of what the command shell is capable of. However, it should provide you a basic understanding of how the shell works, and illustrate its power. To understand more, we suggest that you explore the online <code>help</code>. As you further understand the UnetStack and fjåge API, you&#8217;ll develop expertise on using the shell.</p>
</div>
</div>
</div>
</div>
<h1 id="_part_ii_setting_up_underwater_networks" class="sect0"><strong>Part II: Setting up underwater networks</strong></h1>
<div class="sect1">
<h2 id="_unet_basics">4. Unet basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a basic understanding of how UnetStack works, it is time to take the next step into setting up and configuring underwater networks, or simply <em>Unets</em>.</p>
</div>
<div class="sect2">
<h3 id="_node_names_and_addresses">4.1. Node names and addresses</h3>
<div class="paragraph">
<p>Unet nodes are identified by unique addresses within the Unet. Small Unets might use 8-bit addresses, supporting up to 255 different nodes. Larger Unets might use 16-bit addresses, supporting up to 65535 different nodes in the network. The address space is controlled by the parameter <code>node.addressSize</code>, and must be set to the same value (either 8 or 16) on all nodes in a Unet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code examples in this chapter assume that you have a simulated Unet (the 2-node-network simulation from <a href="#_getting_started">Chapter 2</a>) running, and you&#8217;re connected to the shell of one of the nodes. However, if you have access to modems, you may choose to use the real Unet and connect to the shell of one of the modem nodes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To check the current address size on your node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  nodeName = A
  address = 232
  addressSize = 8
  canForward = true
  mobility = false
  location = [0.0, 0.0, -15.0]
  origin = [NaN, NaN]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some node parameters have not been shown in the above listing for brevity.</p>
</div>
<div class="paragraph">
<p>Address 0 is a broadcast address. All other addresses may be assigned to nodes in a Unet. Each Unet node is also associated with a node name (<code>node.nodeName</code>). If a node name is not explicity set, it defaults to the string representation of the node address. Descriptive node names may be used, if desired:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node.nodeName <span class="o">=</span> <span class="s1">'buoy_A'</span>
<span class="go">buoy_A
</span><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  nodeName = buoy_A
  address = 232
  addressSize = 8
  canForward = true
  mobility = false
  location = [1000.0, 0.0, -15.0]
  origin = []</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is recommended that, if descriptive node names are used, the corresponding node addresses be set using the ADDRESS_RESOLUTION service. This ensures that name-to-address resolution leads to the correct address for the node. The ADDRESS_RESOLUTION service can be accessed via the <code>host()</code> shell command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> host<span class="o">(</span><span class="s1">'buoy_A'</span><span class="o">)</span>
<span class="go">68
</span><span class="gp">&gt;</span> node.address <span class="o">=</span> host<span class="o">(</span>node.nodeName<span class="o">)</span>
<span class="go">68</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default ADDRESS_RESOLUTION agent in the UnetStack maps node names to node addresses using a hash function. The method reduces network traffic for host name resolution, but can lead to address conflicts between nodes if two names happen to map to the same address. It is the responsibility of the network engineer to resolve address conflicts manually during the setup of the network, if the default ADDRESS_RESOLUTION agent is used. For small networks, this is simply a matter of checking that all chosen node names in the network lead to unique node addresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="o">[</span><span class="s1">'buoy_A'</span>, <span class="s1">'auv_1'</span>, <span class="s1">'auv_2'</span>, <span class="s1">'sensor_adcp1'</span>, <span class="s1">'sensor_ctd1'</span><span class="o">]</span>.each <span class="o">{</span> name -&gt;
<span class="gp">-   print "$</span><span class="o">{</span>name<span class="o">}</span>: <span class="k">${</span><span class="nv">host</span><span class="p">(name)</span><span class="k">}</span><span class="s2">"
</span><span class="gp">- };</span>
<span class="go">buoy_A: 68
auv_1: 150
auv_2: 109
sensor_adcp1: 43
sensor_ctd1: 14</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_protocol_numbers">4.2. Protocol numbers</h3>
<div class="paragraph">
<p>Datagrams represent packets of data sent between nodes. Each node may have multiple agents and applications running on it, and so we need a way to specify which application the datagram is meant for. To aid with this, each datagram is associated with a protocol number that identifies the consumer on the destination node that the datagram is intended for. The consumer may be an agent or an end-user application. Protocol numbers can be thought of as port numbers in TCP/IP or UDP/IP.</p>
</div>
<div class="paragraph">
<p>The consumer may be an agent or an end-user application. Protocol number 0 (<code>Protocol.DATA</code>) is used for generic application data. Protocol numbers from 1 to <code>Protocol.USER-1</code> (31) are reserved for use by default stack agents. Protocol numbers from <code>Protocol.USER</code> (32) to <code>Protocol.MAX</code> (63) are available for end-user applications to use.</p>
</div>
<div class="paragraph">
<p>On node B, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> s.bind<span class="o">(</span>Protocol.USER<span class="o">)</span>                 // listen <span class="k">for </span>datagrams with Protocol.USER
<span class="gp">&gt;</span> rx <span class="o">=</span> s.receive<span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to wait for a reception with <code>Protocol.USER</code>.</p>
</div>
<div class="paragraph">
<p>On node A, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> s.connect<span class="o">(</span>host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>, Protocol.DATA<span class="o">)</span>  // send datagrams with Protocol.DATA
<span class="gp">&gt;</span> s.send<span class="o">(</span><span class="s1">'hi!'</span> as byte[]<span class="o">)</span>
<span class="gp">&gt;</span> s.connect<span class="o">(</span>host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>, Protocol.USER<span class="o">)</span>  // send datagrams with Protocol.USER
<span class="gp">&gt;</span> s.send<span class="o">(</span><span class="s1">'hello!'</span> as byte[]<span class="o">)</span>
<span class="go">true
</span><span class="gp">&gt;</span> s.close<span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Node B will receive only the second message, since it is listening for datagrams with <code>Protocol.USER</code> only. We can confirm this by checking the data in the received datagram on the command shell for node B, and close the socket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">DatagramNtf:INFORM[from:68 to:31 protocol:32 (6 bytes)]
</span><span class="gp">&gt;</span> new String<span class="o">(</span>rx.data<span class="o">)</span>
<span class="go">hello!
</span><span class="gp">&gt;</span> s.close<span class="o">()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_small_networks">5. Setting up small networks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_netiquette_testbed">5.1. Netiquette testbed</h3>
<div class="paragraph">
<p>The Netiquette testbed in Singapore is a 3-node network that is deployed at sea (see <a href="#fig_netq_map">Figure 4</a>), and accessible over the Internet. Nodes A and B are cabled seabed mounted nodes, while node C is a solar-powered buoy. We use a simulated version of the Netiquette testbed to learn how to set up and operate small networks.</p>
</div>
<div id="fig_netq_map" class="imageblock">
<div class="content">
<img src="images/netq-map.png" alt="Netiquette" width="600" height="450">
</div>
<div class="title">Figure 4. Netiqutte testbed</div>
</div>
<div class="paragraph">
<p>To start the simulated network, we simply run the <code>netq-network.groovy</code> simulation script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet samples/netq-network.groovy

Netiquette 3-node network
<span class="nt">-------------------------</span>

Node A: tcp://localhost:1101, http://localhost:8081/
Node B: tcp://localhost:1102, http://localhost:8082/
Node C: tcp://localhost:1103, http://localhost:8083/</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The port numbers you see in the examples above aren&#8217;t particularly special. They are simply whatever were chosen by the developer of the simulation, and can be found in the <code>netq-network.groovy</code> script. The only restriction on the choice is that placed by the OS&#8201;&#8212;&#8201;usually port numbers below 1024 are <em>reserved</em> and unavailable to users. Of course, they must also be unique and unused by other applications running on your computer.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_node_names_addresses">5.2. Node names &amp; addresses</h3>
<div class="paragraph">
<p>We start off by checking the configuration of each node:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  address = 232
  addressSize = 8
  location = [121.0, 137.0, -10.0]
  mobility = false
  nodeName = A
  origin = [1.216, 103.851]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  address = 31
  addressSize = 8
  location = [160.0, -232.0, -15.0]
  mobility = false
  nodeName = B
  origin = [1.216, 103.851]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>Node C</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  address = 74
  addressSize = 8
  location = [651.0, 140.0, -5.0]
  mobility = false
  nodeName = C
  origin = [1.216, 103.851]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All nodes are configured to use 8-bit addresses. Node A has is address 232, node B is 31, and node C is 74. The origin is set to GPS location 1.216° N, 103.851° E. Locations are measured in meters relative to this origin, with <em>x</em> axis pointing east, and <em>y</em> axis pointing north. The mobility of the nodes is set to <code>false</code> to indicate that the nodes are static (for mobile nodes, mobility should be set to <code>true</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the simulated network, all of the node parameters are correctly setup by the simulator. In a real network, you may need to setup each node by manually setting the appropriate parameters. To ensure that the nodes retain the parameters between reboots, once a node is setup, simply run <code>savestate</code> on the node. This creates a <code>saved-state.groovy</code> file in the <code>scripts</code> folder with the saved settings. The settings are then automatically loaded when the node is rebooted.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_connectivity_ranging">5.3. Connectivity &amp; ranging</h3>
<div class="paragraph">
<p>Let us first check the connectivity between the nodes:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ping host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">PING 31
Response from 31: seq=0 rthops=2 time=2507 ms
Response from 31: seq=1 rthops=2 time=2852 ms
Response from 31: seq=2 rthops=2 time=2852 ms
3 packets transmitted, 3 packets received, 0% packet loss
</span><span class="gp">&gt;</span> ping host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">PING 74
Response from 74: seq=0 rthops=2 time=2600 ms
Response from 74: seq=1 rthops=2 time=2634 ms
Response from 74: seq=2 rthops=2 time=2737 ms
3 packets transmitted, 3 packets received, 0% packet loss</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The connectivity from node A to nodes B and C looks good. What about the connectivity from node B to node C?</p>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ping host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">PING 74
Response from 74: seq=0 rthops=2 time=2810 ms
Response from 74: seq=1 rthops=2 time=2666 ms
Response from 74: seq=2 rthops=2 time=2742 ms
3 packets transmitted, 3 packets received, 0% packet loss</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks good too!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this simulation, everything checks out nicely. But, in the real world, there may be packet loss to contend with. We will see how to handle those in later chapters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can also check cross-check that the routes from node A to nodes B and C are direct:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> trace host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">[232, 31, 232]
</span><span class="gp">&gt;</span> trace host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">[232, 74, 232]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first trace shows that the datagram originated at node A (address 232), reached node B (address 31), and was sent back to node A. The second trace similarly went from node A to node C (address 74) and back. No hops in between, since our network is fully connected.</p>
</div>
<div class="paragraph">
<p>We can also make range measurements (in meters) between the nodes:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'A'</span><span class="o">)</span>
<span class="go">0.0
</span><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">370.98
</span><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">529.87</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'A'</span><span class="o">)</span>
<span class="go">370.98
</span><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">0.0
</span><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">615.9</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_text_messages">5.4. Sending text messages</h3>
<div class="paragraph">
<p>Once we have connectivity, we can of course send text messages from the shell:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> tell host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>, <span class="s1">'hello!'</span>
<span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and we see the text message on node B:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">[232]: hello!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have already seen in <a href="#_getting_started">Chapter 2</a> and <a href="#_protocol_numbers">Section 4.2</a> on how to send text messages using the UnetSocket API from the shell, as well as from external applications. Hence we won&#8217;t dwell on it here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_transfer_and_remote_access">5.5. File transfer and remote access</h3>
<div class="paragraph">
<p>Data is often stored in files. Transferring files between nodes is a common requirement. File transfers and remote access is disabled by default. Let us enable this on node B:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> remote
<span class="gp">&lt;&lt;&lt; RemoteControl &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.remote.RemoteControlParam]
  cwd = /Users/mandar/Projects/unet/scripts
  dsp = transport
  enable = false
  reliability = true
  shell = websh
  groovy = true

</span><span class="gp">&gt;</span> remote.enable <span class="o">=</span> <span class="nb">true</span>
<span class="go">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can send &amp; receive files, and run remote commands on node B. Let&#8217;s try it from node A:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> B <span class="o">=</span> host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>
<span class="go">31
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'tell me,"hi!"'</span>             <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AGREE
[31]: hi!                            <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp">&gt;</span> file<span class="o">(</span><span class="s1">'abc.txt'</span><span class="o">)</span>.text <span class="o">=</span> <span class="s1">'demo'</span><span class="p">;</span>     <i class="conum" data-value="3"></i><b>(3)</b>
<span class="gp">&gt;</span> <span class="nb">ls</span>                                 <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">abc.txt [4 bytes]
README.md [96 bytes]
</span><span class="gp">&gt;</span> fput B, <span class="s1">'abc.txt'</span>                  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ask node B to send a "hi!" back to me. The variable <code>me</code> is automatically defined to be the source node address during the execution of the shell command when Groovy extensions are enabled (<code>remote.groovy = true</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On node A, we receive a "hi!" after a short delay.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a file <code>abc.txt</code> with <code>demo</code> as content.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>List local files to check that we have a 4-byte file called <code>abc.txt</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Send file <code>abc.txt</code> to node B.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On the shell for node B, we see the notification that the file <code>abc.txt</code> was successfully received:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre>remote &gt;&gt; RemoteFileNtf:INFORM[from:232 filename:abc.txt (4 bytes)]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although we demonstrated file transfers between nodes with the simulator, all simulated nodes are running on your machine and so sharing the filesystem. When the file <code>abc.txt</code> was transferred from node A to B, the same file was simply overwritten, since it was created in the same folder. You could easily verify this by checking the modification time of the file on the filesystem before and after the transfer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use <code>fget</code> to receive a file from a remote node, but you have to remember to set <code>remote.enable = true</code> on the receiving node:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> remote.enable <span class="o">=</span> <span class="nb">true</span>
<span class="go">true
</span><span class="gp">&gt;</span> fget B, <span class="s1">'abc.txt'</span>
<span class="go">AGREE
</span><span class="gp">remote &gt;</span><span class="o">&gt;</span> RemoteFileNtf:INFORM[from:31 filename:abc.txt <span class="o">(</span>4 bytes<span class="o">)]</span>
<span class="gp">&gt;</span> fget B, <span class="s1">'def.txt'</span>
<span class="go">AGREE
</span><span class="gp">remote &gt;</span><span class="o">&gt;</span> RemoteFailureNtf:INFORM[RemoteFileGetReq:REQUEST[to:31 filename:def.txt] reason:no-file]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last command failed to get file <code>def.txt</code>, as it does not exist on node B.</p>
</div>
<div class="paragraph">
<p>When we send commands to execute on a remote node, they are usually silently executed and the output is not sent back. If we want the output to be shown to us, we need to explicity ask for it using <code>tell</code>. Since this is often required, we have a simple Groovy extensions shortcut <code>?</code> to do this for us:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> rsh B, <span class="s1">'tell me,node.nodeName'</span>
<span class="go">AGREE
[31]: B
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'?node.nodeName'</span>
<span class="go">AGREE
[31]: B
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'?ls'</span>
<span class="go">AGREE
[31]: abc.txt [4 bytes]
README.md [96 bytes]
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'?1+2'</span>
<span class="go">AGREE
[31]: 3
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'?"You are ${me}, I am ${node.address}"'</span>
<span class="go">AGREE
[31]: You are 232, I am 31
</span><span class="gp">&gt;</span> rsh B, <span class="s1">'?range '</span>+host<span class="o">(</span><span class="s1">'C'</span><span class="o">)</span>
<span class="go">AGREE
[31]: 615.9</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes we are not interested in the output, but simply want an acknowledgement that the command was successfully executed. For example, if we set the transmission power on a remote node, we want to know that it was set. That can be requested using the <code>ack</code> function.</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ack on
<span class="gp">&gt;</span> rsh B, <span class="s1">'plvl -6'</span>
<span class="go">AGREE
</span><span class="gp">remote &gt;</span><span class="o">&gt;</span> RemoteSuccessNtf:INFORM[RemoteExecReq:REQUEST[to:31 <span class="nb">command</span>:plvl <span class="nt">-6</span> ack:true]]
<span class="gp">&gt;</span> ack off</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_node_locations_coordinate_systems">5.6. Node locations &amp; coordinate systems</h3>
<div class="paragraph">
<p>As seen in <a href="#_node_names_addresses">Section 5.2</a>, some network nodes may know their own locations. This is useful for location-based routing and other applications. Depending on the application needs, we may wish to use different coordinate systems when setting up a network. There are 4 basic options to choose from:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">No coordinates</dt>
<dd>
<p>We do not know or care about each node&#8217;s location.</p>
</dd>
<dt class="hdlist1">Local coordinates</dt>
<dd>
<p>We wish to work in a local coordinate system, with only relative locations of the nodes being important.</p>
</dd>
<dt class="hdlist1">Georeferenced local coordinates</dt>
<dd>
<p>We wish to work in a local coordinate system, with relative node locations specified in local coordinates. The GPS coordinate of the origin of the local coordinate system is specified.</p>
</dd>
<dt class="hdlist1">GPS coordinates</dt>
<dd>
<p>We wish to specify the GPS location of each node, without defining a local coordinate system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When node locations are not accurately known, we can opt not to define any coordinate system. Local coordinate systems are preferred in applications where such a coordinate system can be agreed upon for the entire network. Range computation and localization is easier to do in local coordinates. GPS coordinates are used when node location is important, but a local coordinate system cannot be easily defined (e.g. ad hoc network with no prior knowledge of area of operation).</p>
</div>
<div class="paragraph">
<p>UnetStack supports all 4 options through a set of simple conventions:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">No coordinates</dt>
<dd>
<p><code>node.origin = []</code>, <code>node.location = []</code> for all nodes.</p>
</dd>
<dt class="hdlist1">Local coordinates</dt>
<dd>
<p><code>node.origin = [Float.NaN, Float.NaN]</code> for all nodes. <code>node.location = [x, y, z]</code> is specified as a 3-tuple in meters. The <em>z</em> axis points downwards (with sealevel being considered 0 m), but the <em>x</em> and <em>y</em> axes are arbitrarily chosen.</p>
</dd>
<dt class="hdlist1">Georeferenced local coordinates</dt>
<dd>
<p><code>node.origin = [latitude, longitude]</code> for all nodes, with latitude and longitude being the commonly agreed origin location. <code>node.location = [x, y, z]</code> is specified as a 3-tuple in meters. The <em>x</em> axis points east, <em>y</em> axis points north, and the <em>z</em> axis points downwards (with sealevel being considered 0 m).</p>
</dd>
<dt class="hdlist1">GPS coordinates</dt>
<dd>
<p><code>node.origin = []</code> for all nodes, and <code>node.location = [latitude, longitude, z]</code> where the <em>z</em> axis points downwards (with sealevel being considered 0 m).</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Unet simulator requires a local coordinate system to be defined, and so only local coordinates or georeferenced local coordinates must be used in the simulator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In <a href="#_connectivity_ranging">Section 5.3</a>, we measured the acoustic range between nodes A and B to about about 371 m. We can check this against distance computed from the location of nodes A and B. We first get the location of node A:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node.location
<span class="go">[121.0, 137.0, -10.0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then compute the distance to it on node B:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node B</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> distance<span class="o">(</span>node.location, <span class="o">[</span>121.0, 137.0, <span class="nt">-10</span>.0]<span class="o">)</span>
<span class="go">371.09</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that it agrees well with the acoustic range!</p>
</div>
<div class="paragraph">
<p>It is often necessary to convert between the GPS coordinate system and the local coordinate system. To aid in this, UnetStack provides a set of utility functions:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node A</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> gps <span class="o">=</span> new org.arl.unet.utils.GpsLocalFrame<span class="o">(</span>node.origin<span class="o">)</span><span class="p">;</span>   // <span class="nb">set </span>origin GPS coordinates
<span class="gp">&gt;</span> gps.toGps<span class="o">(</span>node.location[0..1]<span class="o">)</span>                             // <span class="nb">local </span>to GPS
<span class="go">[1.217238981, 103.8520872]                                   // GPS coordinates of node A
</span><span class="gp">&gt;</span> gps.toLocal<span class="o">(</span>1.21723898, 103.8520872<span class="o">)</span>                       // GPS to <span class="nb">local</span>
<span class="go">[120.9994, 136.9999]
</span><span class="gp">&gt;</span> node.location
<span class="go">[121.0, 137.0, -10.0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GpsLocalFrame</code> class has additional constructors and utility methods to work with GPS coordinates in degrees, minutes and seconds, if desired.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routing_in_larger_networks">6. Routing in larger networks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_mission_2013_network">6.1. MISSION 2013 network</h3>
<div class="paragraph">
<p>The MISSION 2013 experiment in Singapore featured a 7-node network that was deployed at sea (see <a href="#fig_m13_map">Figure 5</a>) for several weeks. The network operated in a challenging area with complex 3D bathymetry, several reefs and heavy shipping. During the experiment, we transmitted more than 40000 frames of data and collected statistics on communication performance across various links in the network. These performance statistics are embedded in the <code>Mission2013a</code> channel model in UnetStack. We use a simulated version of the MISSION 2013 network to learn how to set up and operate larger networks that require routing.</p>
</div>
<div id="fig_m13_map" class="imageblock">
<div class="content">
<img src="images/m13-map.png" alt="MISSION 2013" width="600" height="450">
</div>
<div class="title">Figure 5. MISSION 2013 network</div>
</div>
<div class="paragraph">
<p>To start the simulated network, we simply run the <code>mission2013-network.groovy</code> simulation script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet samples/mission2013-network.groovy

MISSION 2013 network
<span class="nt">--------------------</span>
Node 21: tcp://localhost:1121, http://localhost:8021/
Node 22: tcp://localhost:1122, http://localhost:8022/
Node 27: tcp://localhost:1127, http://localhost:8027/
Node 28: tcp://localhost:1128, http://localhost:8028/
Node 29: tcp://localhost:1129, http://localhost:8029/
Node 31: tcp://localhost:1131, http://localhost:8031/
Node 34: tcp://localhost:1134, http://localhost:8034/</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the MISSION 2013 network is not physically very large (only about 1.5 km across), the challenging environment kept the network from being fully connected, i.e., not all nodes could directly communicate with all others. The average frame delivery ratio (number of successfully delivered frames / number of transmitted frames) on each link is shown in <a href="#tab_m13_fdr">Table 2</a>. The link quality is also shown on the map in <a href="#fig_m13_map">Figure 5</a>, with dark blue links being the good ones, dark green ones being the weak ones, and brownish one being the very poor link.</p>
</div>
<table id="tab_m13_fdr" class="tableblock frame-all grid-all" style="width: 70%;">
<caption class="title">Table 2. Average frame delivery ratio for MISSION 2013 network</caption>
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">To: From:</th>
<th class="tableblock halign-right valign-top">21</th>
<th class="tableblock halign-right valign-top">22</th>
<th class="tableblock halign-right valign-top">27</th>
<th class="tableblock halign-right valign-top">28</th>
<th class="tableblock halign-right valign-top">29</th>
<th class="tableblock halign-right valign-top">31</th>
<th class="tableblock halign-right valign-top">34</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">21</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.926</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.266</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.917</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.912</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.552</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">22</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.867</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.471</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.751</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.850</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.288</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">27</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.359</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.381</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.313</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.322</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">28</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.847</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.869</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.390</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.845</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.925</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.863</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">29</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.539</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.693</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.333</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.688</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.374</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">31</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.902</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.805</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.795</p></td>
</tr>
<tr>
<th class="tableblock halign-right valign-top"><p class="tableblock">34</p></th>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.236</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.436</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.684</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0.544</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_connectivity_without_routing">6.2. Connectivity without routing</h3>
<div class="paragraph">
<p>During the MISSION 2013 experiment, node 21 was a gateway node with surface expression. All other nodes were on the seabed and not directly accessible. So let us start by exploring the connectivity from node 21 to other nodes:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ping 22
<span class="go">PING 22
Response from 22: seq=0 rthops=2 time=10609 ms
Response from 22: seq=1 rthops=2 time=2656 ms
Response from 22: seq=2 rthops=2 time=2739 ms
3 packets transmitted, 3 packets received, 0% packet loss
</span><span class="gp">&gt;</span> ping 27
<span class="go">PING 27
Request timeout for seq 0
Response from 27: seq=1 rthops=2 time=2960 ms
Request timeout for seq 2
3 packets transmitted, 1 packets received, 67% packet loss
</span><span class="gp">&gt;</span> ping 28
<span class="go">PING 28
Response from 28: seq=0 rthops=2 time=2725 ms
Response from 28: seq=1 rthops=2 time=3036 ms
Response from 28: seq=2 rthops=2 time=3158 ms
3 packets transmitted, 3 packets received, 0% packet loss
</span><span class="gp">&gt;</span> ping 29
<span class="go">PING 29
Response from 29: seq=0 rthops=2 time=3456 ms
Response from 29: seq=1 rthops=2 time=3298 ms
Response from 29: seq=2 rthops=2 time=3515 ms
3 packets transmitted, 3 packets received, 0% packet loss
</span><span class="gp">&gt;</span> ping 31
<span class="go">PING 31
Request timeout for seq 0
Request timeout for seq 1
Request timeout for seq 2
3 packets transmitted, 0 packets received, 100% packet loss
</span><span class="gp">&gt;</span> ping 34
<span class="go">PING 34
Request timeout for seq 0
Response from 34: seq=1 rthops=2 time=19603 ms
Request timeout for seq 2
3 packets transmitted, 1 packets received, 67% packet loss</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the connectivity to nodes 22, 28 and 29 is good, that to nodes 27 and 34 is poor, and to node 31 is non-existent.</p>
</div>
</div>
<div class="sect2">
<h3 id="_static_routing">6.3. Static routing</h3>
<div class="paragraph">
<p>From <a href="#fig_m13_map">Figure 5</a> and <a href="#tab_m13_fdr">Table 2</a>, we see that node 28 has good connectivity to nodes 31 and 34, so perhaps we could relay datagrams via node 28. Although the link between 22 and 27 seems to be better than the rest, the connectivity to that node is generally poor. Let us set up the following routes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relay data between nodes 21 and 31 via node 28</p>
</li>
<li>
<p>Relay data between nodes 21 and 34 via node 28</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On node 21, we add routes to nodes 31 and 34:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> addroute 31, 28
<span class="gp">&gt;</span> addroute 34, 28
<span class="gp">&gt;</span> routes
<span class="go">1: to 31 via uwlink/28 [reliable, hops: 0, metric: 1.0]
2: to 34 via uwlink/28 [reliable, hops: 0, metric: 1.0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On nodes 31 and 34, we add routes to node 21 via node 28:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 31</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> addroute 21, 28
<span class="gp">&gt;</span> routes
<span class="go">1: to 21 via uwlink/28 [reliable, hops: 0, metric: 1.0]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>Node 34</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> addroute 21, 28
<span class="gp">&gt;</span> routes
<span class="go">1: to 21 via uwlink/28 [reliable, hops: 0, metric: 1.0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can check out connectivity from node 21 to nodes 31 and 34 again:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ping 31
<span class="go">PING 31
Response from 31: seq=0 rthops=4 time=15245 ms
Response from 31: seq=1 rthops=4 time=10673 ms
Response from 31: seq=2 rthops=4 time=10779 ms
3 packets transmitted, 3 packets received, 0% packet loss
</span><span class="gp">&gt;</span> ping 34
<span class="go">Response from 34: seq=0 rthops=4 time=26878 ms
Request timeout for seq 1
Request timeout for seq 2
3 packets transmitted, 1 packets received, 67% packet loss</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the connectivity to node 31 seems okay, the connectivity to node 34 is still poor. We notice that the <code>seq=0</code> round-trip time is very close to the timeout of 30 seconds, and so try a ping with a longer timeout of 60 seconds:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ping 34, 3, 60000
<span class="go">Response from 34: seq=0 rthops=4 time=38505 ms
Response from 34: seq=1 rthops=4 time=34393 ms
Response from 34: seq=0 rthops=4 time=22521 ms
3 packets transmitted, 3 packets received, 0% packet loss</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Much better!</p>
</div>
<div class="paragraph">
<p>The pings to nodes 31 and 34 show <code>rthops</code> (round trip hops) to be 4, which makes sense, since we have 2-hop routes in each direction. We can ask the routing agent for a trace to check what route the datagram took:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> trace 31
<span class="go">[21, 28, 31, 28, 21]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows that the datagram originated at node 21, passed through node 28 before reaching node 31. Then on the way back, it passed through node 28 again, and reached us back at node 21.</p>
</div>
<div class="paragraph">
<p>Let us next try to do something using the routes we created. We can get node 21 to ask node 31 to measure the range to node 34 and report it to us. This request will be relayed via node 28, since our routing tables are set up to do so. Remember to set <code>remote.enable = true</code> on node 31 before making the request from node 21:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> rsh 31, <span class="s1">'?range 34'</span>
<span class="go">AGREE
[31]: 873.67</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from <a href="#tab_m13_fdr">Table 2</a>, the connectivity between nodes 31 and 34 is poor in this simulated network. You may need to try this command several times before you get a range estimate. When the ranging fails, you should see the message "ERROR: No response from remote node" back from node 31, which by itself demonstrates successful routing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t have the patience to try a few times for range from node 31 to node 34, try getting a range from node 31 to 28, which will be much quicker: <code>rsh 31, '?range 28'</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_route_discovery">6.4. Route discovery</h3>
<div class="paragraph">
<p>In the previous section, we learned how to set up static routes manually. But what if we are too lazy to determine the routes manually? Or if we don&#8217;t have access to the nodes on the seabed to set up routes? We can use the route discovery agent to populate the routing tables.</p>
</div>
<div class="paragraph">
<p>To see how to do this, let us restart our MISSION 2013 simulation so that the routing tables are empty (alternatively we can remove the routes we created earlier by typing <code>delroutes</code> on nodes 21, 31 and 34). We can verify that the routing table is indeed empty:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> routes
<span class="gp">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, start a route discovery to node 31:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> rreq 31
<span class="go">OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Patiently wait for a minute or two before checking the routing table on node 21:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> routes
<span class="go">1: to 29 via uwlink/29 [reliable, hops: 1, metric: 2.0]
2: to 34 via uwlink/34 [reliable, hops: 1, metric: 2.0]
3: to 22 via uwlink/22 [reliable, hops: 1, metric: 3.0]
4: to 28 via uwlink/28 [reliable, hops: 1, metric: 5.0]
5: to 31 via uwlink/28 [reliable, hops: 2, metric: 0.85]
6: to 27 via uwlink/27 [reliable, hops: 1, metric: 1.0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Your routing table may differ, as the route discovery process is stochastic. We see that we now have a route to node 31 via node 28. Let us check the routing table on node 31 as well, to see if it has a corresponding entry for a route to node 21:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 31</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> routes
<span class="go">1: to 29 via uwlink/29 [reliable, hops: 1, metric: 2.0]
2: to 21 via uwlink/29 [reliable, hops: 2, metric: 1.7]
3: to 28 via uwlink/28 [reliable, hops: 1, metric: 5.0]
4: to 21 via uwlink/28 [reliable, hops: 2, metric: 4.2]
5: to 34 via uwlink/34 [reliable, hops: 1, metric: 2.0]
6: to 21 via uwlink/34 [reliable, hops: 3, metric: 1.6]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Indeed it does! In fact, it has 3 routes back to node 21, one via node 29, another via node 28 and the last via node 34. Of these routes, the route via node 28 has the largest metric, and so will be the route that is used. We can verify that by issuing a trace from node 21:</p>
</div>
<div class="listingblock">
<div class="title"><code>Node 21</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> trace 31
<span class="go">[21, 28, 31, 28, 21]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since the route discovery process is stochastic, it may be useful to repeat the route discovery if good routes are not established after a single try. The <code>rreq</code> command can also be called with parameters to control the repetition. For example <code>rreq 31, 3, 6, 30</code> will initiate 6 route discoveries to node 31 looking for up to 3-hop routes spaced by 30 seconds between discoveries.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wired_and_over_the_air_links">7. Wired and over-the-air links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The networks we explored in the last few chapters were completely underwater. All links were underwater acoustic links. If we wanted to replace some of the acoustic links with underwater optical or RF links, or even through-the-air cellular, WiFi or RF links, that could easily be done, as long as you had a modem driver (a specific type of agent) that supported the device that provided the link. Cellular, WiFi and other devices often already have TCP/IP network stacks running on them, to provide seamless connectivity to the Internet. UnetStack can leverage the existing network stack in these devices without having to develop new modem drivers, by translating Unet datagrams to UDP/IP datagrams, tunneling them through the IP network, and translating them back to Unet datagrams at the other end.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_part_iii_building_unet_applications" class="sect0"><strong>Part III: Building Unet applications</strong></h1>
<div class="sect1">
<h2 id="_interfacing_with_unetstack">8. Interfacing with UnetStack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You now know how to set up a Unet. Let us next explore how you can go about interfacing your application with UnetStack to take advantage of the Unet. There are several options available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>UnetSocket API</strong> (<a href="#_unetsocket_api">Chapter 9</a>) is the most convenient way of interface most modern applications with UnetStack. API bindings are available for many languages, including Java, Groovy, Python, Julia, Javascript and C. The API allows you to send and receive user data over the Unet, get and set agent parameters, and access advanced functionality by interacting with agents using messages.</p>
</li>
<li>
<p><strong>UDP portals</strong> (<a href="#_udp_portal">Section 10.1</a>) provide a way to establish tunnels through the Unet for UDP datagrams. This facility can be used to transparently run applications that use UDP, over the Unet.</p>
</li>
<li>
<p><strong>TCP portals</strong> (<a href="#_tcp_portal">Section 10.3</a>) and <strong>serial portals</strong> (<a href="#_serial_portal">Section 10.4</a>) provide a way to establish connection-oriented tunnels through the Unet. This is a simple way to run applications that communicate over a TCP/IP or serial port links, over the Unet.</p>
</li>
<li>
<p>Many traditional modems provide an AT command set for applications to interact with them. While we do not encourage the use of AT commands (as they are error-prone and limited in functionality), it would be amiss not to mention that UnetStack also supports an <strong>AT script engine</strong> (<a href="#_at_script_engine">Chapter 11</a>) that may be used by legacy applications to interact with it using AT commands.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unetsocket_api">9. UnetSocket API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The command shell is great for manual configuration and interaction, but often we require programmatic interaction from an external application. For this, we have the UnetSocket API (available in Java, Groovy, Python, Julia and C). While the exact syntax differs across languages, the basic concepts remain the same. We focus on the use of the API in Groovy in this section, but also show some examples in other languages.</p>
</div>
<div class="sect2">
<h3 id="_connecting_to_unetstack">9.1. Connecting to UnetStack</h3>
<div class="paragraph">
<p>If you recall from <a href="#_sending_receiving_application_data">Section 2.4</a>, you opened a socket connection to UnetStack on the command shell with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the command shell was running on the node you wanted to connect to, the meaning of <code>this</code> was clear. However, in general, you&#8217;ll probably be running your application in a different process, or even on a different computer. You&#8217;ll therefore need to provide details on how to connect to the node when opening a socket.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The examples in this chapter assume that you are running:<br>
<code>bin/unet samples/2-node-network.groovy</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, to connect to UnetStack from an application over TCP/IP, we need to know the IP address and port of the API connector on UnetStack. Simply type <code>iface</code> on the command shell of node A to find this information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> iface
<span class="go">tcp://192.168.1.9:1101 [API]
ws://192.168.1.9:8081/ws [API]
websh: ws://192.168.1.9:8081/fjage/shell/ws [GroovyScriptEngine]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first entry starting with <code>tcp://</code> is the API connector available over TCP/IP. The IP address and port number in this case are <code>192.168.1.9</code> and <code>1102</code> respectively. The IP address on your setup might differ, so remember to replace it in the example code below when you try it.</p>
</div>
<div class="paragraph">
<p>To connect to UnetStack from a Groovy application, typical code might look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.unet.api.UnetSocket</span>

<span class="kt">def</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UnetSocket</span><span class="o">(</span><span class="s1">'192.168.1.9'</span><span class="o">,</span> <span class="mi">1102</span><span class="o">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="c1">// do things with sock here</span>
<span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that the <code>def</code> is typically not used in the shell, as we usually want the <code>sock</code> variable to be created in the shell&#8217;s context. However, we use <code>def</code> in Groovy scripts or closures to keep the <code>sock</code> variable in the local context.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
External applications interact with UnetStack via a UnetSocket API using fjåge&#8217;s connector framework. This allows the API to access UnetStack over a TCP/IP connection, a serial port, or any other fjåge connector that may be available.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code in other languages looks similar. For example, in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">unetpy</span> <span class="kn">import</span> <span class="n">UnetSocket</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">UnetSocket</span><span class="p">(</span><span class="s">'192.168.1.9'</span><span class="p">,</span> <span class="mi">1102</span><span class="p">)</span>
<span class="c1"># do things with sock here
</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple example application in Python using the UnetSocket API was illustrated previously in <a href="#_sending_receiving_from_a_python_application">Section 2.5</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending_data">9.2. Sending data</h3>
<div class="paragraph">
<p>To send datagrams using a socket, we first specify the destination address and protocol number using the <code>connect()</code> method, and then use the <code>send()</code> method to send data (byte array). In Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">to</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">host</span><span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>              <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">sock</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>                  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">sock</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s1">'hello!'</span> <span class="k">as</span> <span class="kt">byte</span><span class="o">[])</span>        <i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">sock</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s1">'more data!'</span> <span class="k">as</span> <span class="kt">byte</span><span class="o">[])</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Resolve node name to address. If the destination address is already known, this step can be skipped.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Connect using protcol 0 (generic data). Constant <code>org.arl.unet.Protocol.DATA</code> may be used instead of 0 for improved readability.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Data has to be converted into a <code>byte[]</code> for transmission using the <code>send()</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If only a single <code>send()</code> is desired, the <code>connect()</code> call may be omitted and the destination and protocol number can be provided as parameters to <code>send()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">sock</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s1">'hello!'</span> <span class="k">as</span> <span class="kt">byte</span><span class="o">[],</span> <span class="n">to</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_receiving_data">9.3. Receiving data</h3>
<div class="paragraph">
<p>On the receiving end, we specify the protocol number to listen to using <code>bind()</code>, and then receive a datagram using the <code>receive()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">sock</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">receive</span><span class="o">()</span>
<span class="n">println</span><span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="n">rx</span><span class="o">.</span><span class="na">to</span><span class="o">,</span> <span class="n">rx</span><span class="o">.</span><span class="na">data</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unbound sockets listen to all unreserved protocols. So the <code>bind()</code> call above could be skipped, if we would like to listen to all application datagrams.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>receive()</code> method above is blocking by default. The blocking behavior can be controlled using the <code>setTimeout()</code> method, where the blocking timeout can be specified in milliseconds. A timeout of 0 makes the call non-blocking. If no message is available at timeout, a <code>null</code> value is returned. When the <code>receive()</code> call is blocked, a call to <code>cancel()</code> can unblock and cause the <code>receive()</code> call to return immediately.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_setting_parameters">9.4. Getting &amp; setting parameters</h3>
<div class="paragraph">
<p>You have already been introduced to agent parameters in <a href="#_unetstack_basics">Chapter 3</a>. Applications can obtain information about an agent by reading its parameters, and can control the behavior of the agent by modifying its parameters.</p>
</div>
<div class="paragraph">
<p>To access agent parameters, you first have to look up the relevant agent based on its name or a service that it provides. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">agentForService</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">arl</span><span class="o">.</span><span class="na">unet</span><span class="o">.</span><span class="na">Services</span><span class="o">.</span><span class="na">PHYSICAL</span><span class="o">)</span>   <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">println</span><span class="o">(</span><span class="n">phy</span><span class="o">.</span><span class="na">MTU</span><span class="o">)</span>
<span class="n">println</span><span class="o">(</span><span class="n">phy</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">dataRate</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Looking up an agent based on a services it provides is recommended, rather than specify the agent by name. We will explore services in more detail in <a href="#_services_and_capabilities">Chapter 12</a>. However, if you wished to reference an agent by name, you could have done that as: <code>def phy = sock.agent('phy')</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will print the value of parameter <code>MTU</code> (maximum transfer unit) of the physical layer, and the physical layer <code>dataRate</code> of the CONTROL (1) channel. You could also change some of the parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">println</span><span class="o">(</span><span class="n">phy</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">frameLength</span><span class="o">)</span>
<span class="n">phy</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">frameLength</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">println</span><span class="o">(</span><span class="n">phy</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">frameLength</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Developers may wish to consider using constants <code>org.arl.unet.phy.Physical.CONTROL</code> and <code>org.arl.unet.phy.Physical.DATA</code> instead of hard coding 1 and 2, for readability.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>phy</code> object that you received back from <code>sock.agentForService()</code> or <code>sock.agent()</code> is an <code>AgentID</code>. You can think of this as a reference to the agent. Setting and getting parameters on the agent ID sends <code>ParameterReq</code> messsages to the agent to read/modify the relevant parameters. You can also use agent IDs to send messages to the agent explicitly, as you will see next.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_agent_services">9.5. Accessing agent services</h3>
<div class="paragraph">
<p>As we have already seen in <a href="#_interacting_with_agents_using_messages">Section 3.2</a>, the full functionality of UnetStack can be harnessed by sending/receiving messages to/from various agents in the stack. We earlier saw how to do that from the shell. We now look at how to use the UnetSocket API to send/receive messages to/from agents.</p>
</div>
<div class="paragraph">
<p>To request broadcast of a CONTROL frame, like we did before from the shell, we need to lookup the agent providing the PHYSICAL service and send a <code>TxFrameReq</code> to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.unet.phy.TxFrameReq</span>

<span class="kt">def</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">agentForService</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">arl</span><span class="o">.</span><span class="na">unet</span><span class="o">.</span><span class="na">Services</span><span class="o">.</span><span class="na">PHYSICAL</span><span class="o">)</span>
<span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For lower level transactions, we obtain a fjåge Gateway instance from the UnetSocket API, and use it directly. For example, we can subscribe to event notifications from the physical layer and print them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">gw</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">gateway</span>
<span class="n">gw</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">phy</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="mi">10000</span><span class="o">)</span>     <i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="n">println</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Receive a message from the gateway with a timeout of 10000 ms. If no message is received during this period, <code>null</code> is returned.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_python_and_other_languages">9.6. Python and other languages</h3>
<div class="paragraph">
<p>In Groovy and Java, services, parameters and messages are defined using enums and classes. These are made available to the client application by putting the relevant jars in the classpath. In other languages (e.g. Python, Julia, Javascript), services and parameters are simply referred to as strings with fully qualified names (e.g. <code>'org.arl.unet.Services.PHYSICAL'</code>). Messages are represented by dictionaries, but have to be declared before use.</p>
</div>
<div class="paragraph">
<p>For example, in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">unetpy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">UnetSocket</span><span class="p">(</span><span class="s">'192.168.1.9'</span><span class="p">,</span> <span class="mi">1102</span><span class="p">)</span>
<span class="n">phy</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">agentForService</span><span class="p">(</span><span class="n">Services</span><span class="o">.</span><span class="n">PHYSICAL</span><span class="p">)</span>
<span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="n">TxFrameReq</span><span class="p">()</span>
<span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you recall from <a href="#_sending_receiving_from_a_python_application">Section 2.5</a>, <code>from</code> is a keyword in Python and so the <code>from</code> field in messages is replaced by <code>from_</code>. Other than this minor change, the fields in all the Python message classes are the same as the Java/Groovy versions.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_portals">10. Portals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although the UnetSocket API provides great flexibility, it requires an application to explicity use the API to integrate with UnetStack. Sometimes you might have devices or applications that talk to each other over a serial cable or a UDP/IP or TCP/IP connection, and you simply want to replace the cable or connection with an underwater wireless connection. Is there an easier way for such simple Internet or serial port applications to communicate over a Unet?</p>
</div>
<div class="paragraph">
<p>The answer lies in portals. A <em>portal</em> is a transparent connection across the Unet. Data going in through one end of the portal travels through the Unet and emerges from the other end. The interaction with the end points of the portal is via traditional technologies such as UDP/IP sockets, TCP/IP sockets, or serial ports. This enables applications developed to use these technologies to transparently work over a Unet.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Application examples</div>
<div class="paragraph">
<p>Imagine that you have a sensor that connects to a laptop over a RS232 serial cable. You want to deploy this sensor on the seabed and have its data be available wirelessly over the Internet in real time. All you want to do is replace that RS232 cable with a wireless Unet connection. A <em>serial portal</em> could be used for this. Instead of a RS232 serial cable, maybe the sensor published its data over an Ethernet cable on a TCP/IP port. You&#8217;d use a <em>TCP portal</em> instead.</p>
</div>
<div class="paragraph">
<p>In <a href="#_video_streaming_using_udp_portal">Section 10.2</a>, we demonstrate a practical example of a video streaming application that runs over UDP, and can be made to transparently work over a Unet using the <em>UDP portal</em>.</p>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
While portals are easy to use, you should bear in mind that applications developed for the Internet or for use over serial ports do not understand the constraints and characteristics of a Unet. Some applications may use bandwidth inefficiently, or expect responses with latencies that are unreasonable for a Unet, and therefore perform poorly.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_udp_portal">10.1. UDP portal</h3>
<div class="paragraph">
<p>Since UDP is a datagram-oriented protocol, it is easy to map UDP datagrams to Unet datagrams. This is exactly what a UDP portal does, as shown in <a href="#fig_udp_portal">Figure 6</a>.</p>
</div>
<div class="paragraph">
<p>In this example, application X sends a UDP datagram to node A, where a UdpPortal agent listens on UDP port 7000 (arbitrarily chosen port number). The UdpPortal agent converts the UDP datagram into a Unet datagram and sends it to node B. The UdpPortal agent on node B receives this datagram, converts is back to a UDP datagram and sends it to application Y listening on UDP port 7778 (also an arbitrarily chosen port number).</p>
</div>
<div id="fig_udp_portal" class="imageblock">
<div class="content">
<img src="images/udp-portal.png" alt="udp portal">
</div>
<div class="title">Figure 6. A UDP portal establishes a tunnel through the Unet for UDP datagrams to pass through.</div>
</div>
<div class="paragraph">
<p>Let us emulate this example with our favorite 2-node network. Fire up the 2-node network simulation, as before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet samples/2-node-network.groovy

2-node network
<span class="nt">--------------</span>

Node A: tcp://localhost:1101, http://localhost:8081/
Node B: tcp://localhost:1102, http://localhost:8082/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open browser windows for shell access to each of the nodes. On node A, create a UdpPortal listening on port 7000 (since application X will send UDP datagrams to this port) and sending Unet datagrams (protocol 0 in this example, but that can be configured using the <code>protocol</code> parameter below) to node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'portal'</span>, new org.arl.unet.portal.UdpPortal<span class="o">(</span>port:7000, peer:host<span class="o">(</span><span class="s1">'B'</span><span class="o">))</span><span class="p">;</span>
<span class="gp">&gt;</span> portal
<span class="gp">&lt;&lt;&lt; UdpPortal &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 1500

[org.arl.unet.portal.UdpPortalParam]
  clientIP = 255.255.255.255
  clientPort = 7778
  link = uwlink
  peer = 31
  port = 7000
  priority = NORMAL
  protocol = 0
  reliability = false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default <code>port</code> and <code>clientPort</code> for the UdpPortal are arbitrarily chosen to be 7777 and 7778 respectively. You can easily change them during creation of the UdpPortal, as we did above, or later, by setting the relevant parameter.</p>
</div>
<div class="paragraph">
<p>On node B, create the other end-point of the UDP portal to send the UDP datagrams to <code>localhost</code> UDP port 7778, where you will run application Y:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'portal'</span>, new org.arl.unet.portal.UdpPortal<span class="o">(</span>clientIP: <span class="s1">'localhost'</span>, clientPort: 7778<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> portal
<span class="gp">&lt;&lt;&lt; UdpPortal &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 1500

[org.arl.unet.portal.UdpPortalParam]
  clientIP = localhost
  clientPort = 7778
  link = uwlink
  peer = 0
  port = 7777
  priority = NORMAL
  protocol = 0
  reliability = false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it, your UDP portal is set up! Time to test it out!!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To test the UDP portal (and later, the TCP portal), we will use <code>netcat</code> or <code>nc</code>. If you don&#8217;t have this installed on your machine, now would be a good time to go download and install it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open a terminal window on your machine and set up a simple UDP server listening on port 7778 (application Y):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc <span class="nt">-u</span> <span class="nt">-l</span> 7778</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open another terminal window and set up a simple UDP client to send text datagrams to port 7000 (application X). Assuming your IP address is <code>192.168.1.9</code>, you can do this using the command shown below. Type a text message and press ENTER.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc <span class="nt">-u</span> 192.168.1.9 7000
hello                             <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type your text message "hello" followed by ENTER.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a few seconds, you should see that text message appearing on application Y terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc <span class="nt">-u</span> <span class="nt">-l</span> 7778                   <i class="conum" data-value="1"></i><b>(1)</b>
hello                             <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You had already typed this in earlier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Your text message "hello" appears here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The text message went through the Unet to get there!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may need to use the IP address of your machine (e.g. <code>192.168.1.9</code>) for the UDP connection to send the text message, rather than <code>localhost</code>. This is because the UdpPortal binds to the default network interface, and not to the loopback network interface.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_video_streaming_using_udp_portal">10.2. Video streaming using UDP portal</h3>
<div class="paragraph">
<p>You can do some cool things once you have set up the UDP portal. Here&#8217;s one real-life example:</p>
</div>
<div class="paragraph">
<p>Say, you wanted to stream video through the Unet. If you have <code>ffmpeg</code> installed, you can set up a UDP video client listening on port 7778:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>ffplay udp://192.168.1.9:7778</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you can stream a video (<code>movie.m4v</code>) over UDP to port 7000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>ffmpeg <span class="nt">-re</span> <span class="nt">-i</span> movie.m4v <span class="nt">-an</span> <span class="nt">-s</span> cif <span class="nt">-r</span> 6 <span class="nt">-c</span>:v libx264 <span class="nt">-b</span>:v 15k <span class="nt">-f</span> mpegts udp://192.168.1.7:7000?pkt_size<span class="o">=</span>512</code></pre>
</div>
</div>
<div class="paragraph">
<p>The various flags control the quality, frame rate, and encoding of the video, and the <code>pkt_size</code> option controls the size of the datagrams sent.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>ffmpeg</code> flags need to be adjusted to suit your Unet (read the <code>ffmpeg</code> documentation!). You need to ensure that the links in the Unet can support the data rates needed for this video, based on the flags you select. We have demonstrated real-time video with a high-speed acoustic underwater link with data rates of about 40 kbps.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tcp_portal">10.3. TCP portal</h3>
<div class="paragraph">
<p>A TCP portal is set up using the Portal agent. The Portal agent is quite similar to the UdpPortal agent, but provides more flexibility through the fjåge connectors framework. We can use a TCP connector for our TCP portal.</p>
</div>
<div class="paragraph">
<p>Restart your 2-node network, and on node A set up a TCP portal listening on port 7000:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'portal'</span>, new org.arl.unet.portal.Portal<span class="o">(</span>7000<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> portal
<span class="gp">&lt;&lt;&lt; Portal &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 128

[org.arl.unet.portal.PortalParam]
  delimiters = [10, 13]
  link = uwlink
  peer = 0
  priority = NORMAL
  protocol = 0
  reliability = false
  timeout = 1000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On node B, create the other end-point of the TCP portal listening on port 7001:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'portal'</span>, new org.arl.unet.portal.Portal<span class="o">(</span>7001<span class="o">)</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it, your TCP portal is set up! Time to test it out!!</p>
</div>
<div class="paragraph">
<p>Open a terminal window on your machine and connect over TCP/IP to node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc localhost 7000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open another terminal window and connect over TCP/IP to node B. Type a text message and press ENTER.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc localhost 7001
hello                             <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type in your text message "hello", and press ENTER.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a few seconds, you should see that text message appearing on the TCP/IP connection to node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nc localhost 7000               <i class="conum" data-value="1"></i><b>(1)</b>
hello                             <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You had already typed this in above.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Your text message "hello" appears here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The text message went through the Unet to get there!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The TCP portal is bidirectional, so you can type something on node A, and you should see it appear on node B. The UDP portal in <a href="#_udp_portal">Section 10.1</a> can also be set up as bidirectional by carefully configuring the <code>peer</code>, <code>port</code>, and <code>clientPort</code> parameters at both end-points.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_serial_portal">10.4. Serial portal</h3>
<div class="paragraph">
<p>Since the Portal agent uses the fjåge connectors framework, it can easily work with any type of connector. Since fjåge provides a serial port connecor, we can easily set up a serial portal on each of your nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'portal'</span>, new org.arl.unet.portal.Portal<span class="o">(</span><span class="s1">'/dev/ttyS0'</span>, 9600, <span class="s1">'N81'</span><span class="o">)</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since many modern computers do not have serial ports, you may not be able to test the above code on your computer. If you have underwater modems with serial ports, you&#8217;ll need to replace the device name (<code>/dev/ttyS0</code>) with the appropriate serial port device name to run this code. You can also customize the serial port baud rate (<code>9600</code>) and settings (<code>N81</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once you have the serial portal set up on all nodes, you can connect to the node&#8217;s serial port using a serial terminal application (e.g. <code>minicom</code>) and type text messages just like you did with <code>nc</code> during the TCP portal test.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_at_script_engine">11. AT script engine</h2>
<div class="sectionbody">
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The UnetSocket API (<a href="#_unetsocket_api">Chapter 9</a>) is the recommended way to integrate applications with UnetStack. The AT script engine is only provided for legacy system support, and its use should be avoided in modern systems, as they suffer from several drawbacks (serialized interaction, error prone parsing, limited flexibility, lack of scripting support, etc.)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The AT command interpreter provides support for legacy applications that prefer to interact with UnetStack using AT text commands. All AT commands begin on a fresh line with an <code>AT</code> prefix, and end with a new line (CR or LF). Spaces and other whitespace characters are considered significant. Lines without the <code>AT</code> command prefix are silently ignored and may be used as a comment in AT command files. All AT commands are case-insensitive, with the exception of Java class names and parameter names in the <code>AT~EXT</code> and <code>AT~MSG</code> commands.</p>
</div>
<div class="paragraph">
<p>A successful response to an AT command may span several lines of text followed by an <code>OK</code> to mark the end of the response. If the AT command is unsuccessful, an <code>ERROR</code> response is returned. The <code>OK</code> or <code>ERROR</code> response is also terminated by a new line (CR or LF).</p>
</div>
<div class="paragraph">
<p>Unsolicited notifications may be sent by the AT command interpreter to the user. Responses and notifications are atomic, and lines from each may not be interleaved in the other.</p>
</div>
<div class="paragraph">
<p>We describe the AT command set through examples below. The convention used in describing commands is that the command is in uppercase. Lowercase words denote parameters in the command, to be replaced by the user with appropriate values. Optional parts of the command are denoted by [&#8230;&#8203;].</p>
</div>
<div class="sect2">
<h3 id="_starting_the_at_command_interpreter">11.1. Starting the AT command interpreter</h3>
<div class="paragraph">
<p>The AT command interpreter is available as a script engine that can be loaded using a shell agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> conn <span class="o">=</span> new org.arl.fjage.connectors.TcpHubConnector<span class="o">(</span>5001, <span class="nb">false</span><span class="o">)</span>        <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">&gt;</span> cshell <span class="o">=</span> new org.arl.fjage.shell.ConsoleShell<span class="o">(</span>conn, <span class="nb">true</span><span class="o">)</span>
<span class="gp">&gt;</span> shell <span class="o">=</span> new ShellAgent<span class="o">(</span>cshell, new org.arl.unet.shell.ATScriptEngine<span class="o">())</span>
<span class="gp">&gt;</span> shell.addInitrc <span class="s1">'etc/atshrc.atc'</span>                                        <i class="conum" data-value="2"></i><b>(2)</b>
<span class="gp">&gt;</span> container.add <span class="s1">'at'</span>, shell</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The AT command interpreter is exposed over a TCP/IP connection on port 5001. The <code>conn</code> could easily be replaced by another type of connection (e.g. RS232 port), if desired.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We added an initalization file <code>etc/atshrc.atc</code> in this example, so that some AT commands can automatically be run on startup.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_basic_at_commands">11.2. Basic AT commands</h3>
<div class="paragraph">
<p>A small set of basic AT commands are honored by the interpreter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT</code>&#8201;&#8212;&#8201;check if a command link is active:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ATE0</code>/<code>ATE1</code>&#8201;&#8212;&#8201;turn off/on echo:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">ATE1
OK
AT
AT
OK
ATE0
ATE0
OK
AT
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ATZ</code>&#8201;&#8212;&#8201;shutdown/reboot</p>
</li>
<li>
<p><code>AT/</code>&#8201;&#8212;&#8201;repeat last AT command</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_shell_extensions">11.3. Shell extensions</h3>
<div class="paragraph">
<p>The interpreter can be customized using shell extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~EXT=classname</code>&#8201;&#8212;&#8201;load shell extension</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fields and methods exposed by a shell extension are made available in a shell using this command. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PLVL
ERROR
AT~EXT=org.arl.unet.phy.PhysicalShellExt
OK
AT~PLVL
PHY/1.POWERLEVEL=-10.0
PHY/2.POWERLEVEL=-10.0
PHY/3.POWERLEVEL=-10.0
PHY/4.POWERLEVEL=-10.0
PHY.SIGNALPOWERLEVEL=-10.0
OK
AT~PLVL=-3
OK
AT~PLVL
PHY/1.POWERLEVEL=-3.0
PHY/2.POWERLEVEL=-3.0
PHY/3.POWERLEVEL=-3.0
PHY/4.POWERLEVEL=-3.0
PHY.SIGNALPOWERLEVEL=-3.0
OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameters to methods are specified as a comma-separated list after the <code>=</code> symbol in the command (e.g. <code>-3</code> in <code>AT~PLVL=-3</code>). The parameters may be numeric (<code>int</code>, <code>long</code>, <code>float</code> or <code>double</code>), <code>boolean</code> represented by <code>0</code> or <code>1</code> as <code>false</code> and <code>true</code> respectively, or double-quoted strings (e.g. <code>"this is a string"</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_agent_parameter_access_commands">11.4. Agent parameter access commands</h3>
<div class="paragraph">
<p>Agent parameters may be listed, read and written to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~agent[/index]?</code>&#8201;&#8212;&#8201;list parameters:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PHY?
PHY.SIGNALPOWERLEVEL=-10.0
PHY.RXENABLE=1
PHY.MAXPOWERLEVEL=0.0
PHY.MINPOWERLEVEL=-138.0
PHY.NOISE=-71.9
PHY.MTU=13
PHY.FULLDUPLEX=1
PHY.BUSY=0
PHY.RTC="Tue Jul 23 02:19:39 SGT 2019"
OK
AT~PHY/1?
PHY/1.FRAMELENGTH=18
PHY/1.FEC=3
PHY/1.MTU=13
PHY/1.DATARATE=52.554745
PHY/1.FRAMEDURATION=2.74
PHY/1.MODULATION="fhbfsk"
PHY/1.POWERLEVEL=-10.0
PHY/1.VALID=1
PHY/1.THRESHOLD=0.25
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~agent[/index].parameter?</code>&#8201;&#8212;&#8201;get parameter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PHY/1.FRAMELENGTH?
PHY/1.FRAMELENGTH=18
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~agent[/index].parameter=value</code>&#8201;&#8212;&#8201;set parameter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PHY/1.FRAMELENGTH=21
OK
AT~PHY/1.FRAMELENGTH?
PHY/1.FRAMELENGTH=21
OK</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_and_receiving_messages">11.5. Sending and receiving messages</h3>
<div class="paragraph">
<p>The command interpreter may make requests and receive message notification by defining the messages of interest and subscribing to appropriate topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~MSG:&lt;msg&gt;=&lt;classname&gt;:parameter[,parameter]&#8230;&#8203;</code>&#8201;&#8212;&#8201;define message format</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Message formats defined using this command are available for requests and also used for notifications. If a message is not defined, notifications of that message type are silently ignored. The following command defines a message <code>DRQ</code> of class <code>org.arl.unet.DatagramReq</code> with 3 parameters: <code>to</code>, <code>protocol</code> and <code>data</code> in that order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~MSG:DRQ=org.arl.unet.DatagramReq:to,protocol,data
OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also define other messages similarly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~MSG:TXNTF=org.arl.unet.phy.TxFrameNtf:type,txTime
OK
AT~MSG:RXNTF=org.arl.unet.phy.RxFrameNtf:from,to,protocol,rxTime,data
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~agent&lt;msg=parameter[,parameter]&#8230;&#8203;</code>&#8201;&#8212;&#8201;make a request</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once we have defined the messages above, we can make a request to <code>PHY</code> to send a datagram to node 2 with protocol 0 and 3 bytes of data: <code>[1,2,3]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PHY&lt;DRQ=2,0,"010203"
OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The notification for the datagram transmission completion will be displayed as an unsolicited notification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">~PHY&gt;</span><span class="nv">TXNTF</span><span class="o">=</span>2,1994962099</code></pre>
</div>
</div>
<div class="paragraph">
<p>The general notifications format as: <code>~agent&gt;msg=parameter[,parameter]&#8230;&#8203;</code>. If any of the parameters are <code>byte[]</code> or <code>float[]</code>, they are not included in the parameter list. Instead a colon (<code>:</code>) is added at the end of the line, and the data in hex follows on subsequent lines. Once the data ends, a period (<code>.</code>) is sent on a single line. If multiple parameters are arrays, the number of array parameters is given by the number of colons at the end of the line, and each array is terminated by a period, followed by the next array. An example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">~PHY&gt;</span><span class="nv">RXNTF</span><span class="o">=</span>1,0,0,2095058353:
<span class="go">0102030405060708090A0B0C0D0E0F
1112131415161718191A1B1C1D1E1F
</span><span class="c">.</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~SUB=topic[,subtopic]</code>&#8201;&#8212;&#8201;subscribe to a topic</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Without subscribing to a topic, we see that the user is not notified about the reception of a frame, although the message type is already defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~PHY.FULLDUPLEX=1
OK
AT~PHY&lt;DRQ=0,0,"010203"
OK
</span><span class="gp">~PHY&gt;</span><span class="nv">TXNTF</span><span class="o">=</span>2,2095026099</code></pre>
</div>
</div>
<div class="paragraph">
<p>After subscribing to <code>PHY</code>, the received message is reported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~SUB=PHY
OK
AT~PHY&lt;DRQ=0,0,"010203"
OK
</span><span class="gp">~PHY&gt;</span><span class="nv">TXNTF</span><span class="o">=</span>2,2095026099
<span class="gp">~PHY&gt;</span><span class="nv">RXNTF</span><span class="o">=</span>1,0,0,2095058353:
<span class="go">010203
</span><span class="c">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we see that the data from the <code>RXNTF</code> is included after the notification message as a <strong>data block</strong>. This is the case for all <code>byte[]</code> or <code>float[]</code> parameters. Each data block may span several lines, and is terminated by a period (<code>.</code>) on a line by itself. The number of data blocks to follow a notification is denoted by the number of colons (<code>:</code>) at the end of a notification.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~UNSUB=topic[,subtopic]</code>&#8201;&#8212;&#8201;unsubscribe from a topic:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~UNSUB=PHY
OK
AT~PHY&lt;DRQ=0,0,"010203"
OK
</span><span class="gp">~PHY&gt;</span><span class="nv">TXNTF</span><span class="o">=</span>2,2095026099</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_managing_the_data_buffer">11.6. Managing the data buffer</h3>
<div class="paragraph">
<p>While data may be directly included in a request message, sometimes it is useful to load data into a data buffer first, and then use it multiple times for requests. This is managed using the following commands:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~DATA:</code>&#8201;&#8212;&#8201;load data buffer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Data is represented as a series of hexadecimal bytes, and may span many lines. Data entry is terminated by a period (<code>.</code>) on a line by itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~DATA:
010203
040506
</span><span class="c">.
</span><span class="go">OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above representation is convenient for <code>byte[]</code> parameters. However, the same representation is used for other data arrays, including <code>float[]</code>, where the IEEE floating point representation is used for the floating point number to be converted to a series of bytes.</p>
</div>
<div class="paragraph">
<p>An alternative data representation is useful for <code>float[]</code>, where the floating point numbers are directly specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~DATA:
1.54
0.78
5.92
2.00
</span><span class="c">.
</span><span class="go">OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For this representation, it is necessary to have a decimal place (<code>.</code>) in each number, and each line to contain only one floating point number.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~DATA?</code>&#8201;&#8212;&#8201;check size of data buffer:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~DATA:
010203
040506
</span><span class="c">.
</span><span class="go">OK
AT~DATA?
6 bytes
OK</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AT~CLRDATA</code>&#8201;&#8212;&#8201;clear data buffer:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~CLRDATA
OK
AT~DATA?
EMPTY
OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use the data buffer, we simply use <code>"DATA"</code> instead of the hexadecimal data in a message. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">AT~SUB=PHY
OK
AT~DATA:
010203
040506
</span><span class="c">.
</span><span class="go">OK
AT~PHY&lt;DRQ=0,0,"DATA"
OK
</span><span class="gp">~PHY&gt;</span><span class="nv">TXNTF</span><span class="o">=</span>2,3738882099
<span class="gp">~PHY&gt;</span><span class="nv">RXNTF</span><span class="o">=</span>1,0,0,3738925936:
<span class="go">010203040506
</span><span class="c">.</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="_part_iv_understanding_unetstack_services" class="sect0"><strong>Part IV: Understanding UnetStack services</strong></h1>
<div class="sect1">
<h2 id="_services_and_capabilities">12. Services and capabilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far you&#8217;ve interacted with agents, checking and changing agent parameters, and sending and receiving messages. But how do you know which agents to send what messages to, and what agents support which parameters? The answer to this question lies in the concept of <em>services</em>.</p>
</div>
<div class="sect2">
<h3 id="_terminology">12.1. Terminology</h3>
<div class="paragraph">
<p>To fully understand services, we need to formally define a few terms, many of which you are already somewhat familiar with:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Agent</dt>
<dd>
<p>An agent is logical entity that implements a specific functionality of the network. Loosely, an agent maps to a layer in a traditional network stack, but is more flexible. Each agent has its own thread of execution, and all agents can be thought of as running concurrently. An agent is normally referenced using its <em>AgentID</em>. You may think of an AgentID as the name of an agent, or a reference to the agent.</p>
</dd>
<dt class="hdlist1">Message</dt>
<dd>
<p>Agents interact with each other via messages. Agents can send and receive messages, and typically expose all their functionality as a set of messages that they will respond to. Messages are transmitted within the network stack on a node, and not between nodes in the network. Each message is tagged with a <em>performative</em> that summarizes the purpose of the message. Common performatives are <code>REQUEST</code>, <code>AGREE</code>, <code>REFUSE</code>, <code>FAILURE</code>, <code>NOT_UNDERSTOOD</code> and <code>INFORM</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is easy to confuse messages, datagrams and frames. Messages are used by agents on a node to interact with other agents on the same node. They are never transmitted! Datagrams are logical packets of data that are exchanged between nodes. Datagrams may be fragmented and reassembled, and thus one datagram does not necessarily map to one transmission. Physical layer datagrams are called frames; they form the basic unit of data exchanged between nodes.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Request</dt>
<dd>
<p>Request messages ask an agent to perform some task. Such messages are marked with the performative <code>REQUEST</code>, and it is a convention to name the message class with a suffix <code>Req</code> (e.g. <code>DatagramReq</code>, <code>ParameterReq</code>).</p>
</dd>
<dt class="hdlist1">Response</dt>
<dd>
<p>When an agent receives a request, it must respond back to the requesting agent. Common responses are simply messages with the performative set to <code>AGREE</code>, <code>REFUSE</code>, <code>FAILURE</code> or <code>NOT_UNDERSTOOD</code>. An <code>AGREE</code> message confirms to the requester that the agent will perform the requested task. A <code>REFUSE</code> message tells the requester that the request cannot be performed. A <code>FAILURE</code> message, on the other hand, means that the agent should have been able to do the request under normal circumstances, but something went wrong. A <code>NOT_UNDERSTOOD</code> response is generated if the agent does not know how to deal with the request. Other than these simple messages, responses may sometimes contain more information. Such messages are respresented by message classes with a suffix <code>Rsp</code> (e.g. <code>ParameterRsp</code>), and may have a performative of <code>INFORM</code> to indicate that they contain information in response to the request.</p>
</dd>
<dt class="hdlist1">Notification</dt>
<dd>
<p>Agents sometimes generate unsolicited information. This information is encapsulated in a notification message, typically with a performative <code>INFORM</code>. Notification messages may be sent to a specific agent, or on a topic.</p>
</dd>
<dt class="hdlist1">Topic</dt>
<dd>
<p>A topic defines a publish-subscribe mechanism where an agent may publish some notifications, and other agents interested in those notifications may <em>subscribe</em> to the topic. Most agents have an unnamed topic associated with themselves, that other agents can subscribe to. For example, a link agent may subscribe to the topic of a physical layer agent to listen for incoming data frames from the physical layer.</p>
</dd>
<dt class="hdlist1">Parameters</dt>
<dd>
<p>Most UnetStack agents publish a number of parameters associated with them. Parameters are key-value pairs that provide information about the agent (read-only parameters), or allow controlling the behavior of the agent (read-write parameters). Parameters are technically accessed via <code>ParameterReq</code> and <code>ParameterRsp</code> messages, but a simpler notation (<code>agent.parameter</code>) is also available to get/set parameters.</p>
</dd>
<dt class="hdlist1">Service</dt>
<dd>
<p>A service is a collection of messages (requests, responses and notifications) and parameters that an agent honors. Agents publish the list of services they offer, and you can find agents through the services they advertise.</p>
</dd>
<dt class="hdlist1">Capability</dt>
<dd>
<p>Services often define optional capabilities. These capabilities may be offered by some agents advertising a service, but may be omitted by others. An agent can be queried to check if it supports a specific capability using the <code>CapabilityReq</code> message.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If all of these terms pique your curiosity, you may wish to take a look at the <a href="https://fjage.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">fjåge documentation</a>. fjåge is the underlying agent framework that UnetStack is built on. While we don&#8217;t assume familiarity with fjåge in this handbook, your understanding of UnetStack would certainly be quicker if you were to invest in building that familiarity.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_finding_service_providers">12.2. Finding service providers</h3>
<div class="paragraph">
<p>In <a href="#_accessing_agent_services">Section 9.5</a>, we have already come across the <code>agentForService()</code> function that helps us find an agent that provides a specific service. In this section, we&#8217;ll explore this a bit more.</p>
</div>
<div class="paragraph">
<p>Fire up your trusty 2-node network and connect to node A&#8217;s shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> a <span class="o">=</span> agentForService<span class="o">(</span>org.arl.unet.Services.PHYSICAL<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> a.name
<span class="go">phy</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We asked for an agent that provides the <code>org.arl.unet.Services.PHYSICAL</code> service, and UnetStack responded back with an agent ID of an agent that can provide you that service. The name of that agent on node A is <code>phy</code>.</p>
</div>
<div class="paragraph">
<p>But what if there were more than one agents capable of providing the same service? We can ask for the list of all agents that provide a service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.PHYSICAL<span class="o">)</span>
<span class="go">[phy]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Well, there was only one agent providing the PHYSICAL service. Are there other services that multiple agents provide? Indeed, there are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.DATAGRAM<span class="o">)</span>
<span class="go">[transport, router, uwlink, phy]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DATAGRAM service is provided by several agents. If you were interested in all incoming datagrams, you&#8217;d need to subscribe to the topics of all these agents!</p>
</div>
<div class="paragraph">
<p>What would have happened if you only asked for <code>agentForService()</code> instead of <code>agentsForService()</code> for the DATAGRAM service? Try it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> a <span class="o">=</span> agentForService<span class="o">(</span>org.arl.unet.Services.DATAGRAM<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> a.name
<span class="go">transport</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any one of the agents in the list is returned!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Ever wondered what we assigned the <code>a = agentForService(&#8230;&#8203;)</code>, and then asked for <code>a.name</code> to see the name of the agent?<br>
<br>
When you try to print an AgentID object on the shell, the shell tries to be helpful and queries the agent for all its parameters and displays them. In this case, we were only interested in the name and not all the parameters, so we asked the shell not to get the parameters by explicitly asking for just <code>a.name</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_checking_capabilities">12.3. Checking capabilities</h3>
<div class="paragraph">
<p>So let&#8217;s say you looked up the list of agents that provide the DATAGRAM service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.DATAGRAM<span class="o">)</span>
<span class="go">[transport, router, uwlink, phy]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wanted to send a datagram, how do you pick which one you&#8217;d rather use? Different agents may provide different optional capabilities. If you were specifically interested in a particular capability (e.g. reliability), you could ask the agent if it supported that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> CapabilityReq(org.arl.unet.DatagramCapability.RELIABILITY)
</span><span class="go">DISCONFIRM
</span><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> CapabilityReq(org.arl.unet.DatagramCapability.RELIABILITY)
</span><span class="go">CONFIRM</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we asked <code>phy</code> if it can do reliable datagram delivery, and it said "no". Then we asked <code>uwlink</code>, and it confirmed that it can. If you needed reliable delivery of our datagram, you should choose the latter.</p>
</div>
<div class="paragraph">
<p>You can also ask an agent to list all its optional capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> transport <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> CapabilityReq()
</span><span class="go">CapabilityListRsp:INFORM[PROGRESS,RELIABILITY,FRAGMENTATION,CANCELLATION]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>transport</code> agent says it can do reliable datagram delivery, fragment &amp; reassemble large datagrams (if necessary), report on the progress of large datagram transfers, and cancel datagram delivery half way through the process (if the user wishes to).</p>
</div>
<div class="paragraph">
<p>Another way you may choose a service provider is by checking its parameters. For example, the <code>MTU</code> parameter (defined in the DATAGRAM service) tells you what is the largest datagram the agent can deliver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy.MTU
<span class="go">56
</span><span class="gp">&gt;</span> uwlink.MTU
<span class="go">3145632</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you had a small datagram (56 bytes or less) to deliver, and you did not care about reliability, you could ask <code>phy</code> to deliver it for you. But, if your datagram was larger, even if you did not need reliability, you&#8217;d have to ask <code>uwlink</code> to deliver it for you.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>MTU</code> parameter is the DATAGRAM service is actually <code>org.arl.unet.DatagramParam.MTU</code>. Since we only have one <code>MTU</code> parameter that <code>phy</code> advertises, there is no ambiguity in using <code>phy.MTU</code>. But if you wanted to explicitly ask for the parameter by its fully qualified name, you could send a <code>ParameterReq</code> for it: <code>phy &lt;&lt; new ParameterReq().get(org.arl.unet.DatagramParam.MTU)</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_service_list">12.4. Service list</h3>
<div class="paragraph">
<p>The following services are currently defined in UnetStack:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Short name</th>
<th class="tableblock halign-left valign-top">Fully qualified name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Read&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATAGRAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.DATAGRAM</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send and receive datagrams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_datagram_service">Chapter 13</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PHYSICAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.PHYSICAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical layer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_physical_service">Chapter 14</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BASEBAND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.BASEBAND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arbitrary waveform transmission &amp; recording</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_baseband_service">Chapter 15</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RANGING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.RANGING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ranging &amp; synchronization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_ranging_and_synchronization">Chapter 16</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NODE_INFO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.NODE_INFO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node &amp; network information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_node_information">Chapter 17</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADDRESS_RESOLUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.ADDRESS_RESOLUTION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address allocation &amp; resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_address_resolution">Chapter 18</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LINK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.LINK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datagram transmission over a single hop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_single_hop_links">Chapter 20</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.MAC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium access control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_medium_access_control">Chapter 19</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROUTING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.ROUTING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Routing of datagrams over a multihop network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_routing_and_route_maintenance">Chapter 21</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROUTE_MAINTENANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.ROUTE_MAINTENANCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Discovery &amp; maintenance of routes in a multihop network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_routing_and_route_maintenance">Chapter 21</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRANSPORT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.TRANSPORT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datagram transmission over a multihop network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_transport_and_reliability">Chapter 22</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REMOTE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.REMOTE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote command execution, text messaging &amp; file transfer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_remote_access">Chapter 23</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATE_MANAGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.STATE_MANAGER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">State persistence across node reboots</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_state_persistence">Chapter 24</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCHEDULER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.unet.Services.SCHEDULER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sleep-wake scheduling for energy management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_scheduler">Chapter 25</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHELL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.arl.fjage.shell.Services.SHELL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commmand execution &amp; file management services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_shell">Chapter 26</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can enjoy reading more about these services in the next few chapters.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_datagram_service">13. Datagram service</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.DATAGRAM</strong></code></p>
</div>
<div class="paragraph">
<p>Unets are all about sending datagrams between nodes!</p>
</div>
<div class="paragraph">
<p>The DATAGRAM service is, therefore, one of the fundamental services that many agents provide. However, different agents have very different capabilities in terms of what they can do with datagrams. Let&#8217;s take a look at what the service offers, and how to use it effectively.</p>
</div>
<div class="sect2">
<h3 id="_overview">13.1. Overview</h3>
<div class="sect3">
<h4 id="_messages">13.1.1. Messages</h4>
<div class="sidebarblock">
<div class="content">
<div class="title">Notation guide</div>
<div class="paragraph">
<p>Every request message requires a response. When describing request messages, we also specify what responses to expect, through the notation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>request message</em> &#8658; <em>possible response messages</em>&#8201;&#8212;&#8201;<em>short description</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the other hand, notification messages do not have corresponding responses, so we only describe them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>notification message</em>&#8201;&#8212;&#8201;<em>short description</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Agents offering the DATAGRAM service support messages to transmit and receive datagrams:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramReq.html" target="_blank" rel="noopener"><code>DatagramReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code></p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramNtf.html" target="_blank" rel="noopener"><code>DatagramNtf</code></a>&#8201;&#8212;&#8201;sent to the agent&#8217;s topic, when a datagram is received</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_parameters">13.1.2. Parameters</h4>
<div class="paragraph">
<p>Agents offering the DATAGRAM service support the following parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramParam.html#MTU" target="_blank" rel="noopener"><code>MTU</code></a>&#8201;&#8212;&#8201;maximum datagram size in bytes</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_capabilities">13.1.3. Capabilities</h4>
<div class="paragraph">
<p>Agents may support several optional capabilities:</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#FRAGMENTATION" target="_blank" rel="noopener">FRAGMENTATION</a></strong></p>
</div>
<div class="paragraph">
<p>Agents capable of fragmentation may break a datagram into smaller datagrams, transmit each of them across the network, and reassemble them on the peer node.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#RELIABILITY" target="_blank" rel="noopener">RELIABILITY</a></strong></p>
</div>
<div class="paragraph">
<p>If an agent advertises relaibility, it is able to acknowledge the successful delivery of the datagram. Reliability is enabled on a per-datagram basis by setting the <code>reliability</code> flag in the <code>DatagramReq</code>. Depending on whether the datagram could be successfully delivered or not, one of the following notifications is generated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramDeliveryNtf.html" target="_blank" rel="noopener"><code>DatagramDeliveryNtf</code></a>&#8201;&#8212;&#8201;sent to requestor</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramFailureNtf.html" target="_blank" rel="noopener"><code>DatagramFailureNtf</code></a>&#8201;&#8212;&#8201;sent to requestor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#PROGRESS" target="_blank" rel="noopener">PROGRESS</a></strong></p>
</div>
<div class="paragraph">
<p>Agents capable of reporting progress do so by periodically sending the following notification for long data transfers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramProgressNtf.html" target="_blank" rel="noopener"><code>DatagramProgressNtf</code></a>&#8201;&#8212;&#8201;sent to requestor on the transmitting node, and agent&#8217;s topic on the receiving node</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#CANCELLATION" target="_blank" rel="noopener">CANCELLATION</a></strong></p>
</div>
<div class="paragraph">
<p>If an agent supports cancellation, it honors the following request for stopping an ongoing data transfer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCancelReq.html" target="_blank" rel="noopener"><code>DatagramCancelReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code> / <code>NOT_UNDERSTOOD</code> (if unsupported)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#PRIORITY" target="_blank" rel="noopener">PRIORITY</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability prioritize datagrams with higher <code>priority</code> indicated in the <code>DatagramReq</code>.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/DatagramCapability.html#TTL" target="_blank" rel="noopener">TTL</a></strong></p>
</div>
<div class="paragraph">
<p>Agents that spool <code>DatagramReq</code> over extended periods of time usually advertise this capability. They discard <code>DatagramReq</code> that are undelivered after the time-to-live (<code>ttl</code> attribute of the <code>DatagramReq</code>) has expired.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples">13.2. Examples</h3>
<div class="paragraph">
<p>Fire up your 2-node network again, and open two browser windows&#8201;&#8212;&#8201;one connecting to node A&#8217;s shell, and the other to node B&#8217;s shell.</p>
</div>
<div class="paragraph">
<p>On node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.DATAGRAM<span class="o">)</span>
<span class="go">[transport, router, uwlink, phy]
</span><span class="gp">&gt;</span> phy.MTU
<span class="go">56
</span><span class="gp">&gt;</span> uwlink.MTU
<span class="go">848
</span><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> CapabilityReq()
</span><span class="go">CapabilityListRsp:INFORM[RELIABILITY,FRAGMENTATION]
</span><span class="gp">&gt;</span> subscribe uwlink</code></pre>
</div>
</div>
<div class="paragraph">
<p>We obtained a list of agents which provide the DATAGRAM service. We checked the <code>MTU</code> of the <code>phy</code> and <code>uwlink</code> agents, and found them to be 56 bytes and 848 bytes respectively. We decided to use the <code>uwlink</code> agent to communicate over a single-hop link between node A and B, and checked its capabilities. We found that it supports reliability and fragmentation. We then decided to listen to all datagrams received by node B&#8217;s <code>uwlink</code> agent by subscribing to its topic.</p>
</div>
<div class="paragraph">
<p>On node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[64])                               <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="go">AGREE
</span><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[64], reliability: true)            <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="go">AGREE
</span><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramDeliveryNtf:INFORM[id:4dda055e-a533-401f-89c8-a01065ca5d70 to:31]   <i class="conum" data-value="3"></i><b>(3)</b>
<span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 37, data: new byte[64], reliability: true)            <i class="conum" data-value="4"></i><b>(4)</b>
</span><span class="go">AGREE
</span><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramFailureNtf:INFORM[id:bc65e643-6161-4b06-913c-3ff4f6985d36 to:37]    <i class="conum" data-value="5"></i><b>(5)</b>
<span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 0, data: new byte[64])                                <i class="conum" data-value="6"></i><b>(6)</b>
</span><span class="go">AGREE
</span><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 0, data: new byte[64], reliability: true)             <i class="conum" data-value="7"></i><b>(7)</b>
</span><span class="go">REFUSE: Reliability not supported for broadcast
</span><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[1024])                             <i class="conum" data-value="8"></i><b>(8)</b>
</span><span class="go">REFUSE: Data length exceeds MTU</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send an unreliable datagram to node 31.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Send a reliable datagram to node 31.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Successful delivery of reliable datagram reported.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Send a reliable datagram to node 37. Since node 37 does not exist in this network, this should eventually fail.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Delivery failure reported (after trying for a few minutes).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Broadcast an unreliable datagram.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Broadcast request for reliable datagram is refused, as reliability requires a response from peer node and therefore cannot be supported on broadcast.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Datagram transmission request for data larger than MTU is also refused.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we look at the shell for node B, we should see the 3 successfully delivered datagrams:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramNtf:INFORM[from:232 to:31 <span class="o">(</span>64 bytes<span class="o">)]</span>
<span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramNtf:INFORM[from:232 to:31 <span class="o">(</span>64 bytes<span class="o">)]</span>
<span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramNtf:INFORM[from:232 <span class="o">(</span>64 bytes<span class="o">)]</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Agent <code>uwlink</code> uses the PHYSICAL service (agent <code>phy</code>) to deliver the data. Since the <code>phy.MTU</code> is only 56 bytes, but our datagrams were 64 bytes, unbeknownst to us, the <code>uwlink</code> agent must have been fragmenting these datagrams and reassembling them on the other side!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_short_circuit_delivery">13.3. Short-circuit delivery</h3>
<div class="paragraph">
<p>We were able to successfully deliver datagrams from node A to node B in the examples in the previous section. We not only saw the <code>DatagramNtf</code> messages on node B, but also got <code>DatagramDeliveryNtf</code> on node A if <code>reliability</code> was enabled.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try it again, but with a small difference. On node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[32])
</span><span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We transmitted a smaller datagram, and node A happily accepted it for delivery. However, if we look at the shell for node B, we don&#8217;t see a <code>DatagramNtf</code> message corresponding to the datagram, even though you had already subscribed to <code>uwlink</code>! What&#8217;s going on? Let&#8217;s try it again, but this time enable reliability:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[32], reliability: true)
</span><span class="go">AGREE
</span><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramDeliveryNtf:INFORM[id:4aaa86e5-9a56-46f8-bc1a-f6be33af03a4 to:31]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the datagram was indeed delivered! And now, if we look at node B&#8217;s shell, we&#8217;ll see the delivery notification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramNtf:INFORM[from:232 to:31 <span class="o">(</span>32 bytes<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It seems that enabling reliability successfully delivered the datagram, but otherwise the <code>DatagramNtf</code> message did not appear on node B&#8217;s shell! You can try this many times, and the result will be the same. So it can&#8217;t be random packet loss in the network either. What&#8217;s going on?</p>
</div>
<div class="paragraph">
<p>To try and troubleshoot this, let&#8217;s subscribe to notifications from the <code>phy</code> agent to see if the data is arriving at the physical layer. On node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy</code></pre>
</div>
</div>
<div class="paragraph">
<p>On node A, transmit the unreliable small datagram again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> uwlink <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: 31, data: new byte[32])
</span><span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On node B, we now see a couple of notifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:DATA rxTime:3956973678]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:DATA from:232 to:31 rxTime:3956973678 <span class="o">(</span>32 bytes<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first notification says that the physical layer detected the start of a data frame. The second notification is for a received frame with 32 bytes from node 232 to node 31. That&#8217;s our datagram!!! But why is it delivered by <code>phy</code> and not <code>uwlink</code>, when it was sent by <code>uwlink</code> on node A? And why is it a <code>RxFrameNtf</code> instead of a <code>DatagramNtf</code>?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s solve the second mystery first. An <code>RxFrameNtf</code> is a subclass of <code>DatagramNtf</code>, so it is indeed a <code>DatagramNtf</code> message. We can easily verify this on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ntf
<span class="go">RxFrameNtf:INFORM[type:DATA from:232 to:31 rxTime:3956973678 (32 bytes)]
</span><span class="gp">&gt;</span> ntf instanceof DatagramNtf
<span class="go">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Variable <code>ntf</code> contains the last notification received. It is the <code>RxFrameNtf</code>, and it is indeed an instance of <code>DatagramNtf</code>. So, we indeed got the datagram on node B, and it was delivered as a <code>DatagramNtf</code> with the correct metadata.</p>
</div>
<div class="paragraph">
<p>But why was it sent on <code>phy</code> agent&#8217;s topic and not <code>uwlink</code> agent&#8217;s topic, like all other datagrams we transmitted?</p>
</div>
<div class="paragraph">
<p>This is due to an optimization known as <strong>short-circuit delivery</strong> (introduced in UnetStack 3), depicted in <a href="#fig_shortcircuit">Figure 7</a>. The <code>uwlink</code> agent on node A looked at the unreliable <code>DatagramReq</code> for 32 bytes and realized that it is within the <code>phy</code> agent&#8217;s capability (no reliability needed, and the datagram size is less than <code>phy.MTU</code>) to deliver this without the help of the <code>uwlink</code> agent. It delegated the task to the <code>phy</code> agent, which in turn send the datagram to its peer on node B, and therefore it was delivered to us by the <code>phy</code> agent on node B. This delegation not only reduces computation, but more importantly reduces the overhead of link headers in the frame, and therefore save valuable bandwidth in a resource-constrained underwater network.</p>
</div>
<div class="paragraph">
<p>Short-circuit delivery is not only done by <code>uwlink</code>, but by all agents supporting the DATAGRAM service. If a downstream agent is capable of delivering the datagram, the delivery is delegated automatically.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
As a result of short-circuit delivery optimization, you need to subscribe to <strong>all</strong> DATAGRAM service providers to receive <code>DatagramNtf</code> messages, and not just the one you send the datagram via.
</td>
</tr>
</table>
</div>
<div id="fig_shortcircuit" class="imageblock">
<div class="content">
<img src="images/shortcircuit.png" alt="shortcircuit">
</div>
<div class="title">Figure 7. With short-circuit delivery, <code>uwlink</code> on node A recognizes the <code>DatagramReq</code> to be within the <code>phy</code> agent&#8217;s capability, and no delegates it without adding any headers. On node B, the received frame is directly delivered as a <code>DatagramNtf</code> by the <code>phy</code> agent, since <code>uwlink</code> functionality is not required.</div>
</div>
<div class="paragraph">
<p>On node B, we should have done this in the first place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.DATAGRAM<span class="o">)</span>.each <span class="o">{</span> subscribe it <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This single-liner in Groovy iterates over the list of agents providing the DATAGRAM service, and subscribes to the topic of each agent in that list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_datagrams_and_the_unetsocket_api">13.4. Datagrams and the UnetSocket API</h3>
<div class="paragraph">
<p>The UnetSocket API also supports delivery of datagrams. Let&#8217;s try it. On node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> new UnetSocket<span class="o">(</span>this<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> s.send new DatagramReq<span class="o">(</span>to: 31, data: new byte[32]<span class="o">)</span>
<span class="go">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On node B, we will see the datagram delivery:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">uwlink &gt;</span><span class="o">&gt;</span> DatagramNtf:INFORM[from:232 to:31 <span class="o">(</span>32 bytes<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we did not have to specify an agent or service when making the datagram request via the UnetSocket API. An appropriate agent was automatically selected by the API for us. In this case, the <code>uwlink</code> agent was used by the API to deliver the datagram.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_physical_service">14. Physical service</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.PHYSICAL</strong></code></p>
</div>
<div class="paragraph">
<p>Agents offering the PHYSICAL service are most commonly modem drivers and modem simulators. They support messages and parameters that are explained below. PHYSICAL service providers may also provide optional capabilities to send frames triggered at a specified time, or send timestamped frames where the timestamp is embedded in the transmitted frame.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Agents implementing the PHYSICAL service typically directly access the channel, bypassing any MAC protocol that may be in use in the network. It is highly recommended that clients wishing to use the PHYSICAL service consult with the MAC service for advice on when it is safe to access the channel, so as not to adversely affect the network performance.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_overview_2">14.1. Overview</h3>
<div class="paragraph">
<p>All agents supporting the PHYSICAL service must also support the DATAGRAM service (<a href="#_datagram_service">Chapter 13</a>).</p>
</div>
<div class="sect3">
<h4 id="_messages_2">14.1.1. Messages</h4>
<div class="paragraph">
<p>Agents supporting the PHYSICAL service provide a set of messages to manage frame transmission and reception:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/TxFrameReq.html" target="_blank" rel="noopener"><code>TxFrameReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;transmit a frame</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/TxRawFrameReq.html" target="_blank" rel="noopener"><code>TxRawFrameReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;transmit a frame without headers</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/ClearReq.html" target="_blank" rel="noopener"><code>ClearReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;cancel all ongoing and pending transmissions</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RxFrameNtf.html" target="_blank" rel="noopener"><code>RxFrameNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a frame addressed to the node is received, and the agent&#8217;s <a href="https://unetstack.net/javadoc/org/arl/unet/phy/Physical.html#SNOOP" target="_blank" rel="noopener"><code>SNOOP</code></a> sub-topic when a frame addressed to other nodes is overheard</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/TxFrameNtf.html" target="_blank" rel="noopener"><code>TxFrameNtf</code></a>&#8201;&#8212;&#8201;sent to requestor when a frame is transmitted</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RxFrameStartNtf.html" target="_blank" rel="noopener"><code>RxFrameStartNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a frame is detected</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/TxFrameStartNtf.html" target="_blank" rel="noopener"><code>TxFrameStartNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a frame transmission is started</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/BadFrameNtf.html" target="_blank" rel="noopener"><code>BadFrameNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a bad frame is received</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/CollisionNtf.html" target="_blank" rel="noopener"><code>CollisionNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a frame is detected (and dropped) while another frame is being received</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>TxFrameReq</code> class extends a <code>DatagramReq</code> to add physical layer options, and the <code>RxFrameNtf</code> class extends a <code>DatagramNtf</code> to add physical layer metadata.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parameters_2">14.1.2. Parameters</h4>
<div class="paragraph">
<p>Agents offering the PHYSICAL service support the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#rxEnable" target="_blank" rel="noopener"><code>rxEnable</code></a>&#8201;&#8212;&#8201;true if reception is enabled, false otherwise</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#propagationSpeed" target="_blank" rel="noopener"><code>propagationSpeed</code></a>&#8201;&#8212;&#8201;signal propagation speed in m/s</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#time" target="_blank" rel="noopener"><code>time</code></a>&#8201;&#8212;&#8201;current physical layer clock time in microseconds</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#busy" target="_blank" rel="noopener"><code>busy</code></a>&#8201;&#8212;&#8201;true if modem is busy transmitting/receiving (carrier sense), false if modem is idle</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#refPowerLevel" target="_blank" rel="noopener"><code>refPowerLevel</code></a>&#8201;&#8212;&#8201;reference source level in dB (re micro-Pascals @ 1m for underwater modems)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#maxPowerLevel" target="_blank" rel="noopener"><code>maxPowerLevel</code></a>&#8201;&#8212;&#8201;maximum allowable transmission power in dB re <code>refPowerLevel</code></p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#minPowerLevel" target="_blank" rel="noopener"><code>minPowerLevel</code></a>&#8201;&#8212;&#8201;minimum allowable transmission power in dB re <code>refPowerLevel</code></p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#rxSensitivity" target="_blank" rel="noopener"><code>rxSensitivity</code></a>&#8201;&#8212;&#8201;reference receive sensitivity (dB re micro Pascals for underwater modems)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All physical layer timestamps are in microseconds as per the clock provided by the <code>time</code> parameter. This clock is generally not synchronized with the platform clock (system time).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to the above parameters, agents also support indexed (frame type) parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#frameDuration" target="_blank" rel="noopener"><code>frameDuration</code></a>&#8201;&#8212;&#8201;frame duration in seconds (maximum duration in case of variable frame length)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#powerLevel" target="_blank" rel="noopener"><code>powerLevel</code></a>&#8201;&#8212;&#8201;transmission power in dB re <code>refPowerLevel</code></p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#errorDetection" target="_blank" rel="noopener"><code>errorDetection</code></a>&#8201;&#8212;&#8201;number of bytes used for error detection</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#frameLength" target="_blank" rel="noopener"><code>frameLength</code></a>&#8201;&#8212;&#8201;frame length in bytes (maximum length in case of variable frame length)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#maxFrameLength" target="_blank" rel="noopener"><code>maxFrameLength</code></a>&#8201;&#8212;&#8201;maximum possible frame length in bytes</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#fec" target="_blank" rel="noopener"><code>fec</code></a>&#8201;&#8212;&#8201;forward error correction (FEC) code (0 = none/default, otherwise base 1 index from fecList)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#fecList" target="_blank" rel="noopener"><code>fecList</code></a>&#8201;&#8212;&#8201;list of available FEC code names (in the order of increasing robustness), may be null if FEC change not supported</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#dataRate" target="_blank" rel="noopener"><code>dataRate</code></a>&#8201;&#8212;&#8201;effective frame data rate (bps)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#llr" target="_blank" rel="noopener"><code>llr</code></a>&#8201;&#8212;&#8201;true to enable log-likelihood ratio reporting in <code>BadFrameNtf</code>, false otherwise</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Seconds, milliseconds or microseconds?</div>
<div class="paragraph">
<p>You&#8217;ll notice that we use seconds as a unit of time in some places, and milliseconds in others, and microseconds in yet others. While we recognize that this can be confusing at times, there is a good reason for this.</p>
</div>
<div class="paragraph">
<p>Whenever time or duration can be a <code>float</code>, we prefer to use seconds as our unit of time. We also define some Groovy syntactic sugar to allow writing down values in our preferred units, while automatically converting them to seconds. For example: <code>10.s</code> &#8594; 10.0, <code>10.ms</code> &#8594; 0.01, and <code>1.minute</code> &#8594; 60.</p>
</div>
<div class="paragraph">
<p>Many existing Java and fjåge API calls (e.g. <code>currentTimeMillis()</code>, <code>WakerBehavior()</code>, <code>TickerBehavior()</code>) use the <code>long</code> data type for time in milliseconds. Where UnetStack inherits that API, we have no choice but to stick with milliseconds. Do be careful NOT to use values such as <code>10.ms</code> there, as these are really values in seconds.</p>
</div>
<div class="paragraph">
<p>The only time value in microseconds is the PHYSICAL service&#8217;s <code>time</code> parameter, and the corresponding <code>rxTime</code>, <code>recTime</code> and <code>txTime</code> timestamps. This is also inherited by the synchronization time <code>offset</code> between node times in the RANGING service.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Two frame types are defined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/Physical.html#CONTROL" target="_blank" rel="noopener"><code>CONTROL</code></a> frame = 1</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/Physical.html#DATA" target="_blank" rel="noopener"><code>DATA</code></a> frame = 2</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_capabilities_2">14.1.3. Capabilities</h4>
<div class="paragraph">
<p>Agents may support several optional capabilities:</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalCapability.html#TIMESTAMPED_TX" target="_blank" rel="noopener">TIMESTAMPED_TX</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability are able to transmit frames with a transmission timestamp (start of transmission) encapsulated in the frame. This is requested through the <code>timestamped</code> flag in the <code>TxFrameReq</code> message. In order to do the timestamping, the frame has to be scheduled for transmission after a short delay. This delay is configured via an additional parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalParam.html#timestampedTxDelay" target="_blank" rel="noopener"><code>timestampedTxDelay</code></a>&#8201;&#8212;&#8201;delay in seconds to transmit timestamped frames</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalCapability.html#TIMED_TX" target="_blank" rel="noopener">TIMED_TX</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability are able to start transmitting a frame at a specified time (on a best effort basis). The time is given in the <code>txTime</code> attribute of the <code>TxFrameReq</code> message.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalCapability.html#JANUS" target="_blank" rel="noopener">JANUS</a></strong></p>
</div>
<div class="paragraph">
<p>If an agent supports the ANEP-87 JANUS standard, it advertises this capability. An additional frame type (indexed parameter set) is defined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/Physical.html#JANUS" target="_blank" rel="noopener"><code>JANUS</code></a> frame = 3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The JANUS capability also adds one parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalChannelParam.html#janus" target="_blank" rel="noopener"><code>janus</code></a>&#8201;&#8212;&#8201;true for JANUS frame type, false for all other frame types</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It also adds two JANUS-specific messages that are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/TxJanusFrameReq.html" target="_blank" rel="noopener"><code>TxJanusFrameReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;transmit a JANUS frame</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RxJanusFrameNtf.html" target="_blank" rel="noopener"><code>RxJanusFrameNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when a JANUS frame is received</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/phy/PhysicalCapability.html#FEC_DECODING" target="_blank" rel="noopener">FEC_DECODING</a></strong></p>
</div>
<div class="paragraph">
<p>If an agent advertises this capability, it supports an additional request to perform FEC decoding:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/FecDecodeReq.html" target="_blank" rel="noopener"><code>FecDecodeReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;attempt FEC decoding a frame, and if successful, send out a <code>RxFrameNtf</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_control_and_data_channels">14.2. CONTROL and DATA channels</h3>
<div class="paragraph">
<p>The physical layer in UnetStack typically supports 2 logical channels (3 if JANUS is supported). The CONTROL channel provides low-rate, robust communication that allows exchange of small amounts of control information in the network. The DATA channel is a usually a higher rate communication link, but may require tuning to operate well in various environmental conditions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The configurable parameters of the CONTROL and DATA channels depend strongly on the device (modem) in use. The Unet simulator provides a simplified physical layer (<code>HalfDuplexModem</code>) that captures the essential aspects of the communication using the two channels, exposing only a limited set of parameters. When configuring a real network, you should refer to your modem&#8217;s manual on advise on how best to set up the physical layer parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fire up the 2-node network simulation and connect to node A&#8217;s shell. If you simply type <code>phy</code>, you can explore the physical layer parameters for the node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy
<span class="gp">&lt;&lt;&lt; HalfDuplexModem &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 56

[org.arl.unet.phy.PhysicalParam]
  busy = false
  maxPowerLevel = 0.0
  minPowerLevel = -96.0
  propagationSpeed = 1534.4574
  refPowerLevel = 185.0
  rxEnable = true
  rxSensitivity = -200.0
  time = 9615673299
  timestampedTxDelay = 1.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>phy.MTU</code> parameter tells us the maximum amount of user data that can be transmitted in a single frame (56 bytes in this case). This is based on the DATA channel, as we will see shortly, since <code>DatagramReq</code> are fulfilled using the DATA channel. The <code>PhysicalParam</code> parameters provide us information on whether the channel is busy, transmission power levels supported, receiver sensitivity, and propagation speed of the signal (e.g. speed of sound for underwater modems). The <code>phy.time</code> parameter is a microsecond resolution clock that is used to timestamp all physical layer events such as frame transmission, reception, etc.</p>
</div>
<div class="paragraph">
<p>We can dig deeper into the parameters for the CONTROL and DATA channel separately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[CONTROL]
<span class="gp">&lt;&lt;&lt; PHY &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 16

[org.arl.unet.phy.PhysicalChannelParam]
  dataRate = 202.10527
  errorDetection = 1
  fec = 0
  fecList = null
  frameDuration = 0.95
  frameLength = 24
  janus = false
  llr = false
  maxFrameLength = 128
  powerLevel = -10.0

</span><span class="gp">&gt;</span> phy[DATA]
<span class="gp">&lt;&lt;&lt; PHY &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 56

[org.arl.unet.phy.PhysicalChannelParam]
  dataRate = 731.4286
  errorDetection = 1
  fec = 0
  fecList = null
  frameDuration = 0.7
  frameLength = 64
  janus = false
  llr = false
  maxFrameLength = 512
  powerLevel = -10.0</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The values you see above are specific to this simulated network, and will generally be different for different networks, depending on the devices that are being used and the environment that they are deployed in.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are a few important parameters to take note of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Note that <code>MTU</code> for the CONTROL channel is 16 bytes, whereas DATA channel&#8217;s <code>MTU</code> is 56 bytes. CONTROL frames typically carry less data, but are more robust.</p>
</li>
<li>
<p>The <code>frameLength</code> for the CONTROL and DATA channels are 8 bytes longer than the corresponding <code>MTU</code>. The difference is due to header information that the frames carry. The number of bytes taken by the header is device dependent, and also a function of network configuration (e.g. changes in <code>node.addressSize</code> may change header size).</p>
</li>
<li>
<p>Typically physical layer agents allow setting of the <code>frameLength</code> parameter, and the <code>MTU</code> parameter is automatically determined based on the necessary headers. The <code>maxFrameLength</code> parameter indicates the maximum size of the frame supported.</p>
</li>
<li>
<p>The <code>frameDuration</code> for the CONTROL channel is about 0.95 seconds, whereas that for the DATA channel is 0.7 seconds. While the CONTROL frames carry less data, they also have lower data rate and so may have comparable duration as the DATA frames.</p>
</li>
<li>
<p>The <code>dataRate</code> reported by the channel is the effective data rate in bps including the header bits, i.e., it is the frame length in bits divided by the frame duration.</p>
</li>
<li>
<p>The <code>powerLevel</code> parameter controls the transmission power used by the channel. This value is in dB, with reference to the <code>phy.refPowerLevel</code>, and may range between <code>phy.minPowerLevel</code> and <code>phy.maxPowerLevel</code>.</p>
</li>
<li>
<p>The <code>errorDetection</code> parameter reports the number of bytes used for error detection CRC (value of 1 indicates that we are using a 8-bit CRC). Some modems will allow you to set this to 2 to switch to 16-bit CRC, if you desire a lower probability of accepting a frame with some bit errors.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_modem_physical_layer">14.3. Modem physical layer</h3>
<div class="paragraph">
<p>In the previous section, we explored several parameters from a simplified simulated physical layer. Next let&#8217;s look at a real modem. If you are lucky enough to own one with UnetStack on it, you can connect to it&#8217;s shell now. Otherwise, we can use unet audio SDOAM as our test modem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet audio
Modem web: http://localhost:8080/</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the web shell for the modem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy
<span class="gp">&lt;&lt;&lt; Physical &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.DatagramParam]
  MTU = 13

[org.arl.unet.phy.PhysicalParam]
  busy = false
  maxPowerLevel = 0.0
  minPowerLevel = -138.0
  propagationSpeed = 1500.0
  refPowerLevel = 0.0
  rxEnable = true
  rxSensitivity = 0.0
  time = 51530438
  timestampedTxDelay = 1000

[org.arl.yoda.ModemParam]
  adcrate = 48000.0
  bbsblk = 6000
  bbscnt = 0
  bpfilter = true
  clockCalib = 1.0
  dacrate = 96000.0
  downconvRatio = 4.0
  fan = false
  fanctl = 45.0
  fullduplex = false
  gain = 0.0
  inhibit = 120
  isc = true
  loopback = false
  model = portaudio
  mute = true
  noise = -62.0
  npulses = 1
  pbsblk = 65536
  pbscnt = 0
  post = null
  poweramp = false
  preamp = true
  pulsedelay = 0
  serial = portaudio
  standby = 15
  upconvRatio = 8.0
  vendor = Subnero
  voltage = 0.0
  wakeupdelay = 400
  wakeuplen = 8000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For brevity, we have omitted the baseband service and scheduler service parameters in the listing above. Even then, there are many parameters that allow you to configure the SDOAM. We cannot cover each parameter in detail here, but we encourage you to explore the help pages for the parameters by simply typing <code>help phy.</code> followed by the parameter name.</p>
</div>
<div class="paragraph">
<p>Further, let&#8217;s look at the indexed parameters for the CONTROL channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="o">&gt;</span> phy[CONTROL]
<span class="o">&lt;&lt;&lt;</span> PHY <span class="o">&gt;&gt;&gt;</span>

<span class="o">[</span>org.arl.unet.DatagramParam]
  MTU <span class="o">=</span> 13

<span class="o">[</span>org.arl.unet.phy.PhysicalChannelParam]
  dataRate <span class="o">=</span> 70.588234
  errorDetection <span class="o">=</span> <span class="nb">true
  </span>fec <span class="o">=</span> 1
  fecList <span class="o">=</span> <span class="o">[</span>ICONV2]
  frameDuration <span class="o">=</span> 2.04
  frameLength <span class="o">=</span> 18
  janus <span class="o">=</span> <span class="nb">false
  </span>llr <span class="o">=</span> <span class="nb">false
  </span>maxFrameLength <span class="o">=</span> 396
  powerLevel <span class="o">=</span> <span class="nt">-10</span>.0

<span class="o">[</span>org.arl.yoda.FhbfskParam]
  chiplen <span class="o">=</span> 1
  fmin <span class="o">=</span> 9520.0
  fstep <span class="o">=</span> 160.0
  hops <span class="o">=</span> 13
  scrambler <span class="o">=</span> 0
  <span class="nb">sync</span> <span class="o">=</span> <span class="nb">true
  </span>tukey <span class="o">=</span> <span class="nb">true</span>

<span class="o">[</span>org.arl.yoda.ModemChannelParam]
  basebandExtra <span class="o">=</span> 0
  basebandRx <span class="o">=</span> <span class="nb">false
  </span>modulation <span class="o">=</span> fhbfsk
  preamble <span class="o">=</span> <span class="o">(</span>480 samples<span class="o">)</span>
  <span class="nb">test</span> <span class="o">=</span> <span class="nb">false
  </span>threshold <span class="o">=</span> 0.25
  valid <span class="o">=</span> <span class="nb">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, we cannot cover all the parameters in detail here, but will draw your attention to a few important ones. You see that the <code>modulation</code> for the CONTROL channel is set to <code>'fhbfsk'</code> (frequency-hopping binary frequency shift keying). Depending on your modem, different modulations may be supported. Once a modulation scheme is chosen, you see additional modulation-dependent parameters. In this case, these are the <code>org.arl.yoda.FhbfskParam</code> parameters such as <code>fmin</code>, <code>fstep</code>, <code>hops</code>, <code>chiplen</code>, <code>tukey</code>, etc. These parameters allow you to control the modulation&#8217;s frequency band, number of hops, chip duration, windowing, etc.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you change modulation parameters, you have to remember to do it on all your modems in the network. Otherwise they will be speaking different <em>languages</em>, and they won&#8217;t be able to understand each other. Not all combination of modulation parameters are valid. The <code>valid</code> parameter tells us if the current setting is valid or not. If the setting is invalid, all transmission requests will be refused.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>preamble</code> parameter determines a detection preamble that is transmitted before each frame. This is used by the receiving modem to determine the start of a frame. The <code>threshold</code> parameter controls the detection probability and false alarm rate for frame detection. A lower threshold will improve detection probability, but increase false alarm rate.</p>
</div>
<div class="paragraph">
<p>If the <code>test</code> flag is set on the transmission and reception modems, each transmit frame is filled with known test data. This allows the receiving modem to compute the bit error rate (BER), even when the frame has too many errors for FEC to be able to correct.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transmitting_receiving_using_unet_audio">14.4. Transmitting &amp; receiving using Unet audio</h3>
<div class="paragraph">
<p>If you have two computers with speakers and microphones, you could run unet audio on both, and communicate between the two. If you happen to have only one computer handy, do not worry&#8201;&#8212;&#8201;we can get one unet audio instance to transmit and receive at the same time. This is full-duplex communication!</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Real modems typically cannot do full-duplex communication because the weak incoming signals are masked by clutter from the strong outgoing signal. However, by adjusting the volume of your computer carefully, you can easily do full-duplex communication on your unet audio SDOAM.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On unet audio shell, enable full-duplex operation and try a transmission (you should be able to hear it from your computer speaker!). Your output might not look exactly the same, but let&#8217;s go over all the notifications we got and see if we can understand all of them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy.fullduplex <span class="o">=</span> <span class="nb">true</span>
<span class="go">true
</span><span class="gp">&gt;</span> subscribe phy
<span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq()
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[type:CONTROL txTime:79322682]                <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:79309353 detector:0.87]  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:DATA rxTime:80659519 detector:0.26]     <i class="conum" data-value="3"></i><b>(3)</b>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:79310432]                     <i class="conum" data-value="4"></i><b>(4)</b>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:1 rxTime:79309353 rssi:-29.3]   <i class="conum" data-value="5"></i><b>(5)</b>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> BadFrameNtf:INFORM[type:DATA rxTime:80659519 rssi:-38.5 <span class="o">(</span>18 bytes<span class="o">)]</span> <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Transmission of our requested CONTROL frame has started.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our frame being transmitted was detected as a CONTROL frame, and reception has started.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Our frame being transmitted was wrongly detected (false alarm) as a DATA frame.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Transmission of our frame was completed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Reception of the frame was completed, and successful.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The wrongly detected frame resulted in data that did not satisfy CRC, and hence reported as a bad frame.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get rid of the false alarm on the DATA channel, we could either increase the detection threshold or turn off the detector completely (<code>phy[DATA].threshold = 0</code>). For now, we&#8217;ll do the latter. Let&#8217;s also turn on the <code>phy[CONTROL].test</code> flag so that we can measure communication performance in terms of BER. To measure BER before error correction, we also need to turn off <code>phy[CONTROL].fec</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[DATA].threshold <span class="o">=</span> 0
<span class="go">0
</span><span class="gp">&gt;</span> phy[CONTROL].test <span class="o">=</span> <span class="nb">true</span>
<span class="go">true
</span><span class="gp">&gt;</span> phy[CONTROL].fec <span class="o">=</span> 0
<span class="go">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can make 10 transmissions, 2 seconds apart, and watch the BER of the received frames:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> 10.times <span class="o">{</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(); delay(2000); }
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:204359766]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:204385187 rssi:-28.9 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:205578432]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:205603853 rssi:-28.4 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:207567766]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:207589186 rssi:-28.5 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:209583766]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:209609187 rssi:-28.2 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:211573099]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:211594519 rssi:-28.3 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:213589099]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:213614520 rssi:-28.1 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:215578432]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:215599853 rssi:-28.5 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:217594432]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:217619853 rssi:-28.2 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:219583766]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:219605186 rssi:-28.0 cfo:0.0 ber:0/144 (18 bytes)]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; TxFrameNtf:INFORM[type:CONTROL txTime:221599766]
</span><span class="gp">phy &gt;</span><span class="sh">&gt; RxFrameNtf:INFORM[type:CONTROL rxTime:221625187 rssi:-27.7 cfo:0.0 ber:0/144 (18 bytes)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For brevity, we have omitted the <code>TxFrameStartNtf</code> and <code>RxFrameStartNtf</code> messages. We see that no bits were in error, out of 144 transmitted bits. We had perfect communication, even without FEC! This is not surprising since the speaker and microphone are very close (and hence good signal-to-noise ratio), but real channels are rarely so forgiving. You can try this between 2 computers, and things may not be as rosy.</p>
</div>
<div class="paragraph">
<p>Feel free to play around with the parameters of the modulation scheme and try transmissions to get a feel for how the parameters affect communication performance. Since your transmission and reception modems are the same, you only need to set the parameters once! In real life, you&#8217;ll need to set the same parameters on all modems in your network.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Remember to turn off the <code>phy[CONTROL].test</code> flag before trying any data transfer. While the flag is on, no user data can be carried by the transmitted frames.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_timed_and_timestamped_transmissions">14.5. Timed and timestamped transmissions</h3>
<div class="paragraph">
<p>To explore timed and timestamped transmissions, let&#8217;s go back to our 2-node network simulation. On the shell for node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> CapabilityReq()
</span><span class="go">CapabilityListRsp:INFORM[TIMESTAMPED_TX,TIMED_BBREC,TIMED_BBTX,TIMED_TX]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the <code>phy</code> agent supports the <code>TIMESTAMPED_TX</code> and <code>TIMED_TX</code> optional capabilities. Let us try them out. On node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going back to node A, send a timestamped frame:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(timestamped: true)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:2489196375]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the frame was transmitted at time 2489196375 (when you try this, the time will of course be different). You should see the <code>RxFrameNtf</code> for this frame on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:687419054]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:232 rxTime:687419054 txTime:2489196375]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>RxFrameNtf</code> now has an additional <code>txTime</code> field that&#8217;s populated, and the timestamp in there is the same as the <code>txTime</code> on node A&#8217;s <code>TxFrameNtf</code>. The frame was timestamped before transmission, and transmitted at exactly the intended time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Timestamps take up bits in the transmitted frame. Your effective <code>MTU</code> for frames with timestamps is 6 bytes less than the advertised <code>MTU</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Do bear in mind that the <code>phy.time</code> clocks on node A and B may not be synchronized. So timestamps from one node cannot be directly compared with timestamps on another node. In the above example, the <code>rxTime</code> was 687,419,054 microseconds, whereas the <code>txTime</code> was 2,489,196,375 microseconds. This does not mean that the frame was received before it was transmitted! It&#8217;s just that node A and B have an offset between their clocks.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes you may not need to transmit a timestamped frame, but you do want the frame to be transmitted at a specified time. On node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> t <span class="o">=</span> phy.time + 5000000<span class="p">;</span> println<span class="o">(</span>t<span class="o">)</span><span class="p">;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(txTime: t) <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="go">3174864375                                                             <i class="conum" data-value="2"></i><b>(2)</b>
AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:3174864375]               <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>t</code> is the current time + 5 seconds. We ask for a frame to be transmitted at time <code>t</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The value of time <code>t</code> is printed immediately (due to the <code>println(t)</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>TxFrameNtf</code> message will appear after a few seconds, once the transmission is made. Note that the actual <code>txTime</code> when the transmission occurred matches with our requested value <code>t</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you check node B&#8217;s shell, you&#8217;ll find the corresponding <code>RxFrameNtf</code>, but it will not have a <code>txTime</code> field, as the frame transmitted was not timestamped.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The transmission time is honored on a <em>best effort</em> basis, which means that there could be a small difference between the requested time and the actual transmit time.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_snooping_frames_meant_for_other_nodes">14.6. Snooping frames meant for other nodes</h3>
<div class="paragraph">
<p>If you&#8217;re familiar with Ethernet network interface cards, you may have come across <em>promiscuous mode</em>. In this mode, the network card receives all packets that it hears, not just the ones that are addressed to the node. Agents providing the PHYSICAL service essentially do this continuously, but they send the notifications for frames intended for other nodes on a special sub-topic called SNOOP.</p>
</div>
<div class="paragraph">
<p>With the 2-node network simulation, let&#8217;s first only subscribe to the <code>phy</code> agent&#8217;s topic on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy</code></pre>
</div>
</div>
<div class="paragraph">
<p>From node A, transmit a frame to node B and to node C (node C does not exist in this network):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(to: host('B'))
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:4622534375]
<span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(to: host('C'))
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:4623823375]</code></pre>
</div>
</div>
<div class="paragraph">
<p>On node B, you&#8217;ll find that it receives the <code>RxFrameStartNtf</code> for both transmissions, but only the <code>RxFrameNtf</code> for the transmission addressed to node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:2820757054]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:232 to:31 rxTime:2820757054]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:2822046054]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RxFrameStartNtf</code> is sent when a frame is detected. At that point in time, the agent has no idea whom the frame is intended for, because the frame contents have not yet arrived. Only when the frame is received and decoded does the agent know the destination address. Seeing that the second frame was intended for node C, node B does not report a <code>RxFrameNtf</code> for it.</p>
</div>
<div class="paragraph">
<p>If you were interested in snooping conversations between other nodes, you could subscribe to the SNOOP topic on node B:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe topic<span class="o">(</span>phy, org.arl.unet.phy.Physical.SNOOP<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now try transmitting another frame from node A to node C. On node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxFrameReq(to: host('C'))
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:CONTROL txTime:4899843375]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you&#8217;ll see on node B that the corresponding <code>RxFrameNtf</code> is received:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:3098066054]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:232 to:74 rxTime:3098066054]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>to</code> address of 74 corresponds to <code>host('C')</code>, but the frame is available for agents on node B through the SNOOP topic.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_baseband_service">15. Baseband service</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.BASEBAND</strong></code></p>
</div>
<div class="paragraph">
<p>Software-defined modems often allow developers to transmit and record arbitrary waveforms. This functionality is encapsulated in the baseband service of UnetStack.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Agents implementing the baseband service typically directly access the channel, bypassing any MAC protocol that may be in use in the network. It is highly recommended that clients wishing to use the baseband service for transmitting arbitrary waveforms consult with the MAC service for advice on when it is safe to access the channel, so as not to adversely affect the network performance.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_overview_3">15.1. Overview</h3>
<div class="paragraph">
<p>Agents offering the baseband service are most commonly modem drivers (and simulators). They support a set of messages and parameters that are explained below. Baseband service providers may also provide optional capabilities to send or record signals at a specified time, or based on premable detection.</p>
</div>
<div class="sect3">
<h4 id="_messages_3">15.1.1. Messages</h4>
<div class="paragraph">
<p>Agents supporting the baseband service provide messages for arbitrary signal transmission and recording:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/TxBasebandSignalReq.html" target="_blank" rel="noopener"><code>TxBasebandSignalReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;transmit a signal</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/RecordBasebandSignalReq.html" target="_blank" rel="noopener"><code>RecordBasebandSignalReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;record a signal</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/RxBasebandSignalNtf.html" target="_blank" rel="noopener"><code>RxBasebandSignalNtf</code></a>&#8201;&#8212;&#8201;signal recording sent to requestor, or to agent&#8217;s topic if the recording was not specifically requested</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During signal transmission, an agent implementing the baseband service sends out <code>TxFrameStartNtf</code> and <code>TxFrameNtf</code>, as described in the PHYSICAL service (<a href="#_physical_service">Chapter 14</a>). Similarly, if recording is triggered on a preamble detection, the agent sends out a <code>RxFrameStartNtf</code> as described in the PHYSICAL service.</p>
</div>
<div class="paragraph">
<p>Detection preambles are often added to transmitted signals for the receiving modem to identify the incoming signals. The receiving modem can capture the signal when it detects the preamble, and then send a <code>RxBasebandSignalNtf</code>. If a modem supports multiple preambles, the <code>TxBasebandSignalReq</code> can specify the <code>preamble</code> to be used. Setting the <code>preamble</code> to 0 results in a signal transmission without a preamble. Such a transmission will ordinarily not be received by any modem, unless it is recorded by an explicit <code>RecordBasebandSignalReq</code> at the appropriate time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parameters_3">15.1.2. Parameters</h4>
<div class="paragraph">
<p>Agents offering the baseband service support the following parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandParam.html#carrierFrequency" target="_blank" rel="noopener"><code>carrierFrequency</code></a>&#8201;&#8212;&#8201;default carrier frequency for baseband signals (Hz)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandParam.html#basebandRate" target="_blank" rel="noopener"><code>basebandRate</code></a>&#8201;&#8212;&#8201;default baseband sampling rate for baseband signals (samples/s)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandParam.html#maxPreambleID" target="_blank" rel="noopener"><code>maxPreambleID</code></a>&#8201;&#8212;&#8201;maximum preamble identifier supported</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandParam.html#maxSignalLength" target="_blank" rel="noopener"><code>maxSignalLength</code></a>&#8201;&#8212;&#8201;maximum baseband signal length (in samples) for transmission/reception</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandParam.html#signalPowerLevel" target="_blank" rel="noopener"><code>signalPowerLevel</code></a>&#8201;&#8212;&#8201;signal transmission power level in dB re <code>refPowerLevel</code> (<code>refPowerLevel</code> is specified in the PHYSICAL service)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_capabilities_3">15.1.3. Capabilities</h4>
<div class="paragraph">
<p>Agents may support several optional capabilities:</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandCapability.html#TIMED_BBTX" target="_blank" rel="noopener">TIMED_BBTX</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability are able to transmit signals at specified time (on a best effort basis). The time is given in the <code>txTime</code> attribute of the <code>TxBasebandSignalReq</code> message.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/bb/BasebandCapability.html#TIMED_BBREC" target="_blank" rel="noopener">TIMED_BBREC</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability are able to record signals at specified time (on a best effort basis). The time is given in the <code>recTime</code> attribute of the <code>RecordBasebandSignalReq</code> message.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_baseband_and_passband_signals">15.2. Baseband and passband signals</h3>
<div class="paragraph">
<p>Communication systems usually represent signals in a complex baseband representation, as this allows them to be sampled at a lower sampling rate than real passband signals. Passband signals have to be sampled at more than twice the highest frequency (Nyquist criterion). Baseband signals need to be sampled at more than twice the bandwidth. Since the bandwidth is typically much lesser than the carrier frequency, the baseband representation is usually more economical than the passband representation.</p>
</div>
<div class="paragraph">
<p>While the baseband service is aimed at signals represented in the complex baseband representation, it also supports signals represented as real passband samples. Such signals are identified by setting the <code>fc</code> (carrier frequency) field of the <code>TxBasebandSignalReq</code> or <code>RxBasebandSignalNtf</code> to 0. Modems offering the baseband service may optionally support passband signal transmission and recording.</p>
</div>
<div class="paragraph">
<p>Since Java and Groovy do not support complex numbers natively, the complex baseband signals are represented by an array of floats with alternate samples from the in-phase (real part) and quadrature (imaginary part) channels. In languages that support complex numbers (e.g. Python and Julia), the signals are represented as arrays (or lists) of complex numbers.</p>
</div>
<div class="paragraph">
<p>If all this seems to be confusing, don&#8217;t worry, it&#8217;ll become clear as we go through examples shortly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transmitting_and_recording_arbitrary_signals">15.3. Transmitting and recording arbitrary signals</h3>
<div class="paragraph">
<p>In <a href="#_transmitting_and_recording_arbitrary_acoustic_waveforms">Section 2.7</a>, you already saw how to transmit and record arbitrary signals. We then used the convenience functions <code>bbtx</code> and <code>bbrec</code> for simplicity. In this chapter, we will do the same thing by sending the <code>TxBasebandSignalReq</code> and <code>RecordBasebandSignalReq</code> messages instead. As you&#8217;ll see, these messages provide you greater control, and can also be sent via the UnetSocket API or a fjåge gateway from external applications.</p>
</div>
<div class="paragraph">
<p>Fire up unet audio to try out the examples here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>bin/unet audio
Modem web: http://localhost:8080/</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the shell for the unet audio SDOAM, check which agents provide the baseband service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.BASEBAND<span class="o">)</span>
<span class="go">[phy]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now direct all our requests to the <code>phy</code> agent. Let&#8217;s check the baseband parameters of the <code>phy</code> agent (we omit other parameters here for brevity):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy
<span class="gp">&lt;&lt;&lt; Physical &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.bb.BasebandParam]
  basebandRate = 12000.0
  carrierFrequency = 12000.0
  maxPreambleID = 4
  maxSignalLength = 2147483647
  signalPowerLevel = -10.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the unet audio SDOAM operates at a carrier frequency of 12 kHz and a bandband sampling rate of 12 kSa/s. Let&#8217;s create a DC signal of length 12000 complex baseband samples (24000 floats) and transmit it. A DC signal of length 12000 complex samples with a carrier frequency of 12 kHz is a sinusoidal 12 kHz signal for 1 second.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> <span class="o">[</span>1,0]<span class="k">*</span>12000                 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">[1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1 &lt;&lt;snip&gt;</span><span class="o">&gt;</span> 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0]
<span class="gp">&gt;</span> s.size<span class="o">()</span>
<span class="go">24000
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(signal: s)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:11401231]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In Groovy, we can repeat a list using the "*" operator. The list [1,0] represents a complex number 1+0j. Repeating it 12000 times gets us a 1 second long DC signal.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should hear the sound from your computer speaker.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can generate other frequency signals using the <code>cw()</code> (continuous wave) function available in the shell. You can also save and load signals from text files using the <code>save</code> and <code>load</code> commands. For information on all these commands/functions, simply type <code>help cw</code>, <code>help save</code> or <code>help load</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unet audio supports transmission of passband signals as well. Let us create a half second 2000 kHz passband signal and transmit it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> s <span class="o">=</span> cw<span class="o">(</span>2000, 0.5, 0<span class="o">)</span>                             <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">&gt;</span> s.size<span class="o">()</span>
<span class="go">48000                                              <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(signal: s, fc: 0) <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:414013271]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>cw()</code> function enables us to create baseband or passband continuous wave signals. The third parameter is the carrier frequency. Setting that to 0 creates a baseband signal.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Notice that our signal is 48000 floats for 0.5 seconds. Compare that with the previous DC signal, which was 24000 floats for 1 second.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>fc</code> field is set to 0 to tell <code>phy</code> that the <code>signal</code> is given in passband.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, let&#8217;s request a recording of 12000 samples (1 second duration):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RecordBasebandSignalReq(recLength: 12000)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:11780353 rssi:-79.1 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>12000 baseband samples<span class="o">)]</span>
<span class="gp">&gt;</span> ntf.signal                      <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">[8.611694E-5, 5.8899976E-5, 1.01 &lt;&lt;snip&gt;</span><span class="o">&gt;</span> E-6, <span class="nt">-9</span>.148392E-6, 3.5340495E-6]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>ntf</code> variable holds the last received notification, which in this case is the <code>RxBasebandSignalNtf</code>. The <code>signal</code> field contains the complex baseband recording.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also ask for recordings to begin at a specified time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> t <span class="o">=</span> phy.time + 5000000<span class="p">;</span> println<span class="o">(</span>t<span class="o">)</span><span class="p">;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RecordBasebandSignalReq(recLength: 12000, recTime: t)
</span><span class="go">855949105
AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:855949105 rssi:-90.3 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>12000 baseband samples<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;d have noticed the 6 second delay (5 seconds to begin recording, 1 more second to finish the recording) before the recording notification.</p>
</div>
<div class="paragraph">
<p>Interestingly, you can also request recordings in the past! Many modems have a short buffer, allowing recording in the recent past. Go too far in the past and the modem will refuse your request!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> t <span class="o">=</span> phy.time - 5000000<span class="p">;</span> println<span class="o">(</span>t<span class="o">)</span><span class="p">;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RecordBasebandSignalReq(recLength: 12000, recTime: t)
</span><span class="go">1186471772
AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:1186471772 rssi:-74.6 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>12000 baseband samples<span class="o">)]</span>
<span class="gp">&gt;</span> t <span class="o">=</span> phy.time - 60000000<span class="p">;</span> println<span class="o">(</span>t<span class="o">)</span><span class="p">;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RecordBasebandSignalReq(recLength: 12000, recTime: t)
</span><span class="go">1204946438
REFUSE: Bad start time</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Specifying a negative <code>recTime</code> is understood by the baseband service provider as a relative time. So we can simpify our request to record 5 seconds in the past:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RecordBasebandSignalReq(recLength: 12000, recTime: -5000000)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:1361359020 rssi:-72.9 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>12000 baseband samples<span class="o">)]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transmitting_and_detecting_preambles">15.4. Transmitting and detecting preambles</h3>
<div class="paragraph">
<p>Each logical channel (CONTROL, DATA, etc.) is associated with a detection preamble. Detectors in a modem monitor incoming signals, and trigger when the preamble is detected.</p>
</div>
<div class="paragraph">
<p>We can transmit a preamble easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble: 1)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:5470777099]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we did not specify a signal to transmit, so only the preamble was transmitted. You should have heard the preamble as a short chirp from your computer speaker. If we had specified a signal, the preamble would have been followed by the signal.</p>
</div>
<div class="paragraph">
<p>If you had another unet audio SDOAM running nearby, it would have heard the preamble and detected a CONTROL frame. It would have tried to decode the frame, but failed, as we didn&#8217;t actually transmit anything after the preamble. So you&#8217;d have seen a <code>RxFrameStartNtf</code> followed by a <code>BadFrameNtf</code> if you had subscribed to <code>phy</code> topic on that modem.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t have access to another computer to run unet audio on, we can easily demonstrate the above behavior with a single unet audio SDOAM by simply enabling the full-duplex mode (and hence using the same computer for transmission and reception simultaneously), as we did in <a href="#_physical_service">Chapter 14</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy
<span class="gp">&gt;</span> phy.fullduplex <span class="o">=</span> <span class="nb">true</span>
<span class="go">true
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble:1)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[txTime:5809832016 txDuration:40416]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:5809859766]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:5809825603 rxDuration:2740000 detector:0.9]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> BadFrameNtf:INFORM[type:CONTROL rxTime:5809825603 rssi:-55.6 <span class="o">(</span>18 bytes<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Preambles 1 and 2 are used by the CONTROL and DATA channel respectively. It&#8217;s better not to mess with these, but instead use preamble 3, which is left for the user to configure in unet audio. By default, detection of preamble 3 is disabled. You can enable it by setting the detection threshold <code>phy[3].threshold</code> parameter. Let&#8217;s try it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[3].threshold <span class="o">=</span> 0.25
<span class="go">0.25
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble: 3)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[txTime:6011688016 txDuration:170916]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:6011686599]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:#3 rxTime:6011700270 rxDuration:170500 detector:0.73]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see the <code>RxFrameStartNtf</code> of type #3 indicating that preamble 3 was detected. Since <code>phy[3]</code> is not associated with any modulation scheme, the modem did not generate a <code>BadFrameNtf</code> as it did with preamble 1.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Preambles 1, 2 and 3 are preconfigured on the unet audio SDOAM to be short signals with good autocorrelation properties. You can change these, if you wish, by setting the <code>preamble</code> indexed parameter (type <code>help phy[].preamble</code> for details).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In applications such as sonar or ranging, we may only be interested in the detecting the timing of a known signal. In that case, the <code>RxFrameStartNtf</code> is sufficient for us. But in some applications, we may wish to capture the signal once detected. That can be easily achieved in unet audio by setting the <code>basebandRx</code> parameter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>basebandRx</code> and <code>basebandExtra</code> parameters are provided by the unet audio SDOAM, and work closely with the baseband service. These are not currently part of the baseband service specifications, but are under consideration for adoption as part of the service. Most modems that currently support the baseband service also support these parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you enable <code>basebandRx</code>, a recording will be triggered every time the preamble is detected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[3].basebandRx <span class="o">=</span> <span class="nb">true</span>
<span class="go">true
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble: 3)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[txTime:6992613349 txDuration:170916]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:6992598599]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:#3 rxTime:6992616269 rxDuration:170500 detector:0.78]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:6992616269 rssi:-22.0 preamble:3 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>2046 baseband samples<span class="o">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RxBasebandSignalNtf</code> notified us of the recorded signal (containing just the detected preamble). If we wanted a longer recording after the preamble, we can ask for that using the <code>basebandExtra</code> parameter, specifying the length of the recording (in samples) beyond the preamble:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> phy[3].basebandExtra <span class="o">=</span> 1200     <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">1200
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble: 3)
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[txTime:7143093349 txDuration:170916]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:7143062599]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:#3 rxTime:7143081603 rxDuration:1170500 detector:0.78]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:7143081603 rssi:-36.7 preamble:3 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>3246 baseband samples<span class="o">)]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are requesting 100 ms recording beyond the end of the preamble.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see that the recording is much longer now.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you cross-correlate this recording with the preamble you transmitted, you&#8217;d get an estimate of the impulse response of the channel between your computer speaker and microphone! You can easily obtain the complex baseband representation of preamble #3 that you have been transmitting (<code>phy[3].preamble.signal</code>), if you wanted to try doing this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_baseband_signal_monitor">15.5. Baseband signal monitor</h3>
<div class="paragraph">
<p>During the development of signal processing algorithms, one often wants to simply record received signals in the modem for postprocessing. For this, you could write a script to listen for <code>RxBasebandSignalNtf</code> messages from <code>phy</code> agent&#8217;s topic, and store them in a file. Since this requirement is common, UnetStack already provides an agent which does exactly this. The agent is called <code>BasebandSignalMonitor</code> or <code>bbmon</code> for short.</p>
</div>
<div class="paragraph">
<p>The <code>bbmon</code> agent is already loaded when you run unet audio. However, by default, it is disabled. It&#8217;s easy to enable it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> bbmon.enable <span class="o">=</span> <span class="nb">true</span>
<span class="go">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, every <code>RxBasebandSignalNtf</code> that is sent to <code>phy</code> agent&#8217;s topic will be recorded in a <code>signal-0.txt</code> file in the <code>logs</code> folder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> logs                                           <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">signals-0.txt [0 bytes]                          <i class="conum" data-value="2"></i><b>(2)</b>
results.txt [39 bytes]
phy-log-0.txt [687 bytes]
log-0.txt [4 kB]
</span><span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> TxBasebandSignalReq(preamble: 3)    <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[txTime:102528016 txDuration:170916]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[txTime:102513266]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:#3 rxTime:102531520 rxDuration:270500 detector:0.74]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxBasebandSignalNtf:INFORM[adc:1 rxTime:102531520 rssi:-23.6 preamble:3 <span class="nb">fc</span>:12000.0 fs:12000.0 <span class="o">(</span>3246 baseband samples<span class="o">)]</span>
<span class="gp">&gt;</span> logs
<span class="go">signals-0.txt [34 kB]                            <i class="conum" data-value="4"></i><b>(4)</b>
results.txt [39 bytes]
phy-log-0.txt [687 bytes]
log-0.txt [5 kB]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check the logs folder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We have a <code>signals-0.txt</code> file with no data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Transmit preamble #3. This will trigger a recording, based on the <code>phy[3]</code> configuration from the previous section.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now the <code>signals-0.txt</code> file has grown to 34 kB. It contains the signal that was just recorded.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you record more signals, they are appended to the same file (with delineating metadata for each signal). If you restart unet audio, this file will be renumbered to <code>signals-1.txt</code>, as the logs are rotated.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The name of the signals file and number of files kept through log rotation is configured when the <code>bbmon</code> agent is loaded. This happens in the <code>etc/setup.groovy</code> file in your unet audio installation, and you can change it, if you like.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The signals file stores the signals in a base64 encoded format. The Python package <code>arlpy.unet</code> allows you to read this file and work with the signals in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">arlpy</span>          <i class="conum" data-value="1"></i><b>(1)</b>
<span class="err">$</span> <span class="n">ipython</span>
<span class="n">Python</span> <span class="mf">3.6.8</span> <span class="o">|</span><span class="n">Anaconda</span> <span class="n">custom</span> <span class="p">(</span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="p">)</span><span class="o">|</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">29</span> <span class="mi">2018</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">46</span><span class="p">)</span>
<span class="n">Type</span> <span class="s">'copyright'</span><span class="p">,</span> <span class="s">'credits'</span> <span class="ow">or</span> <span class="s">'license'</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span>
<span class="n">IPython</span> <span class="mf">6.2.1</span> <span class="o">--</span> <span class="n">An</span> <span class="n">enhanced</span> <span class="n">Interactive</span> <span class="n">Python</span><span class="o">.</span> <span class="n">Type</span> <span class="s">'?'</span> <span class="k">for</span> <span class="n">help</span><span class="o">.</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">arlpy</span> <span class="kn">import</span> <span class="n">unet</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">unet</span><span class="o">.</span><span class="n">get_signals</span><span class="p">(</span><span class="s">'logs/signals-0.txt'</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">s</span>                    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">time</span>    <span class="n">rxtime</span>  <span class="n">adc</span>  <span class="n">channels</span>  <span class="n">fc</span> <span class="o">...</span>    <span class="nb">len</span>  <span class="n">preamble</span>  <span class="n">rssi</span>            <span class="n">filename</span>  <span class="n">lno</span>
<span class="mi">0</span>  <span class="mi">1567961114848</span>  <span class="mi">75224853</span>    <span class="mi">1</span>         <span class="mi">1</span>   <span class="mi">0</span> <span class="o">...</span>   <span class="mi">3246</span>         <span class="mi">3</span> <span class="o">-</span><span class="mf">23.6</span>  <span class="n">logs</span><span class="o">/</span><span class="n">signals</span><span class="o">-</span><span class="mf">0.</span><span class="n">txt</span>    <span class="mi">1</span>

<span class="p">[</span><span class="mi">1</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">12</span> <span class="n">columns</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">unet</span><span class="o">.</span><span class="n">get_signal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>              <i class="conum" data-value="3"></i><b>(3)</b>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="p">(</span><span class="mi">3246</span><span class="p">,)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">x</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
<span class="n">array</span><span class="p">([</span> <span class="mf">9.50995535e-02</span><span class="o">-</span><span class="mf">3.77136953e-02j</span><span class="p">,</span>  <span class="mf">1.30487725e-01</span><span class="o">-</span><span class="mf">1.90211199e-02j</span><span class="p">,</span>
        <span class="mf">1.27376720e-01</span><span class="o">+</span><span class="mf">1.91459619e-02j</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
        <span class="mf">8.61445224e-05</span><span class="o">+</span><span class="mf">2.21590763e-05j</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.69901575e-05</span><span class="o">-</span><span class="mf">3.34111392e-05j</span><span class="p">,</span>
        <span class="mf">3.39479702e-05</span><span class="o">-</span><span class="mf">1.82653162e-06j</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Install the <code>arlpy</code> pacakge. You need to do this only if you don&#8217;t already have it installed. The output of this command is omitted here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>s</code> is now a pandas table with an index of all signals available in <code>signals-0.txt</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>x</code> is now signal #0 (first signal) from the <code>signals-0.txt</code> file.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_transmitting_and_receiving_waveforms_directly_from_python">15.6. Transmitting and receiving waveforms directly from Python</h3>
<div class="paragraph">
<p>In the previous section, we showed you how to record signals for postprocessing. This is great if you postprocessing is what you desire, but sometimes it is important to access the functionality in real time from Python. This is very useful while debugging new signal processing algorithms, since tools such as Jupyter notebooks and libraries such as <code>numpy</code>, <code>scipy</code>, <code>pandas</code>, <code>arlpy</code>, and many others have made Python the preferred platform for a lot of scientific computation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try it!</p>
</div>
<div class="paragraph">
<p>You had already installed the Python package <code>unetpy</code> in <a href="#_sending_receiving_from_a_python_application">Section 2.5</a>. We&#8217;ll be using it now, so in case you don&#8217;t have it installed, now is a good time to install it. Start a Jupyter new notebook with Python 3 and connect to your unet audio instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>   <span class="kn">from</span> <span class="nn">unetpy</span> <span class="kn">import</span> <span class="o">*</span>
         <span class="kn">import</span> <span class="nn">arlpy.plot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>   <span class="c1"># connect to the unet audio SDOAM
</span>         <span class="n">sock</span> <span class="o">=</span> <span class="n">UnetSocket</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">1100</span><span class="p">)</span>
         <span class="n">gw</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getGateway</span><span class="p">()</span>

<span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>   <span class="c1"># lookup the agent providing baseband service
</span>         <span class="n">bb</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">agentForService</span><span class="p">(</span><span class="n">Services</span><span class="o">.</span><span class="n">BASEBAND</span><span class="p">)</span>
         <span class="n">bb</span><span class="o">.</span><span class="n">name</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>  <span class="s">'phy'</span>

<span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>   <span class="c1"># transmit preamble 3 -- you should be able to hear it
</span>         <span class="n">bb</span> <span class="o">&lt;&lt;</span> <span class="n">TxBasebandSignalReq</span><span class="p">(</span><span class="n">preamble</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="n">AGREE</span>

<span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>   <span class="c1"># discard old notifications to get ready for a recording
</span>         <span class="n">gw</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>   <span class="c1"># request a recording
</span>         <span class="n">bb</span> <span class="o">&lt;&lt;</span> <span class="n">RecordBasebandSignalReq</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>  <span class="n">AGREE</span>

<span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>   <span class="c1"># obtain the recording notification and check that it's of the correct type
</span>         <span class="n">ntf</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
         <span class="n">ntf</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span>  <span class="n">RxBasebandSignalNtf</span><span class="p">:</span><span class="n">INFORM</span><span class="p">[</span><span class="n">rxTime</span><span class="p">:</span><span class="mi">203329687</span> <span class="n">rssi</span><span class="p">:</span><span class="o">-</span><span class="mf">68.847565</span> <span class="n">adc</span><span class="p">:</span><span class="mi">1</span> <span class="n">fc</span><span class="p">:</span><span class="mf">12000.0</span> <span class="n">fs</span><span class="p">:</span><span class="mf">12000.0</span> <span class="n">channels</span><span class="p">:</span><span class="mi">1</span> <span class="n">preamble</span><span class="p">:</span><span class="mi">0</span> <span class="p">(</span><span class="mi">65536</span> <span class="n">samples</span><span class="p">)]</span>

<span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span>   <span class="c1"># close the connection
</span>         <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">In</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span>  <span class="nb">len</span><span class="p">(</span><span class="n">ntf</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">65536</span>

<span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># plot the first 10000 baseband samples (real/in-phase components only)
</span>         <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ntf</span><span class="o">.</span><span class="n">signal</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">ntf</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/sig1.png" alt="sig1" width="500">
</div>
</div>
<div class="paragraph">
<p>Of course you could do the same thing with Julia or other languages, if you wish, with obvious minor changes to the syntax!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ranging_and_synchronization">16. Ranging and synchronization</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.RANGING</strong></code></p>
</div>
<div class="paragraph">
<p>It is common to use underwater acoustic modems for range estimation, as the travel time of acoustic signals can easily be measured. In <a href="#_propagation_delay_ranging">Section 2.3</a>, we saw that we can use the <code>range</code> command to estimate range between nodes. This command uses the RANGING service described below.</p>
</div>
<div class="paragraph">
<p>Ranging is closely related to time synchronization, since travel time measurement between two nodes requires some sort of synchronization between the nodes. If the nodes are synchronized, one-way travel time (OWTT) can be directly measured and used to estimate range. If the nodes are not synchronized, two-way travel time (TWTT) can be used to measure range and synchronize the nodes simultaneously. The RANGING service supports both modes of ranging, and manages synchronization information between nodes.</p>
</div>
<div class="sect2">
<h3 id="_overview_4">16.1. Overview</h3>
<div class="paragraph">
<p>The RANGING service provides messages and parameters to support OWTT and TWTT ranging, and to manage synchronization information between the nodes.</p>
</div>
<div class="sect3">
<h4 id="_messages_4">16.1.1. Messages</h4>
<div class="paragraph">
<p>The following messages are defined by the RANGING service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeReq.html" target="_blank" rel="noopener"><code>RangeReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;measure range to peer node via OWTT or TWTT</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/BeaconReq.html" target="_blank" rel="noopener"><code>BeaconReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;transmit beacon message for OWTT</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/ClearSyncReq.html" target="_blank" rel="noopener"><code>ClearSyncReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;clear synchronization information for peer node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/SyncInfoReq.html" target="_blank" rel="noopener"><code>SyncInfoReq</code></a> &#8658; <a href="https://unetstack.net/javadoc/org/arl/unet/phy/SyncInfoRsp.html" target="_blank" rel="noopener"><code>SyncInfoRsp</code></a> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;get synchronization information for peer node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeNtf.html" target="_blank" rel="noopener"><code>RangeNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when range information for peer node becomes available</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/BadRangeNtf.html" target="_blank" rel="noopener"><code>BadRangeNtf</code></a>&#8201;&#8212;&#8201;sent to agent&#8217;s topic when invalid range information for peer node indicates potentially outdated synchronization with that node</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The use of these messages will become clearer through examples below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parameters_4">16.1.2. Parameters</h4>
<div class="paragraph">
<p>A few parameters control the behavior of the RANGING service provider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeParam.html#channel" target="_blank" rel="noopener"><code>channel</code></a>&#8201;&#8212;&#8201;channel (DATA/CONTROL) to use for ranging</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeParam.html#lifetime" target="_blank" rel="noopener"><code>lifetime</code></a>&#8201;&#8212;&#8201;lifetime or validity for synchronization information (seconds)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeParam.html#minRange" target="_blank" rel="noopener"><code>minRange</code></a>&#8201;&#8212;&#8201;minimum valid range (m)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeParam.html#maxRange" target="_blank" rel="noopener"><code>maxRange</code></a>&#8201;&#8212;&#8201;maximum valid range (m)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/phy/RangeParam.html#maxBadRangeCnt" target="_blank" rel="noopener"><code>maxBadRangeCnt</code></a>&#8201;&#8212;&#8201;number of <code>BadRangeNtf</code> for peer node to discard synchronization information</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>lifetime</em> of syncrhonization information should be set based on the expected drift of modem clocks. Lifetime is defined as the time for the expected clock drift (scaled by speed of sound in water) to exceed the required range estimation accuracy. If a network uses modems with low-drift clocks (such as oven-controlled oscillators), the lifetime can be quite long (hours to days). Without low-drift clocks, reasonable lifetimes may only be in the order of several minutes to tens of minutes.</p>
</div>
<div class="paragraph">
<p>The minimum and maximum valid range settings control what the RANGING service considers to be a <em>bad range</em>&#8201;&#8212;&#8201;a range measurement that is unlikely to occur in reality (e.g. negative values, or ranges much further than the communication ability of the modems). Frequent bad ranges to a node are used to detect that the node synchronization information is invalid and should be discarded. The number of <code>BadRangeNtf</code> before discarding the synchronization information is specified as <code>maxBadRangeCnt</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2">16.2. Examples</h3>
<div class="paragraph">
<p>In order to understand how the RANGING service provides OWTT and TWTT ranging, it is instructive to try a few examples using the Netiquette 3-node network simulation (<code>bin/unet samples/netq-network.groovy</code>). Start the simulation, and connect to node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService<span class="o">(</span>org.arl.unet.Services.RANGING<span class="o">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">[ranging]
</span><span class="gp">&gt;</span> ranging
<span class="gp">&lt;&lt;&lt; Ranging &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.phy.RangeParam]
  channel = 1                                      <i class="conum" data-value="2"></i><b>(2)</b>
  lifetime = 0                                     <i class="conum" data-value="3"></i><b>(3)</b>
  maxBadRangeCnt = 10
  maxRange = 6500.0
  minRange = -10.0

</span><span class="gp">&gt;</span> range host<span class="o">(</span><span class="s1">'B'</span><span class="o">)</span>                                  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">370.98
</span><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RangeReq(to: host('B'))           <i class="conum" data-value="5"></i><b>(5)</b>
</span><span class="go">AGREE
</span><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:31 to:232 range:371.0 offset:-256067128]
<span class="gp">&gt;</span> ntf.range                                        <i class="conum" data-value="6"></i><b>(6)</b>
<span class="go">370.98</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We see that the <code>ranging</code> agent provides the RANGING service on the node.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The CONTROL channel (channel 1) is being used for ranging.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>lifetime</code> is set to 0, indicating that the node clocks may have a large drift.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>range</code> command provides us the range to node B of almost 1 km.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>range</code> command is implemented by sending a <code>RangeReq</code> to the <code>ranging</code> agent. We directly send that message. As expected, it leads to a <code>RangeNtf</code> message that gives us the same range estimate as the <code>range</code> command. The <code>RangeNtf</code> also provides us time synchronization information between the nodes (in the form of a time <code>offset</code> in microseconds).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>While the <code>RangeNtf</code> showed a range of 371.0 m, this was just due to rounding off for display. The actual value in the message is 370.98 m, as repored previously by the <code>range</code> command.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_two_way_travel_time_ranging">16.2.1. Two-way travel time ranging</h4>
<div class="paragraph">
<p>The range measurement above used TWTT ranging. While node B participated in the range measurement by responding to node A&#8217;s request for a two-way frame exchange, this is all done quietly and we see nothing on node B&#8217;s shell. To see what is happening on both nodes, subscribe to the <code>phy</code> and <code>ranging</code> agent&#8217;s topics on both nodes. Then repeat the <code>RangeReq</code> on node A:</p>
</div>
<div class="listingblock">
<div class="title">Node A:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy
<span class="gp">&gt;</span> subscribe ranging
<span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RangeReq(to: host('B'))
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[type:CONTROL txTime:2546485580 txDuration:950]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:2548827417]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:31 to:232 protocol:1 rxTime:2548827417 txTime:2292518452 <span class="o">(</span>7 bytes<span class="o">)]</span>
<span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:31 to:232 range:371.0 offset:-256067128]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that node A transmitted a CONTROL frame. It then received a timestamped CONTROL frame back from node B. The timing information in both frames was used to compute the range and time offset between the nodes. This was sent back to us as a <code>RangeNtf</code>. This is the frame exchange that implements TWTT ranging.</p>
</div>
<div class="paragraph">
<p>If we look at node B&#8217;s shell at the same time:</p>
</div>
<div class="listingblock">
<div class="title">Node B:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy
<span class="gp">&gt;</span> subscribe ranging
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:2290660289]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:232 to:31 protocol:1 rxTime:2290660289 <span class="o">(</span>1 byte<span class="o">)]</span>
<span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[type:CONTROL txTime:2292518452 txDuration:950]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that node B received a CONTROL frame and responded back with a CONTROL frame.</p>
</div>
<div class="paragraph">
<p>We can ask node A for synchronization information it has gathered:</p>
</div>
<div class="listingblock">
<div class="title">Node A:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('B'))
</span><span class="go">SyncInfoRsp:INFORM[to:31 offset:-256067128 validTill:1568557167512]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that it has stored the time offset to node B, along with a validity. However, you&#8217;ll find that the validity has already expired, since the <code>lifetime</code> parameter was set to 0. If you ask for synchronization information on node B, you&#8217;ll find that it does not have any:</p>
</div>
<div class="listingblock">
<div class="title">Node B:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('A'))
</span><span class="go">REFUSE: Information unavailable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Without synchronization information, OWTT ranging cannot be performed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronization">16.2.2. Synchronization</h4>
<div class="paragraph">
<p>If we have low-drift clocks on all our nodes, we can set the <code>lifetime</code> parameter of the <code>ranging</code> agent to a larger value. Let&#8217;s do that on all nodes. Also unsubscribe from <code>phy</code> to avoid too much clutter, but ensure that you&#8217;re subscribed to <code>ranging</code> on all 3 nodes (node A, node B and node C):</p>
</div>
<div class="listingblock">
<div class="title">Nodes A, B and C:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging.lifetime <span class="o">=</span> 3600
<span class="go">3600
</span><span class="gp">&gt;</span> unsubscribe phy
<span class="gp">&gt;</span> subscribe ranging</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, initiate TWTT ranging to from node A to node B again:</p>
</div>
<div class="listingblock">
<div class="title">Node A:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RangeReq(to: host('B'))
</span><span class="go">AGREE
</span><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:31 to:232 range:371.0 offset:-256067128]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not much of difference here, but if you look at the shell for node B, you&#8217;ll see a notification:</p>
</div>
<div class="listingblock">
<div class="title">Node B:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:232 to:31 range:371.0 offset:256067128]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The information in this <code>RangeNtf</code> is the same as the <code>RangeNtf</code> on node A, except that the <code>to</code> and <code>from</code> fields are exchanged, and the <code>offset</code> has the opposite sign. This makes sense, since the <code>RangeNtf</code> on node B is from node B&#8217;s perspective.</p>
</div>
<div class="paragraph">
<p>But why did node B receive this <code>RangeNtf</code>? If we did a TWTT from node A, node A transmitted a frame, node B responded, and node A computed the two-way travel time. How did node B get that information to generate the <code>RangeNtf</code>? Now that the <code>lifetime</code> is non-zero, node A transmits the range and time offset to node B to synchronize the nodes. We can verify this by asking node B for the synchronization information it has gleaned:</p>
</div>
<div class="listingblock">
<div class="title">Node B:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('A'))
</span><span class="go">SyncInfoRsp:INFORM[to:232 offset:256067128 validTill:1568562001976]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In fact, if you look at the shell for node C, you&#8217;ll see that it hears this information as well, but it does not have any synchronization information to either node A or B:</p>
</div>
<div class="listingblock">
<div class="title">Node C:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('A'))
</span><span class="go">REFUSE: Information unavailable
</span><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('B'))
</span><span class="go">REFUSE: Information unavailable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try TWTT ranging from node A to node C:</p>
</div>
<div class="listingblock">
<div class="title">Node A:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RangeReq(to: host('C'))
</span><span class="go">AGREE
</span><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:74 to:232 range:529.9 offset:630715082]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if you check node C, you&#8217;ll see that it has not only gotten the <code>RangeNtf</code>, but also has stored the synchronization information:</p>
</div>
<div class="listingblock">
<div class="title">Node C:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:232 to:74 range:529.9 offset:-630715082]
<span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('A'))
</span><span class="go">SyncInfoRsp:INFORM[to:232 offset:-630715082 validTill:1568562266302]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Checking node B, we find that it has also heard the exchange between nodes A and C, and gotten a <code>RangeNtf</code> for it. More interestingly, it has synchronization information (time offset) for node C, although we did not ever do a TWTT exchange between nodes B and C! It has inferred the time offset to node C because it knew the time offset to node A, and overheard the time offset between node A and node C!</p>
</div>
<div class="listingblock">
<div class="title">Node B:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:74 to:232 range:529.9]
<span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> SyncInfoReq(to: host('C'))
</span><span class="go">SyncInfoRsp:INFORM[to:74 offset:886782210 validTill:1568562266192]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on two TWTT exchanges, node A knows time offset to nodes B and C, node B knows time offset to nodes A and C, node C knows time offet to node A. Now that we have the nodes somewhat synchronized, we are in a position to try out OWTT now.</p>
</div>
</div>
<div class="sect3">
<h4 id="_one_way_travel_time_ranging">16.2.3. One-way travel time ranging</h4>
<div class="paragraph">
<p>Let&#8217;s transmit a ranging beacon from node A:</p>
</div>
<div class="listingblock">
<div class="title">Node A</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> BeaconReq()
</span><span class="go">AGREE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On node B and C, we see <code>RangeNtf</code> from the OWTT ranging:</p>
</div>
<div class="listingblock">
<div class="title">Node B</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:232 to:31 range:371.0]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Node C</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:232 to:74 range:529.9]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Any timestamped frame transmission from node A will generate <code>RangeNtf</code> on nodes B and C. This can be used to piggyback data (e.g. 42) along with the beacon: <code>phy &lt;&lt; new TxFrameReq(timestamped: true, data: [42])</code>. This will generate a <code>RxFrameNtf</code>
on nodes B and C, if you subscribe to <code>phy</code>, in addition to the <code>RangeNtf</code> messages. This works with both CONTROL and DATA frames.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can also get node A to request node C to transmit a beacon:</p>
</div>
<div class="listingblock">
<div class="title">Node A</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ranging <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> RangeReq(to: host('C'), reqBeacon: true)
</span><span class="go">AGREE
</span><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:74 to:232 range:529.9]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This yeilds a <code>RangeNtf</code> back on node A, giving range from node C to node A. But since node B hears the beacon, and has synchronization information for node C, it also produces a <code>RangeNtf</code> with the range from node C to node B:</p>
</div>
<div class="listingblock">
<div class="title">Node B</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">ranging &gt;</span><span class="o">&gt;</span> RangeNtf:INFORM[from:74 to:31 range:615.9]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have network time synchronization, you can have a lot of fun with OWTT ranging and beacons!</p>
</div>
</div>
<div class="sect3">
<h4 id="_expired_synchronization_information">16.2.4. Expired synchronization information</h4>
<div class="paragraph">
<p>What happens once synchronization information expires? Does the <code>ranging</code> agent no longer get the OWTT <code>RangeNtf</code> messages?</p>
</div>
<div class="paragraph">
<p>The <code>RangeNtf</code> messages are still produced, but the message attribute <code>valid</code> is set to <code>false</code>. This attribute can be used by client agents to initiate a TWTT exchange to renew synchronization information, if necessary. So, if you work with OWTT ranging, remember to check the <code>valid</code> attribute of <code>RangeNtf</code> messages that you receive, to ensure that they are based on unexpired synchronization information and therefore accurate.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_node_information">17. Node information</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.NODE_INFO</strong></code></p>
</div>
<div class="paragraph">
<p>The NODE_INFO service provides a single place to collate node-related information that is commonly needed by many agents. It is a special service, in the sense that each node must be configured to have <strong>one and only one</strong> agent providing this service.</p>
</div>
<div class="sect2">
<h3 id="_overview_5">17.1. Overview</h3>
<div class="paragraph">
<p>An agent implementing the NODE_INFO service not only exposes a set of parameters, as described in this section, but also provides some special handling for specific parameters.</p>
</div>
<div class="sect3">
<h4 id="_parameters_5">17.1.1. Parameters</h4>
<div class="paragraph">
<p>An agent offering the NODE_INFO service supports several parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#nodeName" target="_blank" rel="noopener"><code>nodeName</code></a>&#8201;&#8212;&#8201;node name</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#address" target="_blank" rel="noopener"><code>address</code></a>&#8201;&#8212;&#8201;node address</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#addressSize" target="_blank" rel="noopener"><code>addressSize</code></a>&#8201;&#8212;&#8201;address size in bits (valid values are 8 or 16)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#time" target="_blank" rel="noopener"><code>time</code></a>&#8201;&#8212;&#8201;node time (read-only)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#canForward" target="_blank" rel="noopener"><code>canForward</code></a>&#8201;&#8212;&#8201;true if the node will forward datagrams to other nodes (routing)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#origin" target="_blank" rel="noopener"><code>origin</code></a>&#8201;&#8212;&#8201;origin (latitude, longitude)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#location" target="_blank" rel="noopener"><code>location</code></a>&#8201;&#8212;&#8201;location (x, y, z) m if origin set, otherwise (latitude, longitude, z)</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#mobility" target="_blank" rel="noopener"><code>mobility</code></a>&#8201;&#8212;&#8201;true if the node is mobile, false if it is fixed</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#speed" target="_blank" rel="noopener"><code>speed</code></a>&#8201;&#8212;&#8201;speed (m/s), if mobile node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#heading" target="_blank" rel="noopener"><code>heading</code></a>&#8201;&#8212;&#8201;heading (deg, 0 is North, clockwise), if mobile node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#turnRate" target="_blank" rel="noopener"><code>turnRate</code></a>&#8201;&#8212;&#8201;turn rate (deg/s, clockwise), if mobile node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#diveRate" target="_blank" rel="noopener"><code>diveRate</code></a>&#8201;&#8212;&#8201;dive rate (m/s), if mobile node</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any changes to parameters <code>nodeName</code>, <code>address</code>, <code>addressSize</code>, <code>origin</code> or <code>location</code> are published as <code>ParamChangeNtf</code> to the agent&#8217;s topic (in addition to the <code>PARAMCHANGE</code> topic that all parameter changes are automatically published to&#8201;&#8212;&#8201;see <a href="#_state_persistence">Chapter 24</a>). This is to facilitate monitoring of changes to these important parameters by other agents, simply by subscribing to the NODE_INFO service provider&#8217;s topic.</p>
</div>
<div class="paragraph">
<p>Additionally, if time stability or location accuracy information is available, the following parameters are populated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#timeStability" target="_blank" rel="noopener"><code>timeStability</code></a>&#8201;&#8212;&#8201;time stability in ppm</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/nodeinfo/NodeInfoParam.html#locationAccuracy" target="_blank" rel="noopener"><code>locationAccuracy</code></a>&#8201;&#8212;&#8201;location accuracy (x, y, z) m</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_notes">17.1.2. Notes</h4>
<div class="ulist">
<ul>
<li>
<p>See <a href="#_node_names_and_addresses">Section 4.1</a> for a discussion on <code>nodeName</code>, <code>address</code> and <code>addressSize</code>.</p>
</li>
<li>
<p>See <a href="#_node_locations_coordinate_systems">Section 5.6</a> for a discussion on <code>origin</code>, <code>location</code> and coordinate systems.</p>
</li>
<li>
<p>If node <code>mobility</code> is enabled, the agent may automatically update <code>location</code> based on motion parameters such as <code>speed</code>, <code>heading</code>, etc.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example">17.2. Example</h3>
<div class="paragraph">
<p>If you start the mission2013 network simulation (<code>bin/unet samples/mission2013-network.groovy</code>), connect to node 21&#8217;s shell and type <code>node</code>, you&#8217;ll see the NODE_INFO parameters for the node in this network:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> node
<span class="gp">&lt;&lt;&lt; NodeInfo &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.nodeinfo.NodeInfoParam]
  address = 21
  addressSize = 8
  canForward = true
  diveRate = 0
  heading = 0
  location = [-512.0, 248.8, -6.0]
  mobility = false
  nodeName = 21
  origin = [1.217, 103.743]
  speed = 0
  time = Sun Sep 15 20:31:49 SGT 2019
  turnRate = 0</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_address_resolution">18. Address resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.ADDRESS_RESOLUTION</strong></code></p>
</div>
<div class="sect2">
<h3 id="_overview_6">18.1. Overview</h3>
<div class="paragraph">
<p>An ADDRESS_RESOLUTION service provider is responsible for address allocation and resolution. The size of the address space is detemined by the <code>addressSize</code> parameter of the NODE_INFO service (<a href="#_node_information">Chapter 17</a>).</p>
</div>
<div class="sect3">
<h4 id="_messages_5">18.1.1. Messages</h4>
<div class="paragraph">
<p>Agents supporting this service honor the following requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/addr/AddressAllocReq.html" target="_blank" rel="noopener"><code>AddressAllocReq</code></a> &#8658; <a href="https://unetstack.net/javadoc/org/arl/unet/addr/AddressAllocRsp.html" target="_blank" rel="noopener"><code>AddressAllocRsp</code></a> / <code>FAILURE</code>&#8201;&#8212;&#8201;request for allocation of address to node</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/addr/AddressResolutionReq.html" target="_blank" rel="noopener"><code>AddressResolutionReq</code></a> &#8658; <a href="https://unetstack.net/javadoc/org/arl/unet/addr/AddressResolutionRsp.html" target="_blank" rel="noopener"><code>AddressResolutionRsp</code></a> / <code>FAILURE</code>&#8201;&#8212;&#8201;resolve node name to address</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_usage_and_notes">18.2. Usage and notes</h3>
<div class="paragraph">
<p>Shell usage of this service via the <code>host</code> command is described in <a href="#_node_names_and_addresses">Section 4.1</a>. In this section, we show examples of how address allocation and address resolution can be implemented directly by sending messages.</p>
</div>
<div class="paragraph">
<p>Address allocation is typically required at startup, and usually initiated by the agent providing the NODE_INFO service to populate the <code>address</code> parameter of that service. To ask the ADDRESS_RESOLUTION service provider to allocate an address, an agent sends it a <code>AddressAllocReq</code>. The allocation may depend on the node name, and so the request must contain the node name.</p>
</div>
<div class="paragraph">
<p>We can start the 2-node network, and manually test this on the shell of node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> a <span class="o">=</span> agentForService<span class="o">(</span>org.arl.unet.Services.ADDRESS_RESOLUTION<span class="o">)</span><span class="p">;</span>
<span class="gp">&gt;</span> a <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> AddressAllocReq(name: 'A')
</span><span class="go">AddressAllocRsp:INFORM[address:232]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Address resolution is performed via the <code>AddressResolutionReq</code> message. The <code>host</code> command sends this message on your behalf, and shows you the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> a <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> AddressResolutionReq(name: 'A')
</span><span class="go">AddressResolutionRsp:INFORM[address:232 name:A]
</span><span class="gp">&gt;</span> ans.address
<span class="go">232
</span><span class="gp">&gt;</span> host<span class="o">(</span><span class="s1">'A'</span><span class="o">)</span>
<span class="go">232</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While the address allocation and resolution processes might seem very similar, there is a conceptual difference between the two. Address allocation is performed for a new node without an address. The address allocation process associates it with an address. Address resolution is performed to find the address that was assigned to a node.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The default ADDRESS_RESOLUTION service provider uses a hashing function to map node names to addresses. This enables it to allocate and resolve addresses without generating network traffic (at the cost of manual checking due to a small probability of duplicate addresses). The hashing mechanism is not time-dependent, and so in the special case of this agent, the distinction between address allocation and resolution is blurred.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Network designers and protocol developers should not rely on the ADDRESS_RESOLUTION service provider being based on a hashing function for correct operation of the network.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_medium_access_control">19. Medium access control</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.MAC</strong></code></p>
</div>
<div class="sect2">
<h3 id="_overview_7">19.1. Overview</h3>
<div class="paragraph">
<p>Agents offering the medium access control (MAC) service advise other agents on when they may be permitted to make transmissions, in an effort to reduce collisions and improve network throughput.</p>
</div>
<div class="paragraph">
<p>MAC protocols that use PDUs for channel reservation may support piggybacking of client data in the PDU. If such support is available, it is advertised using a non-zero <code>reservationPayloadSize</code> parameter. A <code>ReservationReq</code> should provide the payload data to be sent to a peer node (as part of RTS or equivalent PDU) to whom the reservation is made. If that node wishes to send payload data back (as part of CTS or equivalent PDU), it may send a <code>ReservationAcceptReq</code> in response to a <code>ReservationStatusNtf</code> to provide its payload data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Protocol data units (PDUs) are protocol-specific datagrams exchanged by nodes in a network. MAC protocls that use a handshake often use three basic type of PDUs&#8201;&#8212;&#8201;request to send (RTS), clear to send (CTS) and acknowledgement (ACK).
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is a payload?</div>
<div class="paragraph">
<p>We talk about MAC service&#8217;s support for payloads quite a bit in this chapter, but what exactly is a payload?</p>
</div>
<div class="paragraph">
<p>A <em>payload</em> is a few bytes of data that can be carried by a MAC PDU on behalf of the user or another agent, without consuming significant additional resources (time or energy). It is essentially an optimization for a low bandwidth network, reducing the need for additional datagrams to be transmitted to convey a few bytes of side information from other agents. For example, a LINK agent might send power control information as payload during a CTS-RTS exchange to optimize transmission power. Or it might send channel state information to aid in adaptive modulation to optimize link throughput.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_messages_6">19.1.1. Messages</h4>
<div class="paragraph">
<p>Agents supporting the MAC service provide messages to request, grant and cancel reservations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/ReservationReq.html" target="_blank" rel="noopener"><code>ReservationReq</code></a> &#8658; <a href="https://unetstack.net/javadoc/org/arl/unet/mac/ReservationRsp.html" target="_blank" rel="noopener"><code>ReservationRsp</code></a> / <code>REFUSE</code>&#8201;&#8212;&#8201;request a reservation</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/ReservationCancelReq.html" target="_blank" rel="noopener"><code>ReservationCancelReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code>&#8201;&#8212;&#8201;cancel a reservation</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/ReservationAcceptReq.html" target="_blank" rel="noopener"><code>ReservationAcceptReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code>&#8201;&#8212;&#8201;request piggybacking of payload in a reservation PDU, typically sent by a client on receiving a <code>ReservationStatusNtf[status: REQUEST]</code> notification</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/TxAckReq.html" target="_blank" rel="noopener"><code>TxAckReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code>&#8201;&#8212;&#8201;request transmission of acknowledgement payload</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/ReservationStatusNtf.html" target="_blank" rel="noopener"><code>ReservationStatusNtf</code></a>&#8201;&#8212;&#8201;sent to requestor or agent&#8217;s topic when a reservation-related events occur</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_parameters_6">19.1.2. Parameters</h4>
<div class="paragraph">
<p>Agents offering the MAC service support the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacParam.html#channelBusy" target="_blank" rel="noopener"><code>channelBusy</code></a>&#8201;&#8212;&#8201;true if channel is busy, false otherwise</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacParam.html#reservationPayloadSize" target="_blank" rel="noopener"><code>reservationPayloadSize</code></a>&#8201;&#8212;&#8201;maximum size of payload (bytes) that can be piggybacked in a reservation PDU</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacParam.html#ackPayloadSize" target="_blank" rel="noopener"><code>ackPayloadSize</code></a>&#8201;&#8212;&#8201;maximum size of acknowledgement (bytes) that can be included in an ACK PDU</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacParam.html#maxReservationDuration" target="_blank" rel="noopener"><code>maxReservationDuration</code></a>&#8201;&#8212;&#8201;maximum duration of reservation in seconds</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacParam.html#recommendedReservationDuration" target="_blank" rel="noopener"><code>recommendedReservationDuration</code></a>&#8201;&#8212;&#8201;recommended duration of reservation in seconds (null, if unspecified)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_capabilities_4">19.1.3. Capabilities</h4>
<div class="paragraph">
<p>Agents may support several optional capabilities:</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacCapability.html#RELIABILITY" target="_blank" rel="noopener">RELIABILITY</a></strong></p>
</div>
<div class="paragraph">
<p>An agent advertising this capability must be able to send acknowlegements as part of the MAC protocol. The agent must support the <code>TxAckReq</code> request to provide acknowledgement payload to be transmitted to the peer node at the end of the reservation. On reception, this should generate a <code>RxAckNtf</code> on the peer node.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacCapability.html#PRIORITY" target="_blank" rel="noopener">PRIORITY</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability must honor priority settings in the reservation request.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacCapability.html#TTL" target="_blank" rel="noopener">TTL</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability must honor time-to-live settings in the reservation request.</p>
</div>
<div class="paragraph">
<p><strong><a href="https://unetstack.net/javadoc/org/arl/unet/mac/MacCapability.html#TIMED_RESERVATION" target="_blank" rel="noopener">TIMED_RESERVATION</a></strong></p>
</div>
<div class="paragraph">
<p>Agents advertising this capability must support scheduling of reservations in the future, through the use of the <code>startTime</code> attribute of the <code>ReservationReq</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_mac_functionality">19.2. Basic MAC functionality</h3>
<div class="paragraph">
<p>MAC agents advise other agents that wish to transmit (we shall call them <em>clients</em>) on when they may do so. MAC agents make channel reservations on behalf of their clients, as necessary. Some MAC protocols such as Aloha and TDMA may not require explicit handshake for reservation, while others such as MACA and FAMA may involve control packet exchanges between peer MAC agents on various nodes. In either case, a typical client with data to transmit starts by asking the prevailing MAC agent for a channel reservation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="c1">// client wishes to transmit data to "destination" for specified "duration"</span>
<span class="kt">def</span> <span class="n">mac</span> <span class="o">=</span> <span class="n">agentForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">MAC</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">mac</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">def</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationReq</span><span class="o">(</span><span class="nl">recipient:</span> <span class="n">mac</span><span class="o">,</span> <span class="nl">to:</span> <span class="n">destination</span><span class="o">,</span> <span class="nl">duration:</span> <span class="n">duration</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="kt">def</span> <span class="n">rsp</span> <span class="o">=</span> <span class="n">request</span><span class="o">(</span><span class="n">req</span><span class="o">)</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">rsp</span> <span class="o">&amp;&amp;</span> <span class="n">rsp</span><span class="o">.</span><span class="na">performative</span> <span class="o">==</span> <span class="n">Performative</span><span class="o">.</span><span class="na">AGREE</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">ntf</span> <span class="o">=</span> <span class="n">receive</span><span class="o">(</span><span class="n">ReservationStatusNtf</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span>       <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="k">if</span> <span class="o">(</span><span class="n">ntf</span> <span class="o">&amp;&amp;</span> <span class="n">ntf</span><span class="o">.</span><span class="na">inReplyTo</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="na">messageID</span> <span class="o">&amp;&amp;</span> <span class="n">ntf</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//    :</span>
      <span class="c1">// transmit data for requested duration</span>
      <span class="c1">//    :</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send a channel reservation request.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Wait for a channel reservation notification.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the above sample code, error handling has been omitted for simplicity. In reality, you would want to have else clauses to handle reservation failures. The MAC agent not only sends a <code>ReservationStatusNtf[status: START]</code> notification, but also a <code>ReservationStatusNtf[status: END]</code> notification at the end of the reservation duration. The sample code above ignores this notification, but a well-behaved client should ensure that the transmission does not exceed the requested duration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_mac_payloads">19.3. Working with MAC payloads</h3>
<div class="paragraph">
<p>Messages such as <code>ReservationReq</code> and <code>ReservationStatusNtf</code> may carry payloads, when the MAC protocol supports them. When payloads are supported, additional messages such as <code>ReservationAcceptReq</code>, <code>TxAckReq</code> and <code>TxAckNtf</code> are available for clients to provide payloads to the MAC service provider to piggyback on the MAC PDUs. A typical exchange is illustrated in <a href="#fig_mac">Figure 8</a>.</p>
</div>
<div id="fig_mac" class="imageblock">
<div class="content">
<img src="images/mac.png" alt="mac">
</div>
<div class="title">Figure 8. Typical message exchange for MAC with payloads and ACK.</div>
</div>
<div class="paragraph">
<p>For a MAC reservation initiated by node A with node B, we elaborate on the steps for a full reservation lifecycle with payloads:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On node A, the client (agent) sends a <code>ReservationReq</code> to the MAC (agent), with an optional payload. The MAC accepts the request.</p>
</li>
<li>
<p>MAC on node A sends a RTS PDU with the payload to the MAC on node B.</p>
</li>
<li>
<p>MAC on node B generates a <code>ReservationStatusNtf[status: REQUEST]</code> message and publishes it on its topic. A client subscribing to this topic receives the notification.</p>
</li>
<li>
<p>If the client on node B wants to send back some payload with the CTS PDU, it immediately sends a <code>ReservationAcceptReq</code> to the MAC, with the payload.</p>
</li>
<li>
<p>The MAC accepts the request and responds to node A&#8217;s MAC with a clients PDU containing the payload.</p>
</li>
<li>
<p>The payload is delivered to the client on node A as part of a <code>ReservationStatusNtf[status: START]</code> message marking the start of the reservation time.</p>
</li>
<li>
<p>During the reservation, the two nodes exchange data as they wish.</p>
</li>
<li>
<p>If the client on node B wishes to provide an acknowledgment (with a payload), it sends a <code>TxAckReq</code> message before the reservation duration ends, and the MAC on node B accepts.</p>
</li>
<li>
<p>The MAC on node B sends an ACK PDU with the payload to the MAC on node A. The ACK PDU marks the end of the channel reservation. The MAC delivers this acknowledgment payload to the client on node A as a part of the <code>ReservationStatusNtf[status: END]</code> message.</p>
</li>
<li>
<p>If node B does not send an ACK PDU, when the channel reservation ends, the MAC on node A sends a <code>ReservationStatusNtf[status: END]</code> message to its client.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_examples_3">19.4. Examples</h3>
<div class="paragraph">
<p>Sample MAC implementations are illustrated in <a href="#_implementing_network_protocols">Chapter 28</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_single_hop_links">20. Single-hop links</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.LINK</strong></code></p>
</div>
<div class="sect2">
<h3 id="_overview_8">20.1. Overview</h3>
<div class="paragraph">
<p>Agents offering the LINK service provide single-hop communication.</p>
</div>
<div class="paragraph">
<p>Single-hop here refers to a single hop in the Unet sense. For example, a link may be provided over wireless RF network that has multiple physical hops (e.g. using UDP/IP). However, as long as the link does not pass through multiple Unet nodes, it is considered a logically single-hop link.</p>
</div>
<div class="paragraph">
<p>All agents supporting the PHYSICAL service must also support the DATAGRAM service (<a href="#_datagram_service">Chapter 13</a>).</p>
</div>
<div class="paragraph">
<p>It is recommended that agents offering the LINK service provide reliability, when requested. Agents that are able to provide reliability, do so by advertising the DATAGRAM service capability RELIABILITY.</p>
</div>
<div class="paragraph">
<p>LINK service providers using the PHYSICAL service should also consult the MAC service to determine when they should transmit.</p>
</div>
<div class="paragraph">
<p>In a typical Unet, gateway nodes may have several LINK service providers, with the ROUTING service provider forwarding datagrams across links.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routing_and_route_maintenance">21. Routing and route maintenance</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transport_and_reliability">22. Transport and reliability</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remote_access">23. Remote access</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_state_persistence">24. State persistence</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.unet.Services.STATE_MANAGER</strong></code></p>
</div>
<div class="sect2">
<h3 id="_overview_9">24.1. Overview</h3>
<div class="paragraph">
<p>An agent offering the STATE_MANAGER service provides a way to save the state (parameter values) of specified (or all) agents.</p>
</div>
<div class="paragraph">
<p>Such an agent typically subscribes to the <a href="https://unetstack.net/javadoc/org/arl/unet/Topics.html#PARAMCHANGE" target="_blank" rel="noopener"><code>PARAMCHANGE</code></a> topic and monitor <code>ParamChangeNtf</code> for all parameter changes for all agents. It then helps persist selected agents' parameter values between reboots.</p>
</div>
<div class="sect3">
<h4 id="_messages_7">24.1.1. Messages</h4>
<div class="paragraph">
<p>STATE_MANAGER service providers honor the following messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/state/SaveStateReq.html" target="_blank" rel="noopener"><code>SaveStateReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;save agent state to a file</p>
</li>
<li>
<p><a href="https://unetstack.net/javadoc/org/arl/unet/state/ClearStateReq.html" target="_blank" rel="noopener"><code>ClearStateReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;clear agent state in memory, and track only parameter changes henceforth</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>SaveStateReq</code> message causes the agent state (changed parameters) to be persisted to a Groovy script file in the <code>scripts</code> folder. The default name of the file is <code>saved-state.groovy</code>, and this file is automatically loaded on startup. However, the <code>SaveStateReq</code> message can specify an alternate filename to persist the state in. In such cases, the file is run manually when the state is to be restored.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_4">24.2. Examples</h3>
<div class="paragraph">
<p>Fire up unet audio (<code>bin/unet audio</code>) to test out how state persistence works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -10.0
phy[2].powerLevel = -10.0
phy[3].powerLevel = -10.0
phy[4].powerLevel = -10.0
phy.signalPowerLevel = -10.0
</span><span class="gp">&gt;</span> plvl <span class="nt">-40</span>
<span class="go">OK
</span><span class="gp">&gt;</span> shutdown</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start unet audio again, and you&#8217;ll find that the <code>plvl</code> state was not retained through reboots:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -10.0
phy[2].powerLevel = -10.0
phy[3].powerLevel = -10.0
phy[4].powerLevel = -10.0
phy.signalPowerLevel = -10.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can ask it to retain the state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl <span class="nt">-40</span>
<span class="go">OK
</span><span class="gp">&gt;</span> savestate                       <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AGREE
</span><span class="gp">&gt;</span> <span class="nb">ls</span>
<span class="go">README.md [759 bytes]
saved-state.groovy [156 bytes]    <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp">&gt;</span> shutdown</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>savestate</code> command just sends a <code>SaveStateReq</code> message to the STATE_MANAGER service provider.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>saved-state.groovy</code> file is created with all the parameter changes to all agents.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start unet audio again, and you&#8217;ll find that the state is retained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -40.0
phy[2].powerLevel = -40.0
phy[3].powerLevel = -40.0
phy[4].powerLevel = -40.0
phy.signalPowerLevel = -40.0
</span><span class="gp">&gt;</span> shutdown</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>saved-state.groovy</code> is human-readable, and you&#8217;ll see that it simply contains the Groovy code to set the parameters required to restore the state:</p>
</div>
<div class="listingblock">
<div class="title">saved-state.groovy:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">def</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">agent</span><span class="o">(</span><span class="s1">'phy'</span><span class="o">)</span>
<span class="n">phy</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">powerLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.0</span>
<span class="n">phy</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">powerLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.0</span>
<span class="n">phy</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="na">powerLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.0</span>
<span class="n">phy</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="na">powerLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.0</span>
<span class="n">phy</span><span class="o">.</span><span class="na">signalPowerLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete this file and start unet audio again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">help </span>savestate
<span class="go">savestate - save state of all or specified agent in Groovy script format

Examples:
  savestate 'pandan'          // save current state of all agents
  savestate 'pandan', 'phy'   // save current state of specified agent
  savestate 'pandan', phy     // save current state of specified agent
  savestate                   // save current state in "saved-state.groovy"

</span><span class="gp">&gt;</span> <span class="nb">help </span>clrstate
<span class="go">clrstate - set current state as the baseline for savestate

Example:
  clrstate                    // set baseline state
  phy[1].powerLevel = -10     // change parameters
  savestate                   // save changed parameters</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The help shows you that the <code>savestate</code> command can be used to save the state of individual agents, if you wish, to a filename of your choice. If you save the state to a different filename, it is not automatically restored on startup. But you can restore it easily with a single command (name of the file):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -10.0
phy[2].powerLevel = -10.0
phy[3].powerLevel = -10.0
phy[4].powerLevel = -10.0
phy.signalPowerLevel = -10.0
</span><span class="gp">&gt;</span> plvl <span class="nt">-40</span>
<span class="go">OK
</span><span class="gp">&gt;</span> savestate <span class="s1">'p40'</span>, phy            <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AGREE
</span><span class="gp">&gt;</span> plvl <span class="nt">-10</span>                        <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">OK
</span><span class="gp">&gt;</span> <span class="nb">ls</span>
<span class="go">README.md [759 bytes]
p40.groovy [156 bytes]            <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="gp">&gt;</span> p40                             <i class="conum" data-value="4"></i><b>(4)</b>
<span class="gp">&gt;</span> plvl
<span class="go">phy[1].powerLevel = -40.0
phy[2].powerLevel = -40.0
phy[3].powerLevel = -40.0
phy[4].powerLevel = -40.0
phy.signalPowerLevel = -40.0</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Save the <code>plvl -40</code> state to a file called <code>p40.groovy</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Change the state.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The state is saved in the <code>p40.groovy</code> file in the <code>scripts</code> folder.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Command <code>p40</code> runs the <code>p40.groovy</code> file to restore the state to <code>plvl -40</code>.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Startup scripts</div>
<div class="paragraph">
<p>While the STATE_MANAGER service provides a convenient way to save the current state, sometimes you may wish to write a customized startup script that sets up the node the way you wish. This can be achieved via the <code>setup.groovy</code> and <code>startup.groovy</code> scripts in the <code>scripts</code> folder.</p>
</div>
<div class="paragraph">
<p>If you create a <code>setup.groovy</code> script, the default stack is disabled, allowing you to customize the agents that are loaded. The only agents that are automatically loaded if this script is present are the NODE_INFO, PHYSICAL and SHELL agents. The <code>setup.groovy</code> script is called during the setup phase of bootup, when agents are being loaded. It is the responsibility of the <code>setup.groovy</code> script to setup the rest of the stack by loading appropriate agents.</p>
</div>
<div class="paragraph">
<p>If you create a <code>startup.groovy</code> script, it is called after all agents are loaded and the stack is fully initialized. You may put Groovy commands in this script to customize your agent parameters and other settings. The <code>startup.groovy</code> script is called before the <code>saved-state.groovy</code> script, if one exists.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheduler">25. Scheduler</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shell">26. Shell</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code><strong>org.arl.fjage.shell.Services.SHELL</strong></code></p>
</div>
<div class="paragraph">
<p>The SHELL service provides a way to run commands and access files on a node. It is used by agents providing the REMOTE service to support remote execution of commands from other nodes.</p>
</div>
<div class="sect2">
<h3 id="_overview_10">26.1. Overview</h3>
<div class="paragraph">
<p>Agents providing the SHELL service support execution of commands, and access to files on the node. While shell agents typically provide interactivity using a terminal/console, they also support messages for other agents to request execution of commands or access to files.</p>
</div>
<div class="sect3">
<h4 id="_messages_8">26.1.1. Messages</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/ShellExecReq.html" target="_blank" rel="noopener"><code>ShellExecReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;execute a command</p>
</li>
<li>
<p><a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/GetFileReq.html" target="_blank" rel="noopener"><code>GetFileReq</code></a> &#8658; <a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/GetFileRsp.html" target="_blank" rel="noopener"><code>FileGetRsp</code></a> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;read a file or directory contents</p>
</li>
<li>
<p><a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/PutFileReq.html" target="_blank" rel="noopener"><code>PutFileReq</code></a> &#8658; <code>AGREE</code> / <code>REFUSE</code> / <code>FAILURE</code>&#8201;&#8212;&#8201;write contents to a file, or delete a file</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_script_engines">26.2. Script engines</h3>
<div class="paragraph">
<p>The language in which the commands are written is not defined by the service, but depends on the shell agent. fjåge supports a pluggable mechanism for an <a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/ShellAgent.html" target="_blank" rel="noopener"><code>ShellAgent</code></a> to use any <a href="http://org-arl.github.io/fjage/javadoc/org/arl/fjage/shell/ScriptEngine.html" target="_blank" rel="noopener"><code>ScriptEngine</code></a>. Various script engines are available in fjåge and UnetStack, including the <code>GroovyScriptEngine</code>, <code>EchoScriptEngine</code>, and <code>ATScriptEngine</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples_5">26.3. Examples</h3>
<div class="paragraph">
<p>Start the 2-node network and connect to node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> agentsForService org.arl.fjage.shell.Services.SHELL                  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">[websh]
</span><span class="gp">&gt;</span> websh.send new ShellExecReq<span class="o">(</span>cmd: <span class="s1">'file("foobar").text = "FOOBAR";'</span><span class="o">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="gp">websh &gt;</span><span class="o">&gt;</span> AGREE
<span class="gp">&gt;</span> <span class="nb">ls</span>                                                                   <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">foobar [6 bytes]
README.md [759 bytes]
</span><span class="gp">&gt;</span> file<span class="o">(</span><span class="s2">"foobar"</span><span class="o">)</span>.text                                                  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">FOOBAR</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We find that <code>websh</code> is the agent that provides us the SHELL service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We send a command to <code>websh</code> to execute, and it agrees to do so. Since the commands we type are also executed by the <code>websh</code> agent, we need to be careful to not block the execution. Hence we use a <code>send</code> rather than a <code>request</code> (or equivalently <code>&lt;&lt;</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The command was to create a <code>foobar</code> file, so we check that the file is created.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We read the contents of the <code>foobar</code> file to confirm that <code>FOOBAR</code> was correctly written to it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, let&#8217;s try the <code>GetFileReq</code> and <code>PutFileReq</code> messages to read, write and delete this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> websh.send new GetFileReq<span class="o">(</span>filename: <span class="s1">'scripts/foobar'</span><span class="o">)</span>                <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">websh &gt;</span><span class="o">&gt;</span> INFORM: GetFileRsp
<span class="gp">&gt;</span> ntf.contents                                                         <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">[70, 79, 79, 66, 65, 82]
</span><span class="gp">&gt;</span> new String<span class="o">(</span>ntf.contents<span class="o">)</span>                                             <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">FOOBAR
</span><span class="gp">&gt;</span> websh.send new PutFileReq<span class="o">(</span>filename: <span class="s1">'scripts/foobar'</span>, contents: <span class="s1">'foooobaaaar'</span><span class="o">)</span>
<span class="gp">websh &gt;</span><span class="o">&gt;</span> AGREE                                                         <i class="conum" data-value="4"></i><b>(4)</b>
<span class="gp">&gt;</span> file<span class="o">(</span><span class="s1">'foobar'</span><span class="o">)</span>.text                                                  <i class="conum" data-value="5"></i><b>(5)</b>
<span class="go">foooobaaaar
</span><span class="gp">&gt;</span> websh.send new PutFileReq<span class="o">(</span>filename: <span class="s1">'scripts/foobar'</span>, contents: null<span class="o">)</span>
<span class="gp">websh &gt;</span><span class="o">&gt;</span> AGREE                                                         <i class="conum" data-value="6"></i><b>(6)</b>
<span class="gp">&gt;</span> <span class="nb">ls</span>
<span class="go">README.md [759 bytes]
</span><span class="gp">&gt;</span> websh.send new GetFileReq<span class="o">(</span>filename: <span class="s1">'scripts'</span><span class="o">)</span>                       <i class="conum" data-value="7"></i><b>(7)</b>
<span class="gp">websh &gt;</span><span class="o">&gt;</span> INFORM: GetFileRsp
<span class="gp">&gt;</span> new String<span class="o">(</span>ntf.contents<span class="o">)</span>
<span class="go">README.md       759     1568297372000                                  <i class="conum" data-value="8"></i><b>(8)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The file <code>foobar</code> was created in the <code>scripts</code> folder, which is the default location for the <code>file()</code> function. We ask to read the file, and get a <code>GetFileRsp</code> response back.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The file contents are read back as a list of bytes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We convert the list of bytes to a String to get our <code>FOOBAR</code> contents.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We send a <code>PutFileReq</code> to change the contents of the file.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We verify that the file contents were indeed changed, as requested.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Sending a <code>PutFileReq</code> with <code>contents</code> set to <code>null</code> deletes the file.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Asking for the contents of a directory using <code>GetFileReq</code> gets us the directory listing back.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The listing consists of all files in the directory, one file per line. Each line has a filename, file size and file modificiation timestamp (epoch time). If a file is a directory, the filename is suffixed by a <code>/</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We interacted with the SHELL service provider using a shell! That&#8217;s not very useful in practice, but served to show you how these messages work. Typically, these messages are sent by other agents that wish to get the shell to run commands and access files for them. The agents may be running remotely in a fjåge slave container or on a gateway (via the UnetSocket API), where they may not have direct access to the filesystem of the node.</p>
</div>
</div>
</div>
</div>
<h1 id="_part_v_extending_unetstack" class="sect0"><strong>Part V: Extending UnetStack</strong></h1>
<div class="sect1">
<h2 id="_developing_your_own_agents">27. Developing your own agents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By now, you should be very familiar with the concept of agents. You have interacted with them via commands and messages throughout this handbook, but what exactly is an agent?</p>
</div>
<div class="paragraph">
<p>If you lookup the Wikipedia entry for a software agent, you&#8217;ll find:</p>
</div>
<div class="quoteblock">
<blockquote>
The term <strong>agent</strong> describes a software abstraction, an idea, or a concept, similar to object-oriented programming terms such as methods, functions, and objects. The concept of an agent provides a convenient and powerful way to describe a complex software entity that is capable of acting with a certain degree of autonomy in order to accomplish tasks on behalf of its host. But unlike objects, which are defined in terms of methods and attributes, an agent is defined in terms of its behavior.
</blockquote>
<div class="attribution">
&#8212; Wikipedia: Software agent<br>
<cite>retrieved 8 September 2019</cite>
</div>
</div>
<div class="paragraph">
<p>In this chapter, we take this somewhat abstract concept and crystallize it by developing a simple agent. While the idea of writing your own agent might sound daunting at first, you&#8217;ll soon see that it is actually quite easy!</p>
</div>
<div class="sect2">
<h3 id="_unet_agents">27.1. Unet agents</h3>
<div class="paragraph">
<p>Agents are the basic building blocks of the UnetStack. They exchange messages, provide services and implement protocols. While what is expected from a well-behaved agent is quite demanding, most of the necessary core behaviors are already implemented for you by the <a href="https://unetstack.net/javadoc/org/arl/unet/UnetAgent.html" target="_blank" rel="noopener"><code>UnetAgent</code></a> base class. All you need to do is to extend it, and add in a little code to teach the agent what you want it to do.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While you have the option of writing agents in Java or Groovy (or any other language running on the Java VM), we recommend writing agents in Groovy, as Groovy agents tend to need less biolerplate code and are more readable and maintainable. They are also easier to test as Groovy classes can be dynamically loaded from source, without having to pre-compile them. However, if you are already an expert in Java and prefer to use it, you&#8217;re welcome to do so.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The basic skeleton of a Groovy agent looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>

<span class="kd">class</span> <span class="nc">MyAgent</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// this method is called when the stack is initialized</span>
    <span class="c1">// register services and capabilities that you provide here</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// this method is called just after the stack is running</span>
    <span class="c1">// look up other agents and services here, as needed</span>
    <span class="c1">// subscribe to topics of interest to get notifications</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// process requests supported by the agent, and return responses</span>
    <span class="c1">// if request is not processed, return null</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// process other messages, such as notifications here</span>
    <span class="c1">// if a message is not interesting, it can be safely just ignored</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While you don&#8217;t strictly need the <code>@Override</code> annotations, it is a good practice to use them whenever you are overriding a method from a superclass. The annotation tells the compiler that this is what you intend, and so if you make a typographical mistake and type in a wrong method name (one that doesn&#8217;t exist in the superclass), the compiler will warn you.</p>
</div>
<div class="paragraph">
<p>If you do not need any of these methods, you can skip the definition as the base class provides default implementations. There are a several other methods that you can override to customize your agent, but these are less commonly needed and so we&#8217;ll skip them for now. You&#8217;ll come across them later.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you happen to be already familiar with the <a href="https://fjage.readthedocs.io/en/latest/behaviors.html#agent-lifecycle" target="_blank" rel="noopener">fjåge agent lifecycle</a>, you may wish to note that the <code>setup()</code> method is called from the <code>init()</code> method of the agent. The <code>startup()</code> method is called from a one-shot behavior scheduled during initialization. The <code>processRequest()</code> and <code>processMessage()</code> methods are called from a message behavior added during initialization.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_groovy_echo_daemon">27.2. Groovy echo daemon</h3>
<div class="paragraph">
<p>It&#8217;s best to illustrate with a simple example.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s develop an <em>echo daemon</em> that will respond to each incoming <em>echo request</em> datagram with an <em>echo response</em> datagram containing the same data as the echo-request. We need a way to identify which datagram is an echo request, as we don&#8217;t want to be echoing datagrams intended for other agents or for the user. We do this by defining an echo request datagram as any datagram with protocol <code>USER</code> (recall that protocol numbers from <code>USER</code> onwards are available for your own applications to use). We do not want to use the response to use the same protocol, otherwise our daemon (running on the source node) could get confused and echo the response, which would in turn be echoed again by the destination node&#8217;s daemon, ad infinitum. So we use protocol <code>DATA</code> for the echo response datagram, as this protocol is intended by generic application data.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s our daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>

<span class="kd">class</span> <span class="nc">EchoDaemon</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// subscribe to all agents that provide the datagram service</span>
    <span class="n">agentsForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">DATAGRAM</span><span class="o">).</span><span class="na">each</span> <span class="o">{</span>
      <span class="n">subscribe</span> <span class="nf">topic</span><span class="o">(</span><span class="n">it</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">DatagramNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// respond to protocol USER datagram with protocol DATA datagram</span>
      <span class="n">send</span> <span class="k">new</span> <span class="nf">DatagramReq</span><span class="o">(</span>
        <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
        <span class="nl">protocol:</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span>
        <span class="nl">data:</span> <span class="n">msg</span><span class="o">.</span><span class="na">data</span>
      <span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through the above code:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Our agent does not provide any formal services or capabilities, so we we skip the <code>setup()</code> and <code>processRequest()</code> methods from the skeleton.</p>
</li>
<li>
<p>The <code>startup()</code> method looks up all agents providing the DATAGRAM service, and subscribes to any notifications from any of these agents. These notifications will inlcude the <code>DatagramNtf</code> messages that are published when datagrams are received from another node. When a notification arrives, the <code>processMessage()</code> method will be called.</p>
</li>
<li>
<p>In the <code>processMessage()</code> method, we check for datagram notifications with protocol <code>USER</code>, and respond to each of them by sending a <code>DatagramReq</code> to the sender of the notification, requesting it to send a datagram with protocol <code>DATA</code> to the node that sent the echo request, with the data copied from the echo request.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That&#8217;s it!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Do not get confused between <code>sender</code> and <code>from</code>, and <code>recipient</code> and <code>to</code> fields in datagram messages. The <code>sender</code> and <code>recepient</code> <strong>always</strong> refer to the agents that generate and consume the message. These are entities within a single Unet node. The <code>from</code> and <code>to</code> are node addresses that tell us which node is transmitting the datagram, and which node is the intended destination.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s time for us to test this agent. Create a file called <code>EchoDaemon.groovy</code> in the <code>classes</code> folder and copy the above daemon code into it.</p>
</div>
<div class="paragraph">
<p>Now start the 2-node network simulation that we have been using as a testbed, and on node B, load the agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.add <span class="s1">'echo'</span>, new EchoDaemon<span class="o">()</span><span class="p">;</span>             <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">&gt;</span> ps
<span class="go">remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ECLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
echo: EchoDaemon - IDLE                               <i class="conum" data-value="2"></i><b>(2)</b>
router: org.arl.unet.net.Router - IDLE
mac: org.arl.unet.mac.CSMA - IDLE
WebGW-5c9c1c68385a388f: REMOTE</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create an agent called <code>echo</code> based on the <code>EchoDaemon</code> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We see that the <code>echo</code> agent is now running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our daemon is up and running!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Debugging agents</div>
<div class="paragraph">
<p>If you have any errors in the <code>EchoDaemon.groovy</code> that cause compilation to fail, the agent won&#8217;t load, and you&#8217;ll get an error message on the shell. Sometimes it helps to look at the log file (<code>logs/log-0.txt</code>) for more details on the error.</p>
</div>
<div class="paragraph">
<p>In some rare cases, instead of printing an error, the shell may simply refuse to run the command by showing a "-" and waiting for more input because it thinks that the command you gave is incomplete. If this happens, look at your code to find the error, or try compiling manually using <code>groovyc</code> (similar to <code>javac</code> command in the next section) to get more details on the error.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the daemon is successfully loaded on node B, we can test it from node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy                                       <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">&gt;</span> phy <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> DatagramReq(to: host('B'), protocol: Protocol.USER, data: [42]) <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="go">AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameNtf:INFORM[type:DATA txTime:2809812247]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:DATA rxTime:2811767943]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:DATA from:31 to:232 rxTime:2811767943 <span class="o">(</span>1 byte<span class="o">)]</span>
<span class="gp">&gt;</span> ntf.data
<span class="go">[42]                                                  <i class="conum" data-value="3"></i><b>(3)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We subscribe to <code>phy</code> so that we can see the incoming echo response from the peer node.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Transmit a physical layer frame containing the echo request and some data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The data we sent was echoed back.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have written our first agent! Was easy, wasn&#8217;t it?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unet modems also have a <code>classes</code> folder that accepts Groovy source files or compiled Java/Groovy class files. You can use the web interface of the modem to upload files to that folder. If your code has many class files, you may wish to package them together into a jar archive and place it in the <code>jars</code> folder.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_java_echo_daemon">27.3. Java echo daemon</h3>
<div class="paragraph">
<p>If you&#8217;re a Java programmer and find the Groovy syntax daunting, you might prefer to write your agents in pure Java (at the expense of verbosity and more steps for testing). This is the equivalent Java code below for the Groovy agent we developed in the last section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoDaemon</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// subscribe to all agents that provide the datagram service</span>
    <span class="n">AgentID</span><span class="o">[]</span> <span class="n">agents</span> <span class="o">=</span> <span class="n">agentsForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">DATAGRAM</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">AgentID</span> <span class="nl">it:</span> <span class="n">agents</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">subscribe</span><span class="o">(</span><span class="n">topic</span><span class="o">(</span><span class="n">it</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">DatagramNtf</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">DatagramNtf</span><span class="o">)</span><span class="n">msg</span><span class="o">).</span><span class="na">getProtocol</span><span class="o">()</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// we got an echo request!</span>
      <span class="c1">// respond with a protocol DATA datagram</span>
      <span class="n">DatagramNtf</span> <span class="n">ntf</span> <span class="o">=</span> <span class="o">(</span><span class="n">DatagramNtf</span><span class="o">)</span><span class="n">msg</span><span class="o">;</span>
      <span class="n">DatagramReq</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatagramReq</span><span class="o">(</span><span class="n">ntf</span><span class="o">.</span><span class="na">getSender</span><span class="o">());</span>
      <span class="n">req</span><span class="o">.</span><span class="na">setTo</span><span class="o">(</span><span class="n">ntf</span><span class="o">.</span><span class="na">getFrom</span><span class="o">());</span>
      <span class="n">req</span><span class="o">.</span><span class="na">setProtocol</span><span class="o">(</span><span class="n">Protocol</span><span class="o">.</span><span class="na">DATA</span><span class="o">);</span>
      <span class="n">req</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">ntf</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
      <span class="n">send</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In Java, you&#8217;ll first need to compile the Java code. Create a <code>EchoDaemon.java</code> file with the above contents. To compile it, you&#8217;ll need to have fjåge and unet-framework jar files on the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>javac <span class="nt">-cp</span> lib/fjage-1.6.jar:lib/unet-framework-3.0-beta.jar EchoDaemon.java</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now have a <code>EchoDaemon.class</code> file which you copy to the <code>classes</code> folder. To avoid duplicate classes, remember to first delete the <code>EchoDaemon.groovy</code> file!</p>
</div>
<div class="paragraph">
<p>Finally, you can run the 2-node network simulator and test the agent, just as you did in the previous section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_behaviors">27.4. Behaviors</h3>
<div class="paragraph">
<p>Agents implement most of their functionality with behaviors.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
UnetStack is implemented on top of the <a href="https://fjage.readthedocs.io/en/latest/introduction.html" target="_blank" rel="noopener">fjåge</a> agent framework. fjåge provides a set of standard behaviors for agents to extend. We will explore some of these behaviors in this section, but encourage you to read the <a href="https://fjage.readthedocs.io/en/latest/index.html">fjåge documentation</a> at your leisure to learn more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have been implicitly using two behaviors so far. The <code>startup()</code> method is called by the <code>UnetAgent</code> base class using a <code>OneShotBehavior</code>, and the <code>processMessage()</code> method is called from a <code>MessageBehavior</code>. While you could have manually added these behaviors, the <code>UnetAgent</code> base class does this for you, because almost all unet agents require this.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s next look at a use case for explicitly adding other behaviors. Say we wanted our echo daemon to not respond immediately, but after 7 seconds. How would we do that?</p>
</div>
<div class="paragraph">
<p>We could of course add a <code>delay(7000)</code> in the <code>processMessage()</code> method, but that would be a bad idea. If we did that, the agent would sleep for 7 seconds on receiving a request and not process any request from any other nodes! We want the agent to be responsive while waiting, and so do not want to block execution. Instead, we want a behavior that will occur 7 seconds later&#8201;&#8212;&#8201;this is precisely what a <code>WakerBehavior</code> does. Here&#8217;s our new <code>processMessage()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">DatagramNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// respond to protocol USER datagram with protocol DATA datagram after 7 seconds</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="mi">7000</span><span class="o">,</span> <span class="o">{</span>
        <span class="n">send</span> <span class="k">new</span> <span class="nf">DatagramReq</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
          <span class="nl">protocol:</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span>
          <span class="nl">data:</span> <span class="n">msg</span><span class="o">.</span><span class="na">data</span>
        <span class="o">)</span>
      <span class="o">})</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>WakerBehavior</code> that we add is triggered 7000 ms later, and the echo response is sent in that behavior. Simple!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Behaviors in Groovy use closures to make the syntax easy to work with. If you were writing your agent in Java, you&#8217;d need to create an anonymous class and override the <code>onWake()</code> method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Go ahead and replace the <code>processMessage()</code> method in your <code>EchoDaemon.groovy</code> file and try it! In order to reload the agent, all you need to do on node B is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.kill <span class="nb">echo</span>
<span class="go">true
</span><span class="gp">&gt;</span> container.add <span class="s1">'echo'</span>, new EchoDaemon<span class="o">()</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now you can send an echo request from node A as before and see that the response is delayed by 7 seconds.</p>
</div>
<div class="paragraph">
<p>You could also send a second request during those 7 seconds, and the echo daemon on node B would process that concurrently. You can send 2 echo requests right after each other, and you&#8217;ll see the corresponding echo responses 7 seconds later, but right after each other.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">fjåge behaviors</div>
<div class="paragraph">
<p>fjåge provides several behaviors that are commonly used in unet agents:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">One-shot behavior</dt>
<dd>
<p>A behavior that is run only once at the earliest opportunity.</p>
</dd>
<dt class="hdlist1">Cyclic behavior</dt>
<dd>
<p>A cyclic behavior is run repeatedly as long as it is active. The behavior may be blocked and restarted as necessary.</p>
</dd>
<dt class="hdlist1">Waker behavior</dt>
<dd>
<p>A behavior that is run after a specified delay in milliseconds.</p>
</dd>
<dt class="hdlist1">Ticker behavior</dt>
<dd>
<p>A behavior that runs repeatedly with a specified delay between invocations.</p>
</dd>
<dt class="hdlist1">Backoff behavior</dt>
<dd>
<p>A behavior that is similar to the waker behavior, but allows the wakeup time to be extended dynamically. This is typically useful to implement backoff or retry timeouts.</p>
</dd>
<dt class="hdlist1">Poisson behavior</dt>
<dd>
<p>A behavior that is similar to a ticker behavior, but the interval between invocations is an exponentially distributed random variable. This simulates a Poisson arrival process, commonly used to model network data sources.</p>
</dd>
<dt class="hdlist1">Finite state machine behavior</dt>
<dd>
<p>Finite state machines are commonly used to implement network protocols. They can easily be implemented using this behavior. These machines are composed out of multiple states, each of which is like a cyclic behavior, with state transitions that can be triggered by the component behaviors.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can read more about these behaviors in the fjåge documentation on <a href="https://fjage.readthedocs.io/en/latest/behaviors.html" target="_blank" rel="noopener">Agents &amp; Behaviors</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parameters_7">27.5. Parameters</h3>
<div class="paragraph">
<p>We have seen many agents with parameters that you can get/set. If we wanted to make our echo daemon delay configurable, it would be perfect to expose it as a parameter. Let&#8217;s do that next.</p>
</div>
<div class="paragraph">
<p>With the echo daemon loaded on node B, we see that it doesn&#8217;t have any configurable parameters by default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">echo</span>
<span class="gp">&lt;&lt;&lt; EchoDaemon &gt;</span><span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a title, description and one <code>delay</code> parameter to our daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>

<span class="kd">class</span> <span class="nc">EchoDaemon</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="kd">enum</span> <span class="n">Params</span> <span class="kd">implements</span> <span class="n">Parameter</span> <span class="o">{</span>        <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">delay</span>
  <span class="o">}</span>

  <span class="kd">final</span> <span class="n">String</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">'Echo Daemon'</span>        <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">description</span> <span class="o">=</span> <span class="s1">'Echoes any USER datagrams back as DATA'</span> <i class="conum" data-value="3"></i><b>(3)</b>

  <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">7000</span>                          <i class="conum" data-value="4"></i><b>(4)</b>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// subscribe to all agents that provide the datagram service</span>
    <span class="n">agentsForService</span><span class="o">(</span><span class="n">Services</span><span class="o">.</span><span class="na">DATAGRAM</span><span class="o">).</span><span class="na">each</span> <span class="o">{</span>
      <span class="n">subscribe</span> <span class="nf">topic</span><span class="o">(</span><span class="n">it</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">DatagramNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">USER</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// respond to protocol USER datagram with protocol DATA datagram after 7 seconds</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">delay</span><span class="o">,</span> <span class="o">{</span>
        <span class="n">send</span> <span class="k">new</span> <span class="nf">DatagramReq</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
          <span class="nl">protocol:</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span>
          <span class="nl">data:</span> <span class="n">msg</span><span class="o">.</span><span class="na">data</span>
        <span class="o">)</span>
      <span class="o">})</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>      <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="n">allOf</span><span class="o">(</span><span class="n">Params</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare a list of parameters that the agent advertises. We have declared this enum as an inner class, but you could choose to declare it as a separate class if you wish.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Provide a descriptive title for the agent.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Provide a descriptive text for the agent.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare the parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Advertise the list of parameters.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that we had to take 3 steps to add a parameter: declare a list of parameters, declare the parameter, and advertise the parameter. While this might seem like a lot, bear in mind that parameters are much more than just agent&#8217;s class attributes. Parameters can be get/set remotely, even from a different Java VM, different computer, or through a UnetSocket gateway API.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you were writing the agent in Java instead of Groovy, you&#8217;d need to getters and setters for parameter <code>delay</code>, rather than simply declare the attribute. This is because Groovy automatically creates the getters and setters for you.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see how the agent looks with parameters. Reload the agent on node B and check its parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.kill agent<span class="o">(</span><span class="s1">'echo'</span><span class="o">)</span>
<span class="go">true
</span><span class="gp">&gt;</span> container.add <span class="s1">'echo'</span>, new EchoDaemon<span class="o">()</span><span class="p">;</span>
<span class="gp">&gt;</span> <span class="nb">echo</span>
<span class="gp">&lt;&lt;&lt; Echo Daemon &gt;</span><span class="o">&gt;&gt;</span>                      <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">
Echoes any USER datagrams back as DATA   <i class="conum" data-value="2"></i><b>(2)</b>

[EchoDaemon.Params]
  delay = 7000

</span><span class="gp">&gt;</span> echo.delay
<span class="go">7000
</span><span class="gp">&gt;</span> echo.delay <span class="o">=</span> 5000
<span class="go">5000
</span><span class="gp">&gt;</span> echo.delay
<span class="go">5000</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice the change in title.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The description is shown here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have changed the delay from 7 seconds to 5 seconds. Go ahead and send a echo request from node A and see that you get a response back in 5 seconds!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to compute parameter values on demand or validate parameters, you can implement getters/setters for the parameter, and they will be called. If you want a read-only parameter, you can declare the attribute as <code>private</code> and implement only a getter for that parameter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While our example above uses a static description, the description can also be dynamic. This can be useful if you want to display agent&#8217;s status information in the description. To implement dynamic descriptions, simply replace the <code>description</code> attribute by a getter <code>getDescription()</code> that returns a <code>String</code> description when called.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_services_capabilities_and_notifications">27.6. Services, capabilities and notifications</h3>
<div class="paragraph">
<p>Most of the agents we have been interacting with advertised services, and sometimes optional capabilities. They also honor requests and publish unsolicited notifications. All of these are quite straightforward to implement, and you can explore some of these features in this <a href="https://blog.unetstack.net/developing-modem-drivers-for-unetstack" target="_blank" rel="noopener">blog article</a> on how to implement a simple PHYSICAL service agent (modem driver). We will explore some of these in the next chapter, along with other cool features like finite state machine behaviors and protocol data unit (PDU) codecs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_network_protocols">28. Implementing network protocols</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You now know how to write simple agents. But real world network protocols demand more complexity such as advertising services, looking up other agents, providing parameters that are computed on demand, encoding/decoding complex PDUs, generating random variates, and describing behaviors as finite state machines (FSMs). In this chapter, we illustrate how to do all these things with ease, using a few examples.</p>
</div>
<div class="paragraph">
<p>In <a href="#_medium_access_control">Chapter 19</a>, we looked at the MAC service in detail. In the next few sections, we develop three simple MAC agents (<code>MySimplestMac</code>, <code>MySimpleThrottledMac</code> and <code>MySimpleHandshakeMac</code>) to illustrate how network protocols and services are implemented by agents. The MAC agents are intentionally kept simple and not optimized for performance, as we wish to illustrate the key aspects of MAC agent development without getting lost in the details of optimal protocols.</p>
</div>
<div class="sect2">
<h3 id="_simple_mac_without_handshake">28.1. Simple MAC without handshake</h3>
<div class="paragraph">
<p>To illustrate how a MAC agent might work, let us start with a simple MAC agent that grants every reservation request as soon as it is made:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimplestMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>                <span class="c1">// advertise that the agent provides a MAC service</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReservationReq</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// check requested duration</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>

      <span class="c1">// prepare START reservation notification</span>
      <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
        <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
        <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>

      <span class="c1">// prepare END reservation notification</span>
      <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
        <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
        <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>

      <span class="c1">// send START reservation notification immediately</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
        <span class="n">send</span> <span class="n">ntf1</span>
      <span class="o">})</span>

      <span class="c1">// wait for reservation duration, and then send END reservation notification</span>
      <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">),</span> <span class="o">{</span>
        <span class="n">send</span> <span class="n">ntf2</span>
      <span class="o">})</span>

      <span class="c1">// return a reservation response, which defaults to an AGREE performative</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note a number of interesting features of the code above:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>setup()</code> method is used to advertise the service provided by this agent.</p>
</li>
<li>
<p>We provide basic error checking, and refuse a request that is invalid, providing a descriptive reason.</p>
</li>
<li>
<p>We prepare the AGREE response as well as the START and END status notification messages, all at once. We send out the START notification immediately (using a <code>OneShotBehavior</code>), use a <code>WakerBehavior</code> to schedule the END notification to be sent out at an appropriate time, and then simply return the AGREE response. The use of the <code>OneShotBehavior</code> ensures that the START notificaion is sent after the AGREE response, and not before.</p>
</li>
<li>
<p>We return a <code>null</code> if we don&#8217;t understand the request, allowing the superclass to respond with a NOT_UNDERSTOOD message.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While the above code implements a fully functional MAC agent, it needs to respond to <code>ReservationCancelReq</code>, <code>ReservationAcceptReq</code> and <code>TxAckReq</code> messages, and provide <code>channelBusy</code>, <code>reservationPayloadSize</code>, <code>ackPayloadSize</code>, <code>maxReservationDuration</code> and <code>recommendedReservationDuration</code> parameters in order to comply with the MAC service specification (<a href="#_medium_access_control">Chapter 19</a>). We add this functionality trivially, by responding to the messages with <code>RefuseRsp</code> (message with a <code>REFUSE</code> performative and a descriptive reason), and returning default values for all the parameters. The resulting complete source code is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimplestMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">ReservationReq:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
          <span class="n">send</span> <span class="n">ntf1</span>
        <span class="o">})</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">),</span> <span class="o">{</span>
          <span class="n">send</span> <span class="n">ntf2</span>
        <span class="o">})</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
      <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>                      <span class="c1">// respond to other requests defined</span>
      <span class="k">case</span> <span class="nl">TxAckReq:</span>                                  <span class="c1">//  by the MAC service with a RefuseRsp</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="c1">// expose parameters defined by the MAC service, with just default values</span>

  <span class="nd">@Override</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">)</span>                            <span class="c1">// advertise the list of parameters</span>
  <span class="o">}</span>

  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">channelBusy</span> <span class="o">=</span> <span class="kc">false</span>                   <span class="c1">// parameters are marked as 'final'</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c1">//  to ensure that they are read-only</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span>
  <span class="kd">final</span> <span class="n">Float</span> <span class="n">recommendedReservationDuration</span> <span class="o">=</span> <span class="kc">null</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have a fully-compliant, but very simple, MAC agent!</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_simple_mac">28.2. Testing our simple MAC</h3>
<div class="paragraph">
<p>The <code>MySimplestMac</code> agent from the previous section is available in the <code>samples</code> folder of your unet simulator. To test it, fire up the 2-node network simulator and connect to node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> ps
<span class="go">remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ECLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
router: org.arl.unet.net.Router - IDLE
mac: org.arl.unet.mac.CSMA - IDLE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the <code>org.arl.unet.mac.CSMA</code> agent is running as the current <code>mac</code>. To use our <code>MySimplestMac</code> agent, you first need to kill the <code>org.arl.unet.mac.CSMA</code> agent, and then load the <code>MySimplestMac</code> agent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.kill mac
<span class="go">true
</span><span class="gp">&gt;</span> container.add <span class="s1">'mac'</span>, new MySimplestMac<span class="o">()</span>
<span class="go">mac
</span><span class="gp">&gt;</span> ps
<span class="go">remote: org.arl.unet.remote.RemoteControl - IDLE
state: org.arl.unet.state.StateManager - IDLE
rdp: org.arl.unet.net.RouteDiscoveryProtocol - IDLE
ranging: org.arl.unet.phy.Ranging - IDLE
uwlink: org.arl.unet.link.ECLink - IDLE
node: org.arl.unet.nodeinfo.NodeInfo - IDLE
websh: org.arl.fjage.shell.ShellAgent - RUNNING
simulator: org.arl.unet.sim.SimulationAgent - IDLE
phy: org.arl.unet.sim.HalfDuplexModem - IDLE
bbmon: org.arl.unet.bb.BasebandSignalMonitor - IDLE
arp: org.arl.unet.addr.AddressResolution - IDLE
transport: org.arl.unet.transport.SWTransport - IDLE
router: org.arl.unet.net.Router - IDLE
mac: MySimplestMac - IDLE

</span><span class="gp">&gt;</span> mac
<span class="gp">&lt;&lt;&lt; MySimplestMac &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.mac.MacParam]
  ackPayloadSize = 0
  channelBusy = false
  maxReservationDuration = Infinity
  recommendedReservationDuration = null
  reservationPayloadSize = 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s loaded and working!</p>
</div>
<div class="paragraph">
<p>Now, you can ask for a reservation and see if it responds correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> mac <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> ReservationReq(to: 31, duration: 3.seconds)
</span><span class="go">ReservationRsp:AGREE
</span><span class="gp">mac &gt;</span><span class="o">&gt;</span> ReservationStatusNtf:INFORM[to:31 status:START]
<span class="gp">mac &gt;</span><span class="o">&gt;</span> ReservationStatusNtf:INFORM[to:31 status:END]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Indeed it does! The START notification arrives immediately after the AGREE response, and the END notification arrives about 3 seconds later.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Logging and debugging</div>
<div class="paragraph">
<p>When testing agents, you&#8217;ll often feel the need to log debug information. Every agent already has a Java logger (<code>log</code>) defined, and can be used to log information to the log file (<code>logs/log-0.txt</code>). The Java logger supports various levels of logging: <code>severe</code>, <code>warning</code>, <code>info</code>, <code>fine</code>, <code>finer</code>, <code>finest</code>. For example, to log a message at a fine level, simply do something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">log</span><span class="o">.</span><span class="na">fine</span> <span class="s1">'Some debugging information'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The log level can be controlled on a per-class or per-package basis using the <code>logLevel</code> command on the unet shell (type <code>help logLevel</code> for details). To set the current log level to include fine level logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> logLevel FINE</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can access the logs from the web interface "Logs" tab, or on your disk in the <code>logs</code> folder. The active agent log file is always called <code>log-0.txt</code>. To see the last few lines of this file from your shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> <span class="nb">tail</span>
<span class="go">1568482567444|INFO|org.arl.unet.remote.RemoteControl/B@57:startup|Using transport for communication
1568482567447|INFO|org.arl.unet.link.ECLink/B@59:startup|No PHY specified, auto detecting...
1568482567448|INFO|org.arl.unet.link.ECLink/B@59:startup|Using agent 'phy' for PHY
1568482567448|INFO|org.arl.unet.link.ECLink/B@59:startup|No MAC specified, auto detecting...
1568482567449|INFO|org.arl.unet.link.ECLink/B@59:startup|Using agent 'mac' for MAC
1568482567451|INFO|org.arl.unet.transport.SWTransport/B@69:startup|Using router for communication
1568482567453|INFO|org.arl.unet.remote.RemoteControl/B@57:startup|Using websh for command exec
1568482567511|INFO|org.arl.unet.remote.RemoteControl/A@42:startup|Using websh for command exec
1568482572443|INFO|org.arl.unet.nodeinfo.NodeInfo/A@52:obtainAddress|Node name is A, address is 232, address size is 8 bits
1568482572449|INFO|org.arl.unet.nodeinfo.NodeInfo/B@68:obtainAddress|Node name is B, address is 31, address size is 8 bits
1568482584194|INFO|MySimplestMac/A@72:init|Loading agent mac [MySimplestMac] on A</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_simple_mac_with_throttling">28.3. Simple MAC with throttling</h3>
<div class="paragraph">
<p>While the above simple MAC would work well when the traffic offered to it is random, it will perform poorly if the network is fully loaded. All nodes would constantly try to access the channel, collide and the throughput would plummet. To address this concern, one may add an exponentially distributed random backoff (Poisson arrival to match the assumption of Aloha) for every request to introduce randomness. The backoff could be chosen to offer a normalized network load of approximately 0.5, since this generates the highest throughput for Aloha.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the updated code with some bells and whistles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.phy.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>

<span class="kd">class</span> <span class="nc">MySimpleThrottledMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">double</span> <span class="n">TARGET_LOAD</span>     <span class="o">=</span> <span class="mf">0.5</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span>    <span class="n">MAX_QUEUE_LEN</span>   <span class="o">=</span> <span class="mi">16</span>

  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="kd">private</span> <span class="n">AgentID</span> <span class="n">phy</span>
  <span class="kt">boolean</span> <span class="n">busy</span> <span class="o">=</span> <span class="kc">false</span>   <span class="c1">// is a reservation currently ongoing?</span>
  <span class="n">Long</span> <span class="n">t0</span> <span class="o">=</span> <span class="kc">null</span>         <span class="c1">// time of last reservation start, or null</span>
  <span class="n">Long</span> <span class="n">t1</span> <span class="o">=</span> <span class="kc">null</span>         <span class="c1">// time of last reservation end, or null</span>
  <span class="kt">int</span> <span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">phy</span> <span class="o">=</span> <span class="n">agentForService</span> <span class="n">Services</span><span class="o">.</span><span class="na">PHYSICAL</span>      <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">ReservationReq:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">waiting</span> <span class="o">&gt;=</span> <span class="n">MAX_QUEUE_LEN</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="n">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Queue full'</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
        <span class="n">ReservationStatusNtf</span> <span class="n">ntf2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReservationStatusNtf</span><span class="o">(</span>
          <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
          <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">status:</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>

        <span class="c1">// grant the request after a random backoff                         </span><i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">AgentLocalRandom</span> <span class="n">rnd</span> <span class="o">=</span> <span class="n">AgentLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">()</span>                   <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="kt">double</span> <span class="n">backoff</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextExp</span><span class="o">(</span><span class="n">TARGET_LOAD</span><span class="s">/msg.duration/</span><span class="n">nodes</span><span class="o">)</span>        <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">currentTimeMillis</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t0</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">)</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">t0</span> <span class="o">+=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">backoff</span><span class="o">)</span>  <span class="c1">// schedule packet with a random backoff</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t0</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="o">)</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">t1</span>            <span class="c1">//   after the last scheduled packet </span><i class="conum" data-value="6"></i><b>(6)</b>
        <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">duration</span>
        <span class="n">waiting</span><span class="o">++</span>
        <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">t0</span><span class="o">-</span><span class="n">t</span><span class="o">,</span> <span class="o">{</span>            <i class="conum" data-value="7"></i><b>(7)</b>
          <span class="n">send</span> <span class="n">ntf1</span>
          <span class="n">busy</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="n">waiting</span><span class="o">--</span>
          <span class="n">add</span> <span class="k">new</span> <span class="nf">WakerBehavior</span><span class="o">(</span><span class="n">duration</span><span class="o">,</span> <span class="o">{</span>
            <span class="n">send</span> <span class="n">ntf2</span>
            <span class="n">busy</span> <span class="o">=</span> <span class="kc">false</span>
          <span class="o">})</span>
        <span class="o">})</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
      <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>
      <span class="k">case</span> <span class="nl">TxAckReq:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="c1">// expose parameters defined by the MAC service, and one additional parameter</span>

  <span class="nd">@Override</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">,</span> <span class="n">Param</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="kd">enum</span> <span class="n">Param</span> <span class="kd">implements</span> <span class="n">Parameter</span> <span class="o">{</span>
    <span class="n">nodes</span>                                        <i class="conum" data-value="8"></i><b>(8)</b>
  <span class="o">}</span>

  <span class="kt">int</span> <span class="n">nodes</span> <span class="o">=</span> <span class="mi">6</span>                          <span class="c1">// number of nodes in network, to be set by user</span>

  <span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="na">POSITIVE_INFINITY</span>

  <span class="kt">boolean</span> <span class="nf">getChannelBusy</span><span class="o">()</span> <span class="o">{</span>                     <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="k">return</span> <span class="n">busy</span>
  <span class="o">}</span>

  <span class="kt">float</span> <span class="nf">getRecommendedReservationDuration</span><span class="o">()</span> <span class="o">{</span>    <i class="conum" data-value="10"></i><b>(10)</b>
    <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">PhysicalChannelParam</span><span class="o">.</span><span class="na">frameDuration</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a few attributes to keep track of channel state and reservation queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We lookup other agents in <code>startup()</code> after they have had a chance to advertise their services during the setup phase.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Requests are no longer granted immediately, but after a random backoff instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Random numbers are generated using a <code>AgentLocalRandom</code> utility. This utility ensures repeatable results during discrete event simulation, aiding with debugging, and so is the preferred way of generating random variates.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>nextExp()</code> function generate a exponentially distributed random number with a specified rate parameter. The rate parameter is computed such that the average backoff introduced helps to achieve the specified target load.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>In Groovy, a comparison with <code>null</code> (initial value of <code>t1</code>) is permitted, and will always be false.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Note that we no longer send the START notification immediately. Instead we schedule it after a backoff, and then schedule the END notification after the reservation duration from the START.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>We implement one user configurable parameter <code>nodes</code>, and advertise it.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Parameter <code>busy</code> is no longer always false, since we now keep track of reservations. We return <code>busy</code> to be true only during the time between a reservation START and END.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Parameter <code>recommendedReservationDuration</code> is now determined based on the frame duration of the PHYSICAL service, assuming that most reservations are for transmitting one frame. A client is free to choose a longer reservation time, if he wishes to transmit many frames in one go (as he should for efficient use of the channel).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A copy of this code is available in the <code>samples</code> folder of your unet simulator. We encourage you to test it out, in the same way as we tested <code>MySimplestMac</code> in <a href="#_testing_our_simple_mac">Section 28.2</a>. You&#8217;ll find that the START notification no longer arrives immediately after the AGREE response, but arrives a few seconds later, after a random backoff.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simple_mac_with_handshake">28.4. Simple MAC with handshake</h3>
<div class="paragraph">
<p>While the MAC agents we have developed so far are fully functional, they are simple, and do not involve any signaling for channel reservation. Many MAC protocols such as MACA and FAMA involve a handshake using RTS and CTS PDUs. To illustrate how more complex protocols are developed using UnetStack, we implement a simple RTS-CTS 2-way handshake-based MAC agent next.</p>
</div>
<div class="paragraph">
<p>Many communication protocols are best described using a FSM. We illustrate the FSM for our simple handshake-based MAC agent in <a href="#fig_fsm">Figure 9</a>.</p>
</div>
<div id="fig_fsm" class="imageblock">
<div class="content">
<img src="images/fsm.png" alt="fsm">
</div>
<div class="title">Figure 9. Finite state machine (FSM) for the simple handshake-based MAC protocol.</div>
</div>
<div class="paragraph">
<p>When the channel is free, the agent is in an IDLE state. If the agent receives a <code>ReservationReq</code>, it switches to the RTS state and sends a RTS PDU to the intended destination node. If it receives a CTS PDU back, then it switches to a TX state and urges the client to transmit data via a <code>ReservationStatusNtf</code> with a START status. After the reservation period is over, the agent switches back to the IDLE state. If no CTS PDU is received in the RTS state for a while, the agent times out and returns to the IDLE state while informing the client of a reservation FAILURE.</p>
</div>
<div class="paragraph">
<p>If the agent receives a RTS PDU in the IDLE state, it switches to the RX state and responds with a CTS PDU. The node initiating the handshake may then transmit data for the reservation duration. After the duration (plus some allowance for 2-way propagation delay), the agent switches back to the IDLE state. If the agent overhears (aka snoops) RTS or CTS PDUs destined for other nodes, it switches to a BACKOFF state for a while. During the state, it does not initiate or respond to RTS PDUs. After the backoff period, it switches back to the IDLE state.</p>
</div>
<div class="paragraph">
<p>Our RTS and CTS PDUs are identified by a protocol number. Since we are implementing a MAC protocol, we choose to tag our PDUs using the protocol number reserved for MAC agents (<code>Protocol.MAC</code>). We also define some timeouts and delays that we will need to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">MAC</span>

<span class="kt">float</span> <span class="n">RTS_BACKOFF</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">CTS_TIMEOUT</span>     <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">BACKOFF_RANDOM</span>  <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
<span class="kt">float</span> <span class="n">MAX_PROP_DELAY</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Communication protocols often use complicated PDU formats. UnetStack provides a <code>PDU</code> class to help encode/decode PDUs. Although the RTS and CTS PDUs have a pretty simple format, the PDU is still useful in defining the format clearly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">RTS_PDU</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="kt">int</span> <span class="n">CTS_PDU</span> <span class="o">=</span> <span class="mh">0x02</span>

<span class="n">PDU</span> <span class="n">pdu</span> <span class="o">=</span> <span class="n">PDU</span><span class="o">.</span><span class="na">withFormat</span> <span class="o">{</span>
  <span class="n">uint8</span><span class="o">(</span><span class="s1">'type'</span><span class="o">)</span>         <span class="c1">// RTS_PDU/CTS_PDU</span>
  <span class="n">uint16</span><span class="o">(</span><span class="s1">'duration'</span><span class="o">)</span>    <span class="c1">// ms</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have defined a PDU with two fields – type (8 bit) and duration (16 bit). The type may be either of RTS_PDU or CTS_PDU, while the duration will specify the reservation duration in milliseconds. We will later use this <code>pdu</code> object to encode and decode these PDUs.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Encoding and decoding PDUs</div>
<div class="paragraph">
<p>Since encoding and decoding of PDUs is required in almost all protocol implementations, UnetStack provides a <a href="https://unetstack.net/javadoc/org/arl/unet/PDU.html" target="_blank" rel="noopener"><code>PDU</code></a> class to help you with it. The <code>PDU</code> class provides a declarative syntax for describing the PDU format. Once you have the PDU format declared, encoding and decoding PDUs is simply a matter of calling the <code>encode()</code> and <code>decode()</code> methods.</p>
</div>
<div class="paragraph">
<p>This is best illustrated with an example that you can try on a shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> import java.nio.ByteOrder
<span class="gp">&gt;</span> pdu <span class="o">=</span> PDU.withFormat <span class="o">{</span>
<span class="go">-    length(16)                     // 16 byte PDU
-    order(ByteOrder.BIG_ENDIAN)    // byte ordering is big endian
-    uint8('type')                  // 1 byte field 'type'
-    uint8(0x01)                    // literal byte 0x01
-    filler(2)                      // 2 filler bytes
-    uint16('data')                 // 2 byte field 'data' as unsigned short
-    padding(0xff)                  // padded with 0xff to make 16 bytes
</span><span class="gp">- };</span>
<span class="gp">&gt;</span> bytes <span class="o">=</span> pdu.encode<span class="o">([</span><span class="nb">type</span>: 7, data: 42]<span class="o">)</span>
<span class="go">[7, 1, 0, 0, 0, 42, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1]
</span><span class="gp">&gt;</span> pdu.decode<span class="o">(</span>bytes<span class="o">)</span>
<span class="go">[data:42, type:7]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The PDU length is defined using the <code>length</code> declaration, and the byte order is defined with the <code>order</code> declaration. Supported fields include <code>uint8</code>, <code>int8</code>, <code>uint16</code>, <code>int16</code>, <code>uint32</code>, <code>int32</code>, <code>int64</code>, and <code>chars</code> (string). Fillers and paddings are defined with <code>filler</code> and <code>padding</code> declarations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now comes the heart of our MAC protocol implementation –- the FSM shown in <a href="#fig_fsm">Figure 9</a>. First we define the FSM states and the events that the FSM reacts to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
  <span class="n">IDLE</span><span class="o">,</span> <span class="n">RTS</span><span class="o">,</span> <span class="n">TX</span><span class="o">,</span> <span class="n">RX</span><span class="o">,</span> <span class="n">BACKOFF</span>
<span class="o">}</span>

<span class="kd">enum</span> <span class="n">Event</span> <span class="o">{</span>
  <span class="n">RX_RTS</span><span class="o">,</span> <span class="n">RX_CTS</span><span class="o">,</span> <span class="n">SNOOP_RTS</span><span class="o">,</span> <span class="n">SNOOP_CTS</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we use the <code>FSMBuilder</code> utility class to construct a <code>FSMBehavior</code> from a declarative concise representation of the FSM.</p>
</div>
<div class="paragraph">
<p>The FSM states are defined using the <code>state(&#8230;&#8203;)</code> declarations. The actions to take when entering/exiting a state are defined in the <code>onEnter</code>/<code>onExit</code> clauses. The behavior of the FSM in response to events are defined using the <code>onEvent(&#8230;&#8203;)</code> clauses. Timers that operate in a state are defined using the <code>after(&#8230;&#8203;)</code> clauses. Finally actions to take continuously while in a state are defined using the <code>action</code> clause.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Finite state machines (FSMs)</div>
<div class="paragraph">
<p>FSMs are very commonly used in network protocol development. Although fjåge provides a <a href="https://org-arl.github.io/fjage/javadoc/org/arl/fjage/FSMBehavior.html" target="_blank" rel="noopener"><code>FSMBehavior</code></a> that helps implement FSMs in agents, it can be tedious to set up. UnetStack provides a <a href="https://unetstack.net/javadoc/org/arl/unet/FSMBuilder.html" target="_blank" rel="noopener"><code>FSMBuilder</code></a> to make setting up FSM behaviors in agents easy.</p>
</div>
<div class="paragraph">
<p>Here are the key steps in setting up the FSM:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define the states and events in the FSM as <code>enum</code> declarations.</p>
</li>
<li>
<p>Build the <code>FSMBehavior</code> using <code>FSMBuilder.build</code>. In building the FSM, you should have a <code>state(&#8230;&#8203;)</code> defined for each of your FSM states.</p>
</li>
<li>
<p>In each FSM state, define your actions, events and timers using the <code>action</code>, <code>onEnter</code>, <code>onExit</code>, <code>onEvent</code> and <code>after</code> clauses. Actions are continuously executed, like a <code>CyclicBehavior</code>, when the FSM is in the relevant state. You should call <code>block()</code> and <code>restart()</code> on the behavior to avoid busy loops when the FSM is idle. The <code>onEnter</code> and <code>onExit</code> clauses are triggered when the state is entered and exited respectively. Events are triggered when the <code>trigger()</code> method of the behavior is called and the FSM is in the specified state. Timers (<code>after</code>) are automatically triggered after the specified amount of time after the state is entered.</p>
</li>
<li>
<p>The <code>setNextState()</code> and <code>reenterState()</code> methods allow you to effect state transitions in your FSM.</p>
</li>
<li>
<p>For short-lived FSMs, the <code>terminate()</code> method should be called when the FSM behavior is completed and should be terminated.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>It should be easy to see the direct mapping between the FSM diagram and the FSM code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">int</span> <span class="n">MAX_RETRY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="kt">int</span> <span class="n">MAX_QUEUE_LEN</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">Queue</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;(</span><span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>

<span class="n">FSMBehavior</span> <span class="n">fsm</span> <span class="o">=</span> <span class="n">FSMBuilder</span><span class="o">.</span><span class="na">build</span> <span class="o">{</span>

  <span class="kt">int</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kt">float</span> <span class="n">backoff</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kt">def</span> <span class="n">rxInfo</span>

  <span class="nf">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">action</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// add random backoff for each reservation to allow other nodes</span>
        <span class="c1">// a chance to reserve, especially in case of a heavily loaded network</span>
        <span class="n">after</span><span class="o">(</span><span class="n">rnd</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">BACKOFF_RANDOM</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">block</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">rxInfo</span> <span class="o">=</span> <span class="n">info</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">peek</span><span class="o">()</span>
      <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="n">RTS_PDU</span><span class="o">,</span>
        <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
      <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
        <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
        <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
        <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
        <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">CTS_TIMEOUT</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(++</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRY</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(),</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">FAILURE</span><span class="o">)</span>
          <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="o">}</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">ReservationReq</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">()</span>
      <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
        <span class="nl">type:</span> <span class="n">CTS_PDU</span><span class="o">,</span>
        <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
      <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
        <span class="nl">to:</span> <span class="n">rxInfo</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
        <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
        <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
        <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
      <span class="n">after</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">rxInfo</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">onEnter</span> <span class="o">{</span>
      <span class="n">after</span><span class="o">(</span><span class="n">backoff</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
      <span class="n">reenterState</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
      <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
      <span class="n">reenterState</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Do note that the above FSM includes a couple of details that were missing from the FSM diagram. Firstly, we implement a random backoff before switching to the RTS state to minimize contention. Secondly, we implement a <code>retryCount</code> counter to check the number of times a single <code>ReservationReq</code> has been tried. If it exceeds <code>MAX_RETRY</code>, we discard it. Thirdly, we have a <code>backoff</code> variable that allows different backoff times for different occasions. The variable is set each time, just before the state is changed to <code>State.BACKOFF</code> or before the backoff state is re-entered.</p>
</div>
<div class="paragraph">
<p>The FSM uses a simple utility method to send out <code>ReservationStatusNtf</code> notifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">void</span> <span class="nf">sendReservationStatusNtf</span><span class="o">(</span><span class="n">ReservationReq</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">send</span> <span class="k">new</span> <span class="nf">ReservationStatusNtf</span><span class="o">(</span>
    <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
    <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
    <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
    <span class="nl">from:</span> <span class="n">addr</span><span class="o">,</span>
    <span class="nl">status:</span> <span class="n">status</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the hard work is done. We initialize our agent by registering the MAC service, looking up and subscribing to the PHYSICAL service (to transmit and receive PDUs), looking up our own address using the NODE_INFO service, and starting the <code>fsm</code> behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">AgentID</span> <span class="n">phy</span>
<span class="kt">int</span> <span class="n">addr</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">phy</span> <span class="o">=</span> <span class="n">agentForService</span> <span class="n">Services</span><span class="o">.</span><span class="na">PHYSICAL</span>
  <span class="n">subscribe</span><span class="o">(</span><span class="n">phy</span><span class="o">)</span>
  <span class="n">subscribe</span><span class="o">(</span><span class="n">topic</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">SNOOP</span><span class="o">))</span>
  <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
    <span class="kt">def</span> <span class="n">nodeInfo</span> <span class="o">=</span> <span class="n">agentForService</span> <span class="n">Services</span><span class="o">.</span><span class="na">NODE_INFO</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">nodeInfo</span><span class="o">,</span> <span class="n">NodeInfoParam</span><span class="o">.</span><span class="na">address</span><span class="o">)</span>
  <span class="o">})</span>
  <span class="n">add</span><span class="o">(</span><span class="n">fsm</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we subscribe to the <code>topic(phy, Physical.SNOOP)</code> in addition to <code>phy</code>. This allows us to snoop RTS/CTS PDUs destined for other nodes. Also note that the address lookup is performed in a <code>OneShotBehavior</code> to avoid having the agent to block while the node information agent is starting up.</p>
</div>
<div class="paragraph">
<p>Just like in the earlier MAC implementation, we have to respond to various requests defined by the MAC service specifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">ReservationReq:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">Address</span><span class="o">.</span><span class="na">BROADCAST</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Reservation must have a destination node'</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&gt;</span> <span class="n">maxReservationDuration</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Queue full'</span><span class="o">)</span>
      <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">restart</span><span class="o">()</span>    <span class="c1">// tell fsm to check queue, as it may block if empty</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
    <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>
    <span class="k">case</span> <span class="nl">TxAckReq:</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we get a <code>ReservationReq</code>, we validate the attributes, add the request to our queue and return a <code>ReservationRsp</code>. For other requests that we do not support, we simply refuse them.</p>
</div>
<div class="paragraph">
<p>If we receive PDUs from the physical agent, they come as <code>RxFrameNtf</code> messages via the <code>processMessage()</code> method. For all PDUs with a protocol number that we use, we decode them. We trigger appropriate FSM events in response to RTS and CTS PDUs -– RX_RTS and RX_CTS events for PDUs destined to us, and SNOOP_RTS and SNOOP_CTS events for PDUs that we overhear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">RxFrameNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">PROTOCOL</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">data</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">info</span> <span class="o">=</span> <span class="o">[</span><span class="nl">from:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span> <span class="nl">duration:</span> <span class="n">rx</span><span class="o">.</span><span class="na">duration</span><span class="o">/</span><span class="mf">1000.0</span><span class="o">]</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RTS_PDU</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">CTS_PDU</span><span class="o">)</span>
      <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we expose the parameters required by the MAC service specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>          <span class="c1">// publish list of all exposed parameters</span>
  <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">)</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1">// read-only</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>                  <span class="c1">// read-only</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="mf">65.535</span>   <span class="c1">// read-only</span>

<span class="kt">boolean</span> <span class="nf">getChannelBusy</span><span class="o">()</span> <span class="o">{</span>                    <span class="c1">// considered busy if fsm is not IDLE</span>
  <span class="k">return</span> <span class="n">fsm</span><span class="o">.</span><span class="na">currentState</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="na">IDLE</span>
<span class="o">}</span>

<span class="kt">float</span> <span class="nf">getRecommendedReservationDuration</span><span class="o">()</span> <span class="o">{</span>   <span class="c1">// recommended duration: one DATA packet</span>
  <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">PhysicalChannelParam</span><span class="o">.</span><span class="na">frameDuration</span><span class="o">)</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are done! You can find the full listing of the <code>MySimpleHandshakeMac</code> agent in <a href="#_mysimplehandshakemac">Appendix A</a> (and also in the <code>samples</code> folder of your unet simulator).</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_simple_mac_with_handshake">28.5. Testing our simple MAC with handshake</h3>
<div class="paragraph">
<p>Let&#8217;s try out this MAC. The steps are similar to <a href="#_testing_our_simple_mac">Section 28.2</a>, but since the handshake requires MAC to be running on all nodes, you will have to fire up the 2-node network and replace the default CSMA MAC with <code>MySimpleHandshakeMac</code> on both nodes (node A and node B):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> container.kill mac
<span class="go">true
</span><span class="gp">&gt;</span> container.add <span class="s1">'mac'</span>, new MySimpleHandshakeMac<span class="o">()</span><span class="p">;</span>
<span class="gp">&gt;</span> mac
<span class="gp">&lt;&lt;&lt; MySimpleHandshakeMac &gt;</span><span class="o">&gt;&gt;</span>
<span class="go">
[org.arl.unet.mac.MacParam]
  ackPayloadSize = 0
  channelBusy = false
  maxReservationDuration = 65.535
  recommendedReservationDuration = 0.7
  reservationPayloadSize = 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the handshaking involves exchange of PDUs between nodes, it is instructive to see the PDUs being exchanged by subscribing to <code>phy</code>. You can make a reservation request on node A:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">&gt;</span> subscribe phy
<span class="gp">&gt;</span> mac <span class="o">&lt;&lt;</span> <span class="no">new</span><span class="sh"> ReservationReq(to: 31, duration: 3.seconds)
</span><span class="go">ReservationRsp:AGREE
</span><span class="gp">phy &gt;</span><span class="o">&gt;</span> TxFrameStartNtf:INFORM[type:CONTROL txTime:3631928985 txDuration:950]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameStartNtf:INFORM[type:CONTROL rxTime:3634151681]
<span class="gp">phy &gt;</span><span class="o">&gt;</span> RxFrameNtf:INFORM[type:CONTROL from:31 to:232 protocol:4 rxTime:3634151681 <span class="o">(</span>3 bytes<span class="o">)]</span>
<span class="gp">mac &gt;</span><span class="o">&gt;</span> ReservationStatusNtf:INFORM[to:31 from:232 status:START]
<span class="gp">mac &gt;</span><span class="o">&gt;</span> ReservationStatusNtf:INFORM[to:31 from:232 status:END]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that a CTS is transmitted (<code>TxFrameStartNtf</code>), then a RTS is received from node B (<code>RxFrameStartNtf</code> and <code>RxFrameNtf</code>). The reservation starts as soon as the CTS is received, and it ends 3 seconds later. Exactly as we wanted!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_with_sensors">29. Integrating with sensors</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unetstack_shell_extensions">30. UnetStack shell extensions</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_part_vi_simulating_underwater_networks" class="sect0"><strong>Part VI: Simulating underwater networks</strong></h1>
<div class="sect1">
<h2 id="_integrated_development_environment_ide">31. Integrated development environment (IDE)</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_simulation_scripts">32. Writing simulation scripts</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modems_and_channel_models">33. Modems and channel models</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_developing_your_own_channel_models">34. Developing your own channel models</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_node_mobility">35. Node mobility</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Coming soon&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_appendices" class="sect0"><strong>Appendices</strong></h1>
<div class="sect1">
<h2 id="_mysimplehandshakemac">Appendix A: MySimpleHandshakeMac</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>MySimpleHandshakeMac.groovy</code> from <a href="#_simple_mac_with_handshake">Section 28.4</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="kn">import</span> <span class="nn">org.arl.fjage.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.phy.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.mac.*</span>
<span class="kn">import</span> <span class="nn">org.arl.unet.nodeinfo.*</span>

<span class="kd">class</span> <span class="nc">MySimpleHandshakeMac</span> <span class="kd">extends</span> <span class="n">UnetAgent</span> <span class="o">{</span>

  <span class="c1">////// protocol constants</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">PROTOCOL</span> <span class="o">=</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">MAC</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span>  <span class="n">RTS_BACKOFF</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span>  <span class="n">CTS_TIMEOUT</span>     <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span>  <span class="n">BACKOFF_RANDOM</span>  <span class="o">=</span> <span class="mi">5</span><span class="o">.</span><span class="na">seconds</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">float</span>  <span class="n">MAX_PROP_DELAY</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="na">seconds</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span>    <span class="n">MAX_RETRY</span>       <span class="o">=</span> <span class="mi">3</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span>    <span class="n">MAX_QUEUE_LEN</span>   <span class="o">=</span> <span class="mi">16</span>

  <span class="c1">////// reservation request queue</span>

  <span class="kd">private</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">ReservationReq</span><span class="o">&gt;(</span><span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>

  <span class="c1">////// PDU encoder/decoder</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">RTS_PDU</span> <span class="o">=</span> <span class="mh">0x01</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">CTS_PDU</span> <span class="o">=</span> <span class="mh">0x02</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">PDU</span> <span class="n">pdu</span> <span class="o">=</span> <span class="n">PDU</span><span class="o">.</span><span class="na">withFormat</span> <span class="o">{</span>
    <span class="n">uint8</span><span class="o">(</span><span class="s1">'type'</span><span class="o">)</span>         <span class="c1">// RTS_PDU/CTS_PDU</span>
    <span class="n">uint16</span><span class="o">(</span><span class="s1">'duration'</span><span class="o">)</span>    <span class="c1">// ms</span>
  <span class="o">}</span>

  <span class="c1">////// protocol FSM</span>

  <span class="kd">private</span> <span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
    <span class="n">IDLE</span><span class="o">,</span> <span class="n">RTS</span><span class="o">,</span> <span class="n">TX</span><span class="o">,</span> <span class="n">RX</span><span class="o">,</span> <span class="n">BACKOFF</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">enum</span> <span class="n">Event</span> <span class="o">{</span>
    <span class="n">RX_RTS</span><span class="o">,</span> <span class="n">RX_CTS</span><span class="o">,</span> <span class="n">SNOOP_RTS</span><span class="o">,</span> <span class="n">SNOOP_CTS</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="n">FSMBehavior</span> <span class="n">fsm</span> <span class="o">=</span> <span class="n">FSMBuilder</span><span class="o">.</span><span class="na">build</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">float</span> <span class="n">backoff</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">def</span> <span class="n">rxInfo</span>

    <span class="nf">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">action</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">after</span><span class="o">(</span><span class="n">rnd</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">BACKOFF_RANDOM</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">block</span><span class="o">()</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
        <span class="n">rxInfo</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RTS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">onEnter</span> <span class="o">{</span>
        <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">peek</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
          <span class="nl">type:</span> <span class="n">RTS_PDU</span><span class="o">,</span>
          <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
        <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
          <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
          <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
          <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
          <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
        <span class="n">after</span><span class="o">(</span><span class="n">CTS_TIMEOUT</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(++</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRY</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(),</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">FAILURE</span><span class="o">)</span>
            <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="o">}</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">TX</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">onEnter</span> <span class="o">{</span>
        <span class="n">ReservationReq</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">()</span>
        <span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">START</span><span class="o">)</span>
        <span class="n">after</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sendReservationStatusNtf</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span><span class="o">.</span><span class="na">END</span><span class="o">)</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">RX</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">onEnter</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span>
          <span class="nl">type:</span> <span class="n">CTS_PDU</span><span class="o">,</span>
          <span class="nl">duration:</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span><span class="o">*</span><span class="mi">1000</span><span class="o">))</span>
        <span class="n">phy</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">TxFrameReq</span><span class="o">(</span>
          <span class="nl">to:</span> <span class="n">rxInfo</span><span class="o">.</span><span class="na">from</span><span class="o">,</span>
          <span class="nl">type:</span> <span class="n">Physical</span><span class="o">.</span><span class="na">CONTROL</span><span class="o">,</span>
          <span class="nl">protocol:</span> <span class="n">PROTOCOL</span><span class="o">,</span>
          <span class="nl">data:</span> <span class="n">bytes</span><span class="o">)</span>
        <span class="n">after</span><span class="o">(</span><span class="n">rxInfo</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">rxInfo</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">state</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">BACKOFF</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">onEnter</span> <span class="o">{</span>
        <span class="n">after</span><span class="o">(</span><span class="n">backoff</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setNextState</span><span class="o">(</span><span class="n">State</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="n">RTS_BACKOFF</span>
        <span class="n">reenterState</span><span class="o">()</span>
      <span class="o">}</span>
      <span class="n">onEvent</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">)</span> <span class="o">{</span> <span class="n">info</span> <span class="o">-&gt;</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">duration</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_PROP_DELAY</span>
        <span class="n">reenterState</span><span class="o">()</span>
      <span class="o">}</span>
    <span class="o">}</span>

  <span class="o">}</span> <span class="c1">// of FSMBuilder</span>

  <span class="c1">////// agent startup sequence</span>

  <span class="kd">private</span> <span class="n">AgentID</span> <span class="n">phy</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">addr</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">register</span> <span class="n">Services</span><span class="o">.</span><span class="na">MAC</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">startup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">phy</span> <span class="o">=</span> <span class="n">agentForService</span> <span class="n">Services</span><span class="o">.</span><span class="na">PHYSICAL</span>
    <span class="n">subscribe</span><span class="o">(</span><span class="n">phy</span><span class="o">)</span>
    <span class="n">subscribe</span><span class="o">(</span><span class="n">topic</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">SNOOP</span><span class="o">))</span>
    <span class="n">add</span> <span class="k">new</span> <span class="nf">OneShotBehavior</span><span class="o">({</span>
      <span class="kt">def</span> <span class="n">nodeInfo</span> <span class="o">=</span> <span class="n">agentForService</span> <span class="n">Services</span><span class="o">.</span><span class="na">NODE_INFO</span>
      <span class="n">addr</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">nodeInfo</span><span class="o">,</span> <span class="n">NodeInfoParam</span><span class="o">.</span><span class="na">address</span><span class="o">)</span>
    <span class="o">})</span>
    <span class="n">add</span><span class="o">(</span><span class="n">fsm</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">////// process MAC service requests</span>

  <span class="nd">@Override</span>
  <span class="n">Message</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nl">ReservationReq:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">Address</span><span class="o">.</span><span class="na">BROADCAST</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span><span class="o">)</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Reservation must have a destination node'</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msg</span><span class="o">.</span><span class="na">duration</span> <span class="o">&gt;</span> <span class="n">maxReservationDuration</span><span class="o">)</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Bad reservation duration'</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">MAX_QUEUE_LEN</span><span class="o">)</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">Message</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">Performative</span><span class="o">.</span><span class="na">FAILURE</span><span class="o">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
        <span class="n">fsm</span><span class="o">.</span><span class="na">restart</span><span class="o">()</span>    <span class="c1">// tell fsm to check queue, as it may block if empty</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="k">case</span> <span class="nl">ReservationCancelReq:</span>
      <span class="k">case</span> <span class="nl">ReservationAcceptReq:</span>
      <span class="k">case</span> <span class="nl">TxAckReq:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RefuseRsp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s1">'Not supported'</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="o">}</span>

  <span class="c1">////// handle incoming MAC packets</span>

  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">processMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">RxFrameNtf</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">protocol</span> <span class="o">==</span> <span class="n">PROTOCOL</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">def</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">pdu</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">data</span><span class="o">)</span>
      <span class="kt">def</span> <span class="n">info</span> <span class="o">=</span> <span class="o">[</span><span class="nl">from:</span> <span class="n">msg</span><span class="o">.</span><span class="na">from</span><span class="o">,</span> <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span> <span class="nl">duration:</span> <span class="n">rx</span><span class="o">.</span><span class="na">duration</span><span class="o">/</span><span class="mf">1000.0</span><span class="o">]</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RTS_PDU</span><span class="o">)</span>
        <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_RTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_RTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">rx</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">CTS_PDU</span><span class="o">)</span>
        <span class="n">fsm</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">to</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">Event</span><span class="o">.</span><span class="na">RX_CTS</span> <span class="o">:</span> <span class="n">Event</span><span class="o">.</span><span class="na">SNOOP_CTS</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">////// expose parameters that are expected of a MAC service</span>

  <span class="kd">final</span> <span class="kt">int</span> <span class="n">reservationPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">// read-only parameters</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">ackPayloadSize</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">maxReservationDuration</span> <span class="o">=</span> <span class="mf">65.535</span>

  <span class="nd">@Override</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Parameter</span><span class="o">&gt;</span> <span class="n">getParameterList</span><span class="o">()</span> <span class="o">{</span>            <span class="c1">// publish list of all exposed parameters</span>
    <span class="k">return</span> <span class="nf">allOf</span><span class="o">(</span><span class="n">MacParam</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="kt">boolean</span> <span class="nf">getChannelBusy</span><span class="o">()</span> <span class="o">{</span>                      <span class="c1">// considered busy if fsm is not IDLE</span>
    <span class="k">return</span> <span class="n">fsm</span><span class="o">.</span><span class="na">currentState</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="na">IDLE</span>
  <span class="o">}</span>

  <span class="kt">float</span> <span class="nf">getRecommendedReservationDuration</span><span class="o">()</span> <span class="o">{</span>     <span class="c1">// recommended duration: one DATA packet</span>
    <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">phy</span><span class="o">,</span> <span class="n">Physical</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">PhysicalChannelParam</span><span class="o">.</span><span class="na">frameDuration</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">////// utility methods</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendReservationStatusNtf</span><span class="o">(</span><span class="n">ReservationReq</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ReservationStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">send</span> <span class="k">new</span> <span class="nf">ReservationStatusNtf</span><span class="o">(</span>
      <span class="nl">recipient:</span> <span class="n">msg</span><span class="o">.</span><span class="na">sender</span><span class="o">,</span>
      <span class="nl">inReplyTo:</span> <span class="n">msg</span><span class="o">.</span><span class="na">msgID</span><span class="o">,</span>
      <span class="nl">to:</span> <span class="n">msg</span><span class="o">.</span><span class="na">to</span><span class="o">,</span>
      <span class="nl">from:</span> <span class="n">addr</span><span class="o">,</span>
      <span class="nl">status:</span> <span class="n">status</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2019-09-16 01:33:45 +0800
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .cd {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>